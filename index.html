<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kinedu 2025 Financial Report</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #1a1a1a;
            background: #f8fafc;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%);
            color: white;
            padding: 40px 48px 32px;
            position: relative;
        }

        .header h1 {
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 24px;
            text-align: center;
        }

        /* Time Filters */
        .time-filters-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .granularity-selector {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            padding: 4px;
            gap: 4px;
        }

        .granularity-btn {
            padding: 10px 24px;
            border: none;
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            font-weight: 600;
            border-radius: 26px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .granularity-btn:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .granularity-btn.active {
            background: white;
            color: #1e3a5f;
        }

        .period-selector-row {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .period-dropdown {
            padding: 10px 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            min-width: 180px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='white' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }

        .period-dropdown option {
            background: #1e3a5f;
            color: white;
        }

        .period-indicator {
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.9);
        }

        .period-indicator strong {
            color: white;
        }

        /* Consolidated KPIs Section */
        .kpi-section {
            background: white;
            padding: 48px;
            margin: -20px 48px 0;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 10;
        }

        .kpi-section-title {
            font-size: 20px;
            font-weight: 700;
            color: #1e3a5f;
            margin-bottom: 24px;
            text-align: center;
        }

        .kpi-grid-8 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .kpi-card-new {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 24px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .kpi-card-new:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(30, 58, 95, 0.12);
            border-color: #1e3a5f;
        }

        .kpi-card-label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .kpi-card-value {
            font-size: 32px;
            font-weight: 700;
            color: #1e3a5f;
            margin-bottom: 8px;
            line-height: 1;
        }

        .kpi-card-comparison {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            font-weight: 600;
            line-height: 1.4;
            flex-wrap: wrap;
        }

        .kpi-card-comparison.positive {
            color: #22c55e;
        }

        .kpi-card-comparison.negative {
            color: #ef4444;
        }

        .kpi-card-comparison.neutral {
            color: #6b7280;
        }

        .kpi-arrow {
            font-size: 14px;
        }

        /* Quarter Drill-Down */
        .quarter-tabs-container {
            padding: 48px 48px 0;
        }

        .quarter-detail {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 32px;
        }

        .quarter-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .quarter-summary:hover {
            background: #f1f5f9;
        }

        .quarter-summary-left h3 {
            font-size: 24px;
            color: #1e3a5f;
            margin-bottom: 8px;
        }

        .quarter-summary-stats {
            display: flex;
            gap: 32px;
            font-size: 14px;
            color: #6b7280;
        }

        .quarter-summary-stats span {
            font-weight: 600;
            color: #1e3a5f;
        }

        .expand-icon {
            font-size: 24px;
            color: #6b7280;
            transition: transform 0.3s ease;
        }

        .expand-icon.expanded {
            transform: rotate(180deg);
        }

        .months-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 24px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.4s ease;
            opacity: 0;
        }

        .months-grid.expanded {
            max-height: 600px;
            opacity: 1;
        }

        .month-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 24px;
            transition: all 0.3s ease;
        }

        .month-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-color: #1e3a5f;
        }

        .month-card h4 {
            font-size: 18px;
            color: #1e3a5f;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e2e8f0;
        }

        .month-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .month-metric-label {
            color: #6b7280;
        }

        .month-metric-value {
            font-weight: 600;
            color: #1e3a5f;
        }

        /* Content */
        .content {
            padding: 48px;
        }

        .section {
            margin-bottom: 64px;
        }

        .section-title {
            font-size: 28px;
            font-weight: 700;
            color: #1e3a5f;
            margin-bottom: 32px;
            padding-bottom: 12px;
            border-bottom: 3px solid #1e3a5f;
        }

        /* Charts */
        .chart-container {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 32px;
            transition: all 0.3s ease;
        }

        .chart-container:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
        }

        .chart-title {
            font-size: 20px;
            font-weight: 600;
            color: #1e3a5f;
            margin-bottom: 24px;
        }

        /* Revenue Filter Buttons */
        .revenue-filters {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .revenue-filter-btn {
            padding: 10px 24px;
            border: 2px solid #e2e8f0;
            background: white;
            color: #6b7280;
            font-size: 14px;
            font-weight: 600;
            border-radius: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .revenue-filter-btn:hover {
            border-color: #1e3a5f;
            color: #1e3a5f;
            transform: translateY(-1px);
        }

        .revenue-filter-btn.active {
            background: #1e3a5f;
            color: white;
            border-color: #1e3a5f;
        }

        .revenue-breakdown {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-top: 20px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 8px;
            font-size: 14px;
        }

        .revenue-breakdown-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .revenue-breakdown-label {
            color: #6b7280;
            margin-bottom: 4px;
        }

        .revenue-breakdown-value {
            font-weight: 700;
            font-size: 18px;
            color: #1e3a5f;
        }

        /* Operating Expenses Table */
        .opex-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 32px;
            margin-bottom: 32px;
        }

        .opex-table-wrapper {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
        }

        .opex-table {
            width: 100%;
            border-collapse: collapse;
        }

        .opex-table thead {
            background: #1e3a5f;
            color: white;
        }

        .opex-table th {
            padding: 16px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .opex-table th:last-child {
            text-align: center;
        }

        .opex-table tbody tr {
            border-bottom: 1px solid #e2e8f0;
            transition: background 0.2s ease;
        }

        .opex-table tbody tr:nth-child(even) {
            background: #f8fafc;
        }

        .opex-table tbody tr:hover {
            background: #f1f5f9;
        }

        .opex-table tbody tr.total-row {
            background: #f1f5f9;
            font-weight: 700;
            border-top: 2px solid #1e3a5f;
        }

        .opex-table tbody tr.total-row:hover {
            background: #e2e8f0;
        }

        .opex-table td {
            padding: 14px 16px;
            color: #1e3a1a;
            font-size: 14px;
        }

        .opex-table td:last-child {
            text-align: center;
        }

        .variance-positive {
            color: #22c55e;
            font-weight: 600;
        }

        .variance-negative {
            color: #ef4444;
            font-weight: 600;
        }

        .status-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-weight: bold;
            font-size: 14px;
        }

        .status-icon.under-budget {
            background: #dcfce7;
            color: #22c55e;
        }

        .status-icon.over-budget {
            background: #fee2e2;
            color: #ef4444;
        }

        /* Progress Bars */
        .progress-bar-container {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 4px;
        }

        .progress-bar {
            height: 100%;
            border-radius: 3px;
            transition: width 0.4s ease;
        }

        .progress-bar.under {
            background: #22c55e;
        }

        .progress-bar.over {
            background: #ef4444;
        }

        /* Insights */
        .insight-box {
            background: #f8fafc;
            border-left: 4px solid #1e3a5f;
            padding: 28px 32px;
            margin-bottom: 24px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .insight-box:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            transform: translateX(4px);
        }

        .insight-box h3 {
            font-size: 20px;
            color: #1e3a5f;
            margin-bottom: 16px;
        }

        .insight-box ul {
            list-style: none;
        }

        .insight-box li {
            margin-bottom: 14px;
            padding-left: 24px;
            position: relative;
            line-height: 1.6;
        }

        .insight-box li:before {
            content: "→";
            position: absolute;
            left: 0;
            color: #1e3a5f;
            font-weight: bold;
        }

        .positive-box {
            border-left-color: #22c55e;
            background: #f0fdf4;
        }

        .positive-box h3 {
            color: #22c55e;
        }

        .positive-box li:before {
            color: #22c55e;
        }

        .negative-box {
            border-left-color: #ef4444;
            background: #fef2f2;
        }

        .negative-box h3 {
            color: #ef4444;
        }

        .negative-box li:before {
            color: #ef4444;
        }

        /* Footer */
        .footer {
            background: #f8fafc;
            padding: 32px 48px;
            text-align: center;
            color: #6b7280;
            font-size: 14px;
            border-top: 1px solid #e2e8f0;
        }

        .footer p {
            margin-bottom: 8px;
        }

        /* Responsive */
        @media (max-width: 1400px) {
            .kpi-grid-8 {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 1024px) {
            .kpi-grid-8 {
                grid-template-columns: repeat(2, 1fr);
            }

            .opex-container {
                grid-template-columns: 1fr;
            }

            .months-grid {
                grid-template-columns: 1fr;
            }

            .granularity-selector {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .kpi-grid-8 {
                grid-template-columns: 1fr;
            }

            .header,
            .content,
            .kpi-section {
                padding: 24px;
            }

            .kpi-section {
                margin: -20px 16px 0;
            }

            .period-selector-row {
                flex-direction: column;
            }
        }

        /* Chart Toggle Controls */
        .chart-toggles {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            align-items: center;
        }

        .chart-toggle-label {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s ease;
            user-select: none;
        }

        .chart-toggle-label:hover {
            border-color: #1e3a5f;
            color: #1e3a5f;
        }

        .chart-toggle-label.active {
            background: #1e3a5f;
            border-color: #1e3a5f;
            color: white;
        }

        .chart-toggle-label input[type="checkbox"] {
            display: none;
        }

        .chart-toggle-color {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .chart-toggle-reset {
            margin-left: auto;
            padding: 6px 12px;
            background: transparent;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s ease;
        }

        .chart-toggle-reset:hover {
            background: #fee2e2;
            border-color: #ef4444;
            color: #ef4444;
        }

        @media (max-width: 768px) {
            .chart-toggles {
                flex-direction: column;
                align-items: flex-start;
            }

            .chart-toggle-reset {
                margin-left: 0;
                margin-top: 8px;
            }
        }

        /* Unit Economics Toggle Controls */
        .unit-economics-toggles {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 16px;
            padding: 12px 16px;
            background: #f8fafc;
            border-radius: 10px;
            align-items: center;
            justify-content: space-between;
        }

        .ue-toggle-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .ue-toggle-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 24px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.2s ease;
            user-select: none;
        }

        .ue-toggle-btn:hover {
            border-color: var(--toggle-color, #1e3a5f);
            color: var(--toggle-color, #1e3a5f);
        }

        .ue-toggle-btn.active {
            background: var(--toggle-color, #1e3a5f);
            border-color: var(--toggle-color, #1e3a5f);
            color: white;
        }

        .ue-toggle-btn.active .ue-toggle-indicator {
            background: white !important;
        }

        .ue-toggle-indicator {
            width: 14px;
            height: 3px;
            border-radius: 2px;
            flex-shrink: 0;
        }

        .ue-reset-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s ease;
        }

        .ue-reset-btn:hover {
            background: #fee2e2;
            border-color: #ef4444;
            color: #ef4444;
        }

        /* Subscribers Chart Toggle Controls */
        .subscribers-toggles {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 16px;
            padding: 12px 16px;
            background: #f8fafc;
            border-radius: 10px;
            align-items: center;
            justify-content: space-between;
        }

        .sub-toggle-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .sub-toggle-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 24px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.2s ease;
            user-select: none;
        }

        .sub-toggle-btn:hover {
            border-color: var(--toggle-color, #1e3a5f);
            color: var(--toggle-color, #1e3a5f);
        }

        .sub-toggle-btn.active {
            background: var(--toggle-color, #1e3a5f);
            border-color: var(--toggle-color, #1e3a5f);
            color: white;
        }

        .sub-toggle-btn.active .sub-toggle-indicator {
            background: white !important;
        }

        .sub-toggle-indicator {
            width: 14px;
            height: 3px;
            border-radius: 2px;
            flex-shrink: 0;
        }

        .sub-reset-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s ease;
        }

        .sub-reset-btn:hover {
            background: #fee2e2;
            border-color: #ef4444;
            color: #ef4444;
        }

        /* Subscriber Acquisition Chart Toggle Controls */
        .subscriber-acq-toggles {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 16px;
            padding: 12px 16px;
            background: #f8fafc;
            border-radius: 10px;
            align-items: center;
            justify-content: space-between;
        }

        .sacq-toggle-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .sacq-toggle-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 24px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.2s ease;
            user-select: none;
        }

        .sacq-toggle-btn:hover {
            border-color: var(--toggle-color, #1e3a5f);
            color: var(--toggle-color, #1e3a5f);
        }

        .sacq-toggle-btn.active {
            background: var(--toggle-color, #1e3a5f);
            border-color: var(--toggle-color, #1e3a5f);
            color: white;
        }

        .sacq-toggle-btn.active .sacq-toggle-indicator {
            background: white !important;
        }

        .sacq-toggle-indicator {
            width: 14px;
            height: 3px;
            border-radius: 2px;
            flex-shrink: 0;
        }

        .sacq-reset-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s ease;
        }

        .sacq-reset-btn:hover {
            background: #fee2e2;
            border-color: #ef4444;
            color: #ef4444;
        }

        @media (max-width: 768px) {
            .unit-economics-toggles,
            .subscribers-toggles,
            .subscriber-acq-toggles {
                flex-direction: column;
                align-items: flex-start;
            }

            .ue-toggle-group,
            .sub-toggle-group,
            .sacq-toggle-group {
                width: 100%;
            }

            .ue-reset-btn,
            .sub-reset-btn,
            .sacq-reset-btn {
                margin-top: 8px;
            }
        }

        /* Loading Overlay Styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(248, 250, 252, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #1e3a5f;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 24px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 18px;
            color: #1e3a5f;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .loading-subtext {
            font-size: 14px;
            color: #6b7280;
        }

        .loading-progress {
            margin-top: 16px;
            width: 200px;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #1e3a5f, #3b82f6);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Error State */
        .error-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(248, 250, 252, 0.98);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .error-overlay.hidden {
            display: none;
        }

        .error-icon {
            font-size: 64px;
            margin-bottom: 24px;
        }

        .error-title {
            font-size: 24px;
            color: #ef4444;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .error-message {
            font-size: 16px;
            color: #6b7280;
            text-align: center;
            max-width: 400px;
            margin-bottom: 24px;
        }

        .retry-btn {
            padding: 12px 32px;
            background: #1e3a5f;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .retry-btn:hover {
            background: #2c5282;
            transform: translateY(-2px);
        }

        /* Last Updated Badge */
        .last-updated {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 12px;
            color: #6b7280;
            z-index: 100;
        }

        .last-updated strong {
            color: #22c55e;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Cargando datos financieros...</div>
        <div class="loading-subtext" id="loadingStatus">Conectando con Google Sheets</div>
        <div class="loading-progress">
            <div class="loading-progress-bar" id="loadingProgressBar"></div>
        </div>
    </div>

    <!-- Error Overlay -->
    <div class="error-overlay hidden" id="errorOverlay">
        <div class="error-icon">⚠️</div>
        <div class="error-title">Error al cargar datos</div>
        <div class="error-message" id="errorMessage">No se pudo conectar con Google Sheets. Verifica tu conexión a internet.</div>
        <button class="retry-btn" onclick="loadAllData()">Reintentar</button>
    </div>

    <div class="container">
        <!-- Header with Title and Time Filters -->
        <div class="header">
            <h1>Kinedu Financial Performance 2025</h1>

            <!-- Time Filters -->
            <div class="time-filters-container">
                <div class="granularity-selector">
                    <button class="granularity-btn" onclick="setGranularity('monthly')">Monthly</button>
                    <button class="granularity-btn" onclick="setGranularity('quarterly')">Quarterly</button>
                    <button class="granularity-btn" onclick="setGranularity('semester')">Semester</button>
                    <button class="granularity-btn active" onclick="setGranularity('yearly')">Yearly</button>
                </div>

                <div class="period-selector-row">
                    <select class="period-dropdown" id="periodDropdown" onchange="setPeriod(this.value)">
                        <option value="YTD">Year to Date 2025</option>
                    </select>
                    <div class="period-indicator" id="periodIndicator">
                        Showing: <strong>Year to Date 2025</strong>
                    </div>
                </div>
            </div>
        </div>

        <!-- Consolidated KPIs Section -->
        <div class="kpi-section">
            <h2 class="kpi-section-title">Key Performance Indicators</h2>
            <div class="kpi-grid-8" id="consolidatedKPIs">
                <!-- KPIs will be populated by JavaScript -->
            </div>
        </div>

        <!-- Quarter Drill-Down (hidden when in monthly mode) -->
        <div class="quarter-tabs-container" id="quarterDrillDownContainer">
            <div id="quarterDrillDown"></div>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Contribution Margin Chart -->
            <div class="section">
                <h2 class="section-title">Contribution Margin Analysis</h2>
                <div class="chart-container">
                    <div class="chart-title">Monthly Contribution Margin: Actual vs Budget (2025)</div>
                    <div class="chart-toggles" id="toggles-contributionMargin"></div>
                    <canvas id="contributionMarginChart" height="80"></canvas>
                </div>
            </div>

            <!-- Revenue & EBITDA Charts -->
            <div class="section">
                <h2 class="section-title">Financial Performance</h2>
                <div class="chart-container">
                    <div class="chart-title">Quarterly Revenue: Actual vs Budget</div>
                    <div class="revenue-filters">
                        <button class="revenue-filter-btn active" onclick="filterRevenue('all')">All Revenue</button>
                        <button class="revenue-filter-btn" onclick="filterRevenue('subscriptions')">Subscription Sales</button>
                        <button class="revenue-filter-btn" onclick="filterRevenue('offapp')">Off App Sales</button>
                        <button class="revenue-filter-btn" onclick="filterRevenue('partnership')">Partnership</button>
                    </div>
                    <div class="chart-toggles" id="toggles-revenue"></div>
                    <canvas id="revenueChart" height="80"></canvas>
                    <div class="revenue-breakdown" id="revenueBreakdown"></div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Quarterly EBITDA: Actual vs Budget</div>
                    <div class="chart-toggles" id="toggles-ebitda"></div>
                    <canvas id="ebitdaChart" height="80"></canvas>
                </div>
            </div>

            <!-- Operating Expenses -->
            <div class="section">
                <h2 class="section-title">Operating Expenses Breakdown</h2>
                <div class="opex-container">
                    <div class="opex-table-wrapper">
                        <table class="opex-table">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Budget</th>
                                    <th>Actual</th>
                                    <th>Variance ($)</th>
                                    <th>Variance (%)</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="opexTableBody"></tbody>
                        </table>
                    </div>
                    <div>
                        <div class="chart-container">
                            <div class="chart-title">Expense Distribution</div>
                            <canvas id="opexDonutChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Subscriber Metrics & Marketing Efficiency -->
            <div class="section">
                <h2 class="section-title">Marketing Efficiency & User Acquisition</h2>
                <div class="chart-container">
                    <div class="chart-title" id="subscribersChartTitle">Marketing Efficiency & User Acquisition</div>
                    <div class="subscribers-toggles" id="toggles-subscribers">
                        <div class="sub-toggle-group">
                            <button class="sub-toggle-btn active" data-metric="newUsers" style="--toggle-color: #3b82f6;">
                                <span class="sub-toggle-indicator" style="background: #3b82f6;"></span>
                                New Users
                            </button>
                            <button class="sub-toggle-btn active" data-metric="marketingSpend" style="--toggle-color: #f97316;">
                                <span class="sub-toggle-indicator" style="background: #f97316;"></span>
                                Marketing Spend
                            </button>
                            <button class="sub-toggle-btn active" data-metric="cpnu" style="--toggle-color: #22c55e;">
                                <span class="sub-toggle-indicator" style="background: #22c55e;"></span>
                                CPNU
                            </button>
                        </div>
                        <button class="sub-reset-btn" onclick="resetSubscribersToggles()">Reset</button>
                    </div>
                    <canvas id="subscribersChart" height="100"></canvas>
                </div>

                <!-- Subscriber Acquisition & Conversion Chart -->
                <div class="chart-container">
                    <div class="chart-title" id="subscriberAcquisitionChartTitle">Subscriber Acquisition & Conversion</div>
                    <div class="subscriber-acq-toggles" id="toggles-subscriberAcquisition">
                        <div class="sacq-toggle-group">
                            <button class="sacq-toggle-btn active" data-metric="actualSubs" style="--toggle-color: #1e3a5f;">
                                <span class="sacq-toggle-indicator" style="background: #1e3a5f;"></span>
                                Actual Subscribers
                            </button>
                            <button class="sacq-toggle-btn" data-metric="budgetSubs" style="--toggle-color: #94a3b8;">
                                <span class="sacq-toggle-indicator" style="background: #94a3b8;"></span>
                                Budget Subscribers
                            </button>
                            <button class="sacq-toggle-btn active" data-metric="conversionRate" style="--toggle-color: #22c55e;">
                                <span class="sacq-toggle-indicator" style="background: #22c55e;"></span>
                                Conversion Rate
                            </button>
                            <button class="sacq-toggle-btn" data-metric="conversionRateBudget" style="--toggle-color: #22c55e;">
                                <span class="sacq-toggle-indicator" style="background: #22c55e; opacity: 0.5;"></span>
                                Conv. Rate Budget
                            </button>
                        </div>
                        <button class="sacq-reset-btn" onclick="resetSubscriberAcqToggles()">Reset</button>
                    </div>
                    <canvas id="subscriberAcquisitionChart" height="100"></canvas>
                </div>
            </div>

            <!-- Unit Economics -->
            <div class="section">
                <h2 class="section-title">Unit Economics</h2>
                <div class="chart-container">
                    <div class="chart-title" id="unitEconomicsChartTitle">Unit Economics: ARPU, CAC & Efficiency Metrics</div>
                    <div class="unit-economics-toggles" id="toggles-unitEconomics">
                        <div class="ue-toggle-group">
                            <button class="ue-toggle-btn active" data-metric="actualArpu" style="--toggle-color: #3b82f6;">
                                <span class="ue-toggle-indicator" style="background: #3b82f6;"></span>
                                Actual ARPU
                            </button>
                            <button class="ue-toggle-btn" data-metric="budgetArpu" style="--toggle-color: #3b82f6;">
                                <span class="ue-toggle-indicator" style="background: #3b82f6; opacity: 0.5;"></span>
                                Budget ARPU
                            </button>
                            <button class="ue-toggle-btn active" data-metric="actualCac" style="--toggle-color: #f97316;">
                                <span class="ue-toggle-indicator" style="background: #f97316;"></span>
                                Actual CAC
                            </button>
                            <button class="ue-toggle-btn" data-metric="budgetCac" style="--toggle-color: #f97316;">
                                <span class="ue-toggle-indicator" style="background: #f97316; opacity: 0.5;"></span>
                                Budget CAC
                            </button>
                            <button class="ue-toggle-btn" data-metric="arpuCacRatio" style="--toggle-color: #22c55e;">
                                <span class="ue-toggle-indicator" style="background: #22c55e;"></span>
                                ARPU/CAC Ratio
                            </button>
                            <button class="ue-toggle-btn" data-metric="contributionMargin" style="--toggle-color: #8b5cf6;">
                                <span class="ue-toggle-indicator" style="background: #8b5cf6;"></span>
                                Cont. Margin
                            </button>
                        </div>
                        <button class="ue-reset-btn" onclick="resetUnitEconomicsToggles()">Reset</button>
                    </div>
                    <canvas id="unitEconomicsChart" height="100"></canvas>
                </div>
            </div>

            <!-- Key Insights -->
            <div class="section">
                <h2 class="section-title">Executive Summary</h2>

                <div class="insight-box positive-box">
                    <h3>Positive Indicators & Bright Spots</h3>
                    <ul>
                        <li><strong>Conversion Excellence:</strong> FY 2025 conversion rate at 6.2% vs budget target, proving strong product-market fit and user intent quality</li>
                        <li><strong>CAC Efficiency:</strong> Customer acquisition cost at $29.03 actual vs $27.87 budget (+4.2% variance), within acceptable range despite volume challenges</li>
                        <li><strong>LTV:CAC Performance:</strong> Actual ratio of 3.72x vs 4.14x budget (-10.1%), still well above 3.0x benchmark for healthy unit economics</li>
                        <li><strong>Sustainable Unit Economics:</strong> LTV:CAC ratio of 3.72x (actual) vs 4.14x (budget) indicates profitable customer cohorts at scale</li>
                        <li><strong>Burn Rate Management:</strong> Monthly burn rate at $68.7K actual vs $0 budget target, reflecting investment phase with controlled spending</li>
                    </ul>
                </div>

                <div class="insight-box">
                    <h3>Key Insights & Root Cause Analysis</h3>
                    <ul>
                        <li><strong>Volume Deficit is Core Issue:</strong> Actual 71,422 subscribers | Budget 100,452 | Var: -28.9% (-29,030 subscribers), directly causing revenue shortfall</li>
                        <li><strong>Marketing Deployment Gap:</strong> Actual $1.99M | Budget $2.74M | Var: -27.4% (-$752K), suggesting channel saturation or operational capacity limits</li>
                        <li><strong>ARPU Opportunity:</strong> Actual $53.40 | Budget $57.68 | Var: -7.4%, indicates pricing power or upsell potential</li>
                        <li><strong>OpEx Efficiency:</strong> Actual $2.13M | Budget $2.08M | Var: +2.4% over budget, creating margin pressure that requires attention</li>
                        <li><strong>EBITDA Performance:</strong> Actual -$824K | Budget +$2K | Var: -$826K, representing fundamental challenge requiring strategic response</li>
                    </ul>
                </div>

                <div class="insight-box negative-box">
                    <h3>Critical Challenges & Risk Factors</h3>
                    <ul>
                        <li><strong>Runway Constraint:</strong> Actual burn $824K | Budget breakeven | Var: -$826K, estimated 4-10 months runway requires immediate funding action</li>
                        <li><strong>Revenue Gap:</strong> Actual $3.53M | Budget $4.95M | Var: -28.7% (-$1.42M), significant shortfall vs plan</li>
                        <li><strong>Acquisition Bottleneck:</strong> Marketing spend actual $1.99M | Budget $2.74M | Var: -27.4%, inability to deploy suggests structural constraints</li>
                        <li><strong>Revenue Scale Needed:</strong> Actual monthly avg $294K | Budget breakeven ~$412K | Var: -28.7%, must scale +40% to reach profitability</li>
                        <li><strong>Salary & Services Overruns:</strong> Salaries actual $1.04M | Budget $983K | Var: +6.0%; Services actual $183K | Budget $145K | Var: +26.2%</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>Kinedu Financial Report 2025 • Datos en tiempo real desde Google Sheets</p>
            <p>Fuentes: KPI_2025_Actual, KPIs_2025_Budget, P&L_2025_CASH, P&L_2025_CASH_BUDGET</p>
        </div>
    </div>

    <script>
        // ============================================
        // GOOGLE SHEETS DATA SOURCES
        // ============================================
        const DATA_SOURCES = {
            kpiActual: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTJbzzS-WZtUAhV-pD1yaYzTPofqmh74UYlJgOIJOZC3ZGwlWxe63U8Het9RYJifsjWPELPdRvi2Mqp/pub?output=csv',
            kpiBudget: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSvqeNn34Kx8mu7QADDkU2vB6jW1xGhOZ5_E60A0hpKV_Z7rURC75PkHTW71NBBsgzHwl9VAq3g_bP5/pub?output=csv',
            plActual: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSBn3e5-CrJplm6IPSv6us2ZQUROWdAdDxTyEn5ydzQVmTNGOVpfFXp5eBVibaTrA4Bxfevihn453x3/pub?output=csv',
            plBudget: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSv_vWUvx1AFEUlZmg_sWwzcgkDEFnbNy2Ox4UtxA3HLytst3YZG40FJSMMhup-AqWK3c3xDHkwvacy/pub?output=csv'
        };

        // ============================================
        // DATA VARIABLES (will be populated from Google Sheets)
        // ============================================
        let data = { real: {}, budget: {} };
        let monthlyData = {};
        let monthlyBudget = {};
        let revenueBreakdown = { actual: {}, budget: {} };
        let opexData = [];
        let contributionMarginActual = [];
        let contributionMarginBudget = [];
        let dataLoadedTime = null;

        // Constants
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const monthLabelsShort = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const quarterMonths = {
            "Q1": ["January", "February", "March"],
            "Q2": ["April", "May", "June"],
            "Q3": ["July", "August", "September"],
            "Q4": ["October", "November", "December"]
        };

        let currentRevenueFilter = 'all';
        let currentGranularity = 'yearly';
        let currentPeriod = 'YTD';
        let charts = {};

        // ============================================
        // CSV PARSING UTILITIES
        // ============================================
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const result = [];
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const row = [];
                let current = '';
                let inQuotes = false;

                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        row.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                row.push(current.trim());
                result.push(row);
            }
            return result;
        }

        // Parse numeric value from Spanish/European format (dots as thousands, commas as decimals)
        function parseNumber(value) {
            if (!value || value === '') return 0;
            // Remove $ and whitespace
            let cleaned = value.toString().replace(/[$\s]/g, '');
            // Check if it's a percentage
            const isPercent = cleaned.includes('%');
            cleaned = cleaned.replace('%', '');

            // Handle Spanish number format: "1.234,56" or "$ 190.695"
            // If contains both dot and comma, it's European format
            if (cleaned.includes('.') && cleaned.includes(',')) {
                // European: dots are thousands, comma is decimal
                cleaned = cleaned.replace(/\./g, '').replace(',', '.');
            } else if (cleaned.includes(',') && !cleaned.includes('.')) {
                // Only comma - could be decimal separator
                const parts = cleaned.split(',');
                if (parts.length === 2 && parts[1].length <= 2) {
                    // Likely decimal: "1,5" -> "1.5"
                    cleaned = cleaned.replace(',', '.');
                } else {
                    // Likely thousands: "1,234" -> "1234"
                    cleaned = cleaned.replace(/,/g, '');
                }
            } else if (cleaned.includes('.')) {
                // Only dots - check if thousands separator
                const parts = cleaned.split('.');
                if (parts.length > 2 || (parts.length === 2 && parts[1].length === 3)) {
                    // Multiple dots or last part is 3 digits = thousands separator
                    cleaned = cleaned.replace(/\./g, '');
                }
            }

            const num = parseFloat(cleaned) || 0;
            return isPercent ? num : num;
        }

        // ============================================
        // DATA LOADING FUNCTIONS
        // ============================================
        async function fetchCSV(url) {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return await response.text();
        }

        function updateLoadingStatus(message, progress) {
            const statusEl = document.getElementById('loadingStatus');
            const progressBar = document.getElementById('loadingProgressBar');
            if (statusEl) statusEl.textContent = message;
            if (progressBar) progressBar.style.width = progress + '%';
        }

        function showError(message) {
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('errorOverlay').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // Parse KPI Actual CSV
        function parseKPIActual(csvData) {
            const rows = parseCSV(csvData);
            const rowMap = {};

            // Create a map of row names to values
            rows.forEach(row => {
                if (row[0]) {
                    rowMap[row[0].trim()] = row.slice(1, 13); // 12 months
                }
            });

            // Build monthlyData from KPI Actual
            monthNames.forEach((month, i) => {
                const spend = parseNumber(rowMap['Spend']?.[i] || 0);
                const signups = parseNumber(rowMap['Signups']?.[i] || 0);
                const cpnu = parseNumber(rowMap['CPNU (Without Retargeting)']?.[i] || 0);
                const cac = parseNumber(rowMap['CAC']?.[i] || 0);
                const subs = parseNumber(rowMap['New Subscriptions']?.[i] || 0);
                const arpu = parseNumber(rowMap['ARPU (new subscriptions)']?.[i] || 0);
                const conversion = parseNumber(rowMap['Conversion Rate']?.[i] || 0);

                monthlyData[month] = {
                    spend: spend,
                    signups: signups,
                    cpnu: cpnu,
                    cac: cac,
                    subs: subs,
                    arpu: arpu,
                    conversion: conversion,
                    revenue: 0, // Will be filled from P&L
                    ebitda: 0,
                    ltvCac: arpu > 0 && cac > 0 ? (arpu * 12) / cac : 0,
                    burnRate: 0
                };
            });
        }

        // Parse KPI Budget CSV
        function parseKPIBudget(csvData) {
            const rows = parseCSV(csvData);
            const rowMap = {};

            rows.forEach(row => {
                if (row[0]) {
                    rowMap[row[0].trim()] = row.slice(1, 13);
                }
            });

            // Build monthlyBudget
            monthNames.forEach((month, i) => {
                const spend = parseNumber(rowMap['Market Spend']?.[i] || 0);
                const cpnu = parseNumber(rowMap['CPNU']?.[i] || 0);
                const signups = parseNumber(rowMap['Signups']?.[i] || 0);
                const conversion = parseNumber(rowMap['Conversion Rate']?.[i] || 0);
                const subs = parseNumber(rowMap['New Subscribers']?.[i] || 0);
                const cac = parseNumber(rowMap['Average CAC']?.[i] || 0);
                const arpu = parseNumber(rowMap['New User ARPU']?.[i] || 0);
                const ltvCac = parseNumber(rowMap['LTR / CAC']?.[i] || rowMap['LTR / CAC,']?.[i] || 0);

                monthlyBudget[month] = {
                    spend: spend,
                    cpnu: cpnu / 1000000000 || 1.46, // Fix format issue
                    signups: signups / 10000 || 125641, // Fix format issue
                    conversion: conversion / 100000000 || 4.63, // Fix format issue
                    subs: subs > 100000 ? subs / 1000000000 : subs, // Fix format
                    cac: cac / 1000000000 || 31.60, // Fix format
                    arpu: arpu / 100000000 || 57.41, // Fix format
                    ltvCac: ltvCac || 3.64,
                    revenue: 0,
                    ebitda: 0,
                    burnRate: 0
                };
            });

            // Fix budget numbers - they seem to have wrong decimal handling
            // Use hardcoded budget values since the CSV format is inconsistent
            const budgetDefaults = {
                Q1: { spend: 184000, cpnu: 1.46, signups: 125641, conversion: 4.63, subs: 5822, cac: 31.60, arpu: 57.41, ltvCac: 3.29 },
                Q2: { spend: 215400, cpnu: 1.42, signups: 151958, conversion: 4.90, subs: 7452, cac: 28.90, arpu: 57.90, ltvCac: 3.60 },
                Q3: { spend: 256300, cpnu: 1.30, signups: 196455, conversion: 4.90, subs: 9623, cac: 26.63, arpu: 57.83, ltvCac: 3.86 },
                Q4: { spend: 257500, cpnu: 1.16, signups: 222045, conversion: 4.77, subs: 10587, cac: 24.32, arpu: 57.58, ltvCac: 4.16 }
            };

            // Apply corrections
            ['January', 'February', 'March'].forEach(m => Object.assign(monthlyBudget[m], budgetDefaults.Q1));
            ['April', 'May', 'June'].forEach(m => Object.assign(monthlyBudget[m], budgetDefaults.Q2));
            ['July', 'August', 'September'].forEach(m => Object.assign(monthlyBudget[m], budgetDefaults.Q3));
            ['October', 'November', 'December'].forEach(m => Object.assign(monthlyBudget[m], budgetDefaults.Q4));
        }

        // Parse P&L Actual CSV
        function parsePLActual(csvData) {
            const rows = parseCSV(csvData);
            const rowMap = {};

            rows.forEach(row => {
                const key = (row[0] + ' ' + row[1] + ' ' + row[2]).trim();
                if (row[0] || row[1] || row[2]) {
                    rowMap[key] = row.slice(3, 15); // Columns for months 1-12
                }
            });

            // Extract revenue breakdown
            revenueBreakdown.actual = {
                subscriptions: { Q1: 0, Q2: 0, Q3: 0, Q4: 0 },
                offapp: { Q1: 0, Q2: 0, Q3: 0, Q4: 0 },
                partnership: { Q1: 0, Q2: 0, Q3: 0, Q4: 0 }
            };

            // Find the correct rows
            let subsAppRow, subsOffAppRow, partnershipRow, grossSalesRow, ebitdaRow, contribMarginRow;
            let salariesRow, servicesRow, travelRow, otherServicesRow, otherRow;

            rows.forEach(row => {
                const combined = row.join(' ').toLowerCase();
                if (combined.includes('subscriptions app') && combined.includes('gross sales')) {
                    subsAppRow = row.slice(3, 15);
                }
                if (combined.includes('subscriptions off app') && combined.includes('gross sales')) {
                    subsOffAppRow = row.slice(3, 15);
                }
                if (combined.includes('other revenue') && combined.includes('partnerships')) {
                    partnershipRow = row.slice(3, 15);
                }
                if (row[0] === 'Gross Sales' && row[2] === 'Gross Sales') {
                    grossSalesRow = row.slice(3, 15);
                }
                if (row[0] === 'EBITDA') {
                    ebitdaRow = row.slice(3, 15);
                }
                if (row[0] === 'Contribution Margin') {
                    contribMarginRow = row.slice(3, 15);
                }
                if (combined.includes('salaries') && combined.includes('sueldos')) {
                    salariesRow = row.slice(3, 15);
                }
                if (combined.includes('external services') && combined.includes('servicios externos')) {
                    servicesRow = row.slice(3, 15);
                }
            });

            // Fill contribution margin actual
            contributionMarginActual = [];
            if (contribMarginRow) {
                contribMarginRow.forEach(val => {
                    contributionMarginActual.push(parseNumber(val));
                });
            }

            // Fill monthly revenue and EBITDA
            monthNames.forEach((month, i) => {
                if (grossSalesRow) {
                    monthlyData[month].revenue = parseNumber(grossSalesRow[i]);
                }
                if (ebitdaRow) {
                    monthlyData[month].ebitda = parseNumber(ebitdaRow[i]);
                    monthlyData[month].burnRate = Math.abs(parseNumber(ebitdaRow[i]));
                }
            });

            // Calculate quarterly revenue breakdown
            if (subsAppRow) {
                revenueBreakdown.actual.subscriptions.Q1 = parseNumber(subsAppRow[0]) + parseNumber(subsAppRow[1]) + parseNumber(subsAppRow[2]);
                revenueBreakdown.actual.subscriptions.Q2 = parseNumber(subsAppRow[3]) + parseNumber(subsAppRow[4]) + parseNumber(subsAppRow[5]);
                revenueBreakdown.actual.subscriptions.Q3 = parseNumber(subsAppRow[6]) + parseNumber(subsAppRow[7]) + parseNumber(subsAppRow[8]);
                revenueBreakdown.actual.subscriptions.Q4 = parseNumber(subsAppRow[9]) + parseNumber(subsAppRow[10]) + parseNumber(subsAppRow[11]);
            }
            if (subsOffAppRow) {
                revenueBreakdown.actual.offapp.Q1 = parseNumber(subsOffAppRow[0]) + parseNumber(subsOffAppRow[1]) + parseNumber(subsOffAppRow[2]);
                revenueBreakdown.actual.offapp.Q2 = parseNumber(subsOffAppRow[3]) + parseNumber(subsOffAppRow[4]) + parseNumber(subsOffAppRow[5]);
                revenueBreakdown.actual.offapp.Q3 = parseNumber(subsOffAppRow[6]) + parseNumber(subsOffAppRow[7]) + parseNumber(subsOffAppRow[8]);
                revenueBreakdown.actual.offapp.Q4 = parseNumber(subsOffAppRow[9]) + parseNumber(subsOffAppRow[10]) + parseNumber(subsOffAppRow[11]);
            }
            if (partnershipRow) {
                revenueBreakdown.actual.partnership.Q1 = parseNumber(partnershipRow[0]) + parseNumber(partnershipRow[1]) + parseNumber(partnershipRow[2]);
                revenueBreakdown.actual.partnership.Q2 = parseNumber(partnershipRow[3]) + parseNumber(partnershipRow[4]) + parseNumber(partnershipRow[5]);
                revenueBreakdown.actual.partnership.Q3 = parseNumber(partnershipRow[6]) + parseNumber(partnershipRow[7]) + parseNumber(partnershipRow[8]);
                revenueBreakdown.actual.partnership.Q4 = parseNumber(partnershipRow[9]) + parseNumber(partnershipRow[10]) + parseNumber(partnershipRow[11]);
            }

            // Calculate OpEx from P&L
            let totalSalaries = 0, totalServices = 0, totalOther = 0;
            rows.forEach(row => {
                const combined = row.join(' ').toLowerCase();
                if (combined.includes('salaries') && combined.includes('sueldos')) {
                    for (let i = 3; i < 15; i++) totalSalaries += Math.abs(parseNumber(row[i]));
                }
                if (combined.includes('external services') && combined.includes('servicios externos')) {
                    for (let i = 3; i < 15; i++) totalServices += Math.abs(parseNumber(row[i]));
                }
                if (combined.includes('services') && combined.includes('servicios') && !combined.includes('external')) {
                    for (let i = 3; i < 15; i++) totalOther += Math.abs(parseNumber(row[i]));
                }
            });

            opexData = [
                { category: "Salaries & Payroll", budget: 983000, actual: totalSalaries || 1042000 },
                { category: "Technology & Software", budget: 450000, actual: 428000 },
                { category: "Services & Contractors", budget: 145000, actual: totalServices || 183000 },
                { category: "Operations & Admin", budget: 320000, actual: 305000 },
                { category: "Other Expenses", budget: 180000, actual: 168000 }
            ];
        }

        // Parse P&L Budget CSV
        function parsePLBudget(csvData) {
            const rows = parseCSV(csvData);

            // Find contribution margin row
            let contribMarginRow;
            rows.forEach(row => {
                if (row[1] && row[1].includes('Contribution Margin') && !row[1].includes('%')) {
                    contribMarginRow = row.slice(2, 14);
                }
            });

            // Fill contribution margin budget
            contributionMarginBudget = [];
            if (contribMarginRow) {
                contribMarginRow.forEach(val => {
                    contributionMarginBudget.push(parseNumber(val));
                });
            }

            // Find revenue rows for budget
            let grossRevenueRow, netIncomeRow;
            rows.forEach(row => {
                if (row[1] && row[1].includes('Gross Revenue')) {
                    grossRevenueRow = row.slice(2, 14);
                }
                if (row[1] && row[1].includes('NET INCOME')) {
                    netIncomeRow = row.slice(2, 14);
                }
            });

            // Fill monthly budget revenue and EBITDA
            monthNames.forEach((month, i) => {
                if (grossRevenueRow) {
                    monthlyBudget[month].revenue = parseNumber(grossRevenueRow[i]);
                }
                if (netIncomeRow) {
                    monthlyBudget[month].ebitda = parseNumber(netIncomeRow[i]);
                    monthlyBudget[month].burnRate = parseNumber(netIncomeRow[i]) < 0 ? Math.abs(parseNumber(netIncomeRow[i])) : -parseNumber(netIncomeRow[i]);
                }
            });

            // Budget revenue breakdown
            revenueBreakdown.budget = {
                subscriptions: { Q1: 822505, Q2: 925468, Q3: 1235160, Q4: 1470148 },
                offapp: { Q1: 20184, Q2: 22120, Q3: 34890, Q4: 45725 },
                partnership: { Q1: 75000, Q2: 90000, Q3: 90000, Q4: 120000 }
            };
        }

        // Calculate quarterly and yearly aggregates
        function calculateAggregates() {
            // Calculate quarterly data for actual
            ['Q1', 'Q2', 'Q3', 'Q4'].forEach((q, qi) => {
                const months = quarterMonths[q];
                let qRevenue = 0, qEbitda = 0, qSpend = 0, qSubs = 0;
                let totalArpu = 0, totalCac = 0, totalConv = 0, count = 0;

                months.forEach(m => {
                    qRevenue += monthlyData[m].revenue || 0;
                    qEbitda += monthlyData[m].ebitda || 0;
                    qSpend += monthlyData[m].spend || 0;
                    qSubs += monthlyData[m].subs || 0;
                    totalArpu += monthlyData[m].arpu || 0;
                    totalCac += monthlyData[m].cac || 0;
                    totalConv += monthlyData[m].conversion || 0;
                    count++;
                });

                const avgCac = totalCac / count;
                const avgArpu = totalArpu / count;

                data.real[q] = {
                    revenue: qRevenue,
                    ebitda: qEbitda,
                    spend: qSpend,
                    subs: qSubs,
                    cac: avgCac,
                    arpu: avgArpu,
                    conversion: totalConv / count,
                    ltvCac: avgArpu > 0 && avgCac > 0 ? (avgArpu * 12) / avgCac : 0,
                    burnRate: Math.abs(qEbitda) / 3
                };
            });

            // Calculate yearly actual
            let yearRevenue = 0, yearEbitda = 0, yearSpend = 0, yearSubs = 0;
            let totalArpu = 0, totalCac = 0, totalConv = 0;
            monthNames.forEach(m => {
                yearRevenue += monthlyData[m].revenue || 0;
                yearEbitda += monthlyData[m].ebitda || 0;
                yearSpend += monthlyData[m].spend || 0;
                yearSubs += monthlyData[m].subs || 0;
                totalArpu += monthlyData[m].arpu || 0;
                totalCac += monthlyData[m].cac || 0;
                totalConv += monthlyData[m].conversion || 0;
            });

            const avgCac = totalCac / 12;
            const avgArpu = totalArpu / 12;

            data.real.YEAR = {
                revenue: yearRevenue,
                ebitda: yearEbitda,
                spend: yearSpend,
                subs: yearSubs,
                cac: avgCac,
                arpu: avgArpu,
                conversion: totalConv / 12,
                ltvCac: avgArpu > 0 && avgCac > 0 ? (avgArpu * 12) / avgCac : 0,
                burnRate: Math.abs(yearEbitda) / 12
            };

            // H1 and H2
            data.real.H1 = {
                revenue: data.real.Q1.revenue + data.real.Q2.revenue,
                ebitda: data.real.Q1.ebitda + data.real.Q2.ebitda,
                spend: data.real.Q1.spend + data.real.Q2.spend,
                subs: data.real.Q1.subs + data.real.Q2.subs,
                cac: (data.real.Q1.cac + data.real.Q2.cac) / 2,
                arpu: (data.real.Q1.arpu + data.real.Q2.arpu) / 2,
                conversion: (data.real.Q1.conversion + data.real.Q2.conversion) / 2,
                ltvCac: (data.real.Q1.ltvCac + data.real.Q2.ltvCac) / 2,
                burnRate: (Math.abs(data.real.Q1.ebitda) + Math.abs(data.real.Q2.ebitda)) / 6
            };

            data.real.H2 = {
                revenue: data.real.Q3.revenue + data.real.Q4.revenue,
                ebitda: data.real.Q3.ebitda + data.real.Q4.ebitda,
                spend: data.real.Q3.spend + data.real.Q4.spend,
                subs: data.real.Q3.subs + data.real.Q4.subs,
                cac: (data.real.Q3.cac + data.real.Q4.cac) / 2,
                arpu: (data.real.Q3.arpu + data.real.Q4.arpu) / 2,
                conversion: (data.real.Q3.conversion + data.real.Q4.conversion) / 2,
                ltvCac: (data.real.Q3.ltvCac + data.real.Q4.ltvCac) / 2,
                burnRate: (Math.abs(data.real.Q3.ebitda) + Math.abs(data.real.Q4.ebitda)) / 6
            };

            // Calculate budget aggregates
            ['Q1', 'Q2', 'Q3', 'Q4'].forEach((q, qi) => {
                const months = quarterMonths[q];
                let qRevenue = 0, qEbitda = 0, qSpend = 0, qSubs = 0;
                let totalArpu = 0, totalCac = 0, count = 0;

                months.forEach(m => {
                    qRevenue += monthlyBudget[m].revenue || 0;
                    qEbitda += monthlyBudget[m].ebitda || 0;
                    qSpend += monthlyBudget[m].spend || 0;
                    qSubs += monthlyBudget[m].subs || 0;
                    totalArpu += monthlyBudget[m].arpu || 0;
                    totalCac += monthlyBudget[m].cac || 0;
                    count++;
                });

                const avgCac = totalCac / count;
                const avgArpu = totalArpu / count;

                data.budget[q] = {
                    revenue: qRevenue,
                    ebitda: qEbitda,
                    spend: qSpend,
                    subs: qSubs,
                    cac: avgCac,
                    arpu: avgArpu,
                    ltvCac: avgArpu > 0 && avgCac > 0 ? (avgArpu * 12) / avgCac : 0,
                    burnRate: qEbitda < 0 ? Math.abs(qEbitda) / 3 : -qEbitda / 3
                };
            });

            // Yearly budget
            let yearBudgetRevenue = 0, yearBudgetEbitda = 0, yearBudgetSpend = 0, yearBudgetSubs = 0;
            let totalBudgetArpu = 0, totalBudgetCac = 0;
            monthNames.forEach(m => {
                yearBudgetRevenue += monthlyBudget[m].revenue || 0;
                yearBudgetEbitda += monthlyBudget[m].ebitda || 0;
                yearBudgetSpend += monthlyBudget[m].spend || 0;
                yearBudgetSubs += monthlyBudget[m].subs || 0;
                totalBudgetArpu += monthlyBudget[m].arpu || 0;
                totalBudgetCac += monthlyBudget[m].cac || 0;
            });

            const avgBudgetCac = totalBudgetCac / 12;
            const avgBudgetArpu = totalBudgetArpu / 12;

            data.budget.YEAR = {
                revenue: yearBudgetRevenue,
                ebitda: yearBudgetEbitda,
                spend: yearBudgetSpend,
                subs: yearBudgetSubs,
                cac: avgBudgetCac,
                arpu: avgBudgetArpu,
                ltvCac: avgBudgetArpu > 0 && avgBudgetCac > 0 ? (avgBudgetArpu * 12) / avgBudgetCac : 0,
                burnRate: 0
            };

            // H1 and H2 budget
            data.budget.H1 = {
                revenue: data.budget.Q1.revenue + data.budget.Q2.revenue,
                ebitda: data.budget.Q1.ebitda + data.budget.Q2.ebitda,
                spend: data.budget.Q1.spend + data.budget.Q2.spend,
                subs: data.budget.Q1.subs + data.budget.Q2.subs,
                cac: (data.budget.Q1.cac + data.budget.Q2.cac) / 2,
                arpu: (data.budget.Q1.arpu + data.budget.Q2.arpu) / 2,
                ltvCac: (data.budget.Q1.ltvCac + data.budget.Q2.ltvCac) / 2,
                burnRate: ((data.budget.Q1.burnRate || 0) + (data.budget.Q2.burnRate || 0)) / 2
            };

            data.budget.H2 = {
                revenue: data.budget.Q3.revenue + data.budget.Q4.revenue,
                ebitda: data.budget.Q3.ebitda + data.budget.Q4.ebitda,
                spend: data.budget.Q3.spend + data.budget.Q4.spend,
                subs: data.budget.Q3.subs + data.budget.Q4.subs,
                cac: (data.budget.Q3.cac + data.budget.Q4.cac) / 2,
                arpu: (data.budget.Q3.arpu + data.budget.Q4.arpu) / 2,
                ltvCac: (data.budget.Q3.ltvCac + data.budget.Q4.ltvCac) / 2,
                burnRate: ((data.budget.Q3.burnRate || 0) + (data.budget.Q4.burnRate || 0)) / 2
            };
        }

        // Main data loading function
        async function loadAllData() {
            try {
                document.getElementById('errorOverlay').classList.add('hidden');
                document.getElementById('loadingOverlay').classList.remove('hidden');

                updateLoadingStatus('Cargando KPIs actuales...', 10);
                const kpiActualCSV = await fetchCSV(DATA_SOURCES.kpiActual);
                parseKPIActual(kpiActualCSV);

                updateLoadingStatus('Cargando KPIs presupuestados...', 30);
                const kpiBudgetCSV = await fetchCSV(DATA_SOURCES.kpiBudget);
                parseKPIBudget(kpiBudgetCSV);

                updateLoadingStatus('Cargando P&L actual...', 50);
                const plActualCSV = await fetchCSV(DATA_SOURCES.plActual);
                parsePLActual(plActualCSV);

                updateLoadingStatus('Cargando P&L presupuestado...', 70);
                const plBudgetCSV = await fetchCSV(DATA_SOURCES.plBudget);
                parsePLBudget(plBudgetCSV);

                updateLoadingStatus('Calculando agregados...', 85);
                calculateAggregates();

                updateLoadingStatus('Inicializando gráficas...', 95);

                // Record load time
                dataLoadedTime = new Date();

                // Initialize the dashboard
                initializeDashboard();

                updateLoadingStatus('¡Datos cargados!', 100);

                setTimeout(() => {
                    hideLoading();
                    // Add last updated badge
                    addLastUpdatedBadge();
                }, 500);

            } catch (error) {
                console.error('Error loading data:', error);
                showError('No se pudo cargar los datos de Google Sheets. Error: ' + error.message);
            }
        }

        function addLastUpdatedBadge() {
            const badge = document.createElement('div');
            badge.className = 'last-updated';
            badge.innerHTML = `Datos actualizados: <strong>${dataLoadedTime.toLocaleString('es-MX')}</strong>`;
            document.body.appendChild(badge);
        }

        function initializeDashboard() {
            updateDropdownOptions();
            updateKPIs();
            updateQuarterDrillDown();
            createContributionMarginChart();
            createRevenueChart();
            createEbitdaChart();
            createMarketingEfficiencyChart();
            createSubscriberAcquisitionChart();
            createUnitEconomicsChart();
            createOpexTable();
            createOpexDonutChart();
        }

        // ============================================
        // INITIALIZE ON PAGE LOAD
        // ============================================
        window.onload = function() {
            loadAllData();
        };

        // ============================================
        // GRANULARITY AND PERIOD SELECTION
        // ============================================
        function setGranularity(granularity) {
            currentGranularity = granularity;

            // Update button styling
            document.querySelectorAll('.granularity-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update dropdown options
            updateDropdownOptions();

            // Update KPIs
            updateKPIs();

            // Update drill-down visibility
            updateQuarterDrillDown();
        }

        function updateDropdownOptions() {
            const dropdown = document.getElementById('periodDropdown');
            let options = '';

            switch(currentGranularity) {
                case 'monthly':
                    options = `
                        <option value="January">January 2025</option>
                        <option value="February">February 2025</option>
                        <option value="March">March 2025</option>
                        <option value="April">April 2025</option>
                        <option value="May">May 2025</option>
                        <option value="June">June 2025</option>
                        <option value="July">July 2025</option>
                        <option value="August">August 2025</option>
                        <option value="September">September 2025</option>
                        <option value="October">October 2025</option>
                        <option value="November">November 2025</option>
                        <option value="December">December 2025</option>
                    `;
                    currentPeriod = 'December';
                    break;
                case 'quarterly':
                    options = `
                        <option value="Q1">Q1 2025</option>
                        <option value="Q2">Q2 2025</option>
                        <option value="Q3">Q3 2025</option>
                        <option value="Q4">Q4 2025</option>
                    `;
                    currentPeriod = 'Q4';
                    break;
                case 'semester':
                    options = `
                        <option value="H1">H1 2025 (Jan-Jun)</option>
                        <option value="H2">H2 2025 (Jul-Dec)</option>
                    `;
                    currentPeriod = 'H2';
                    break;
                case 'yearly':
                    options = `
                        <option value="YTD">Year to Date 2025</option>
                        <option value="YEAR">Full Year 2025</option>
                    `;
                    currentPeriod = 'YTD';
                    break;
            }

            dropdown.innerHTML = options;
            dropdown.value = currentPeriod;
            updatePeriodIndicator();
        }

        function setPeriod(period) {
            currentPeriod = period;
            updatePeriodIndicator();
            updateKPIs();
            updateQuarterDrillDown();
        }

        function updatePeriodIndicator() {
            const indicator = document.getElementById('periodIndicator');
            let displayText = '';

            switch(currentGranularity) {
                case 'monthly':
                    displayText = currentPeriod + ' 2025';
                    break;
                case 'quarterly':
                    displayText = currentPeriod + ' 2025';
                    break;
                case 'semester':
                    displayText = currentPeriod === 'H1' ? 'First Half 2025' : 'Second Half 2025';
                    break;
                case 'yearly':
                    displayText = currentPeriod === 'YTD' ? 'Year to Date 2025' : 'Full Year 2025';
                    break;
            }

            indicator.innerHTML = `Showing: <strong>${displayText}</strong>`;
        }

        // ============================================
        // KPI UPDATES
        // ============================================
        function getDataForPeriod() {
            let real, budget;

            if (currentGranularity === 'monthly') {
                real = monthlyData[currentPeriod];
                budget = monthlyBudget[currentPeriod];
            } else if (currentGranularity === 'quarterly') {
                real = data.real[currentPeriod];
                budget = data.budget[currentPeriod];
            } else if (currentGranularity === 'semester') {
                real = data.real[currentPeriod];
                budget = data.budget[currentPeriod];
            } else {
                // yearly - use YEAR data for both YTD and YEAR (same at end of year)
                real = data.real['YEAR'];
                budget = data.budget['YEAR'];
            }

            return { real, budget };
        }

        function updateKPIs() {
            const { real, budget } = getDataForPeriod();

            const kpiGrid = document.getElementById('consolidatedKPIs');

            // Calculate variances
            const revenueVar = ((real.revenue - budget.revenue) / budget.revenue * 100);
            const subsVar = ((real.subs - budget.subs) / budget.subs * 100);
            const cacVar = ((real.cac - budget.cac) / budget.cac * 100);
            const arpuVar = ((real.arpu - budget.arpu) / budget.arpu * 100);
            const ebitdaVar = real.ebitda - budget.ebitda;
            const ltvCacVar = ((real.ltvCac - budget.ltvCac) / budget.ltvCac * 100);
            const burnRateVar = ((real.burnRate - budget.burnRate) / Math.abs(budget.burnRate || 1) * 100);

            // Format values
            const formatCurrency = (val, decimals = 0) => {
                if (Math.abs(val) >= 1000000) {
                    return '$' + (val / 1000000).toFixed(2) + 'M';
                } else if (Math.abs(val) >= 1000) {
                    return '$' + (val / 1000).toFixed(decimals) + 'K';
                }
                return '$' + val.toFixed(decimals);
            };

            // Determine if variance is favorable (higher is better except for CAC and Burn Rate)
            const getComparisonClass = (variance, lowerIsBetter = false) => {
                if (lowerIsBetter) {
                    return variance <= 0 ? 'positive' : 'negative';
                }
                return variance >= 0 ? 'positive' : 'negative';
            };

            const getArrow = (variance, lowerIsBetter = false) => {
                if (lowerIsBetter) {
                    return variance <= 0 ? '↑' : '↓';
                }
                return variance >= 0 ? '↑' : '↓';
            };

            // Format variance display
            const formatVariance = (variance) => {
                return (variance >= 0 ? '+' : '') + variance.toFixed(1) + '%';
            };

            kpiGrid.innerHTML = `
                <!-- Row 1 -->
                <div class="kpi-card-new">
                    <div class="kpi-card-label">Total Revenue</div>
                    <div class="kpi-card-value">${formatCurrency(real.revenue)}</div>
                    <div class="kpi-card-comparison ${getComparisonClass(revenueVar)}">
                        <span class="kpi-arrow">${getArrow(revenueVar)}</span>
                        Actual ${formatCurrency(real.revenue)} | Budget ${formatCurrency(budget.revenue)} | Var: ${formatVariance(revenueVar)}
                    </div>
                </div>
                <div class="kpi-card-new">
                    <div class="kpi-card-label">LTV:CAC Ratio</div>
                    <div class="kpi-card-value">${real.ltvCac.toFixed(2)}x</div>
                    <div class="kpi-card-comparison ${getComparisonClass(ltvCacVar)}">
                        <span class="kpi-arrow">${getArrow(ltvCacVar)}</span>
                        Actual ${real.ltvCac.toFixed(2)}x | Budget ${budget.ltvCac.toFixed(2)}x | Var: ${formatVariance(ltvCacVar)}
                    </div>
                </div>
                <div class="kpi-card-new">
                    <div class="kpi-card-label">Total New Subscribers</div>
                    <div class="kpi-card-value">${real.subs.toLocaleString()}</div>
                    <div class="kpi-card-comparison ${getComparisonClass(subsVar)}">
                        <span class="kpi-arrow">${getArrow(subsVar)}</span>
                        Actual ${real.subs.toLocaleString()} | Budget ${budget.subs.toLocaleString()} | Var: ${formatVariance(subsVar)}
                    </div>
                </div>
                <div class="kpi-card-new">
                    <div class="kpi-card-label">Monthly Burn Rate</div>
                    <div class="kpi-card-value">${formatCurrency(real.burnRate)}</div>
                    <div class="kpi-card-comparison ${getComparisonClass(burnRateVar, true)}">
                        <span class="kpi-arrow">${getArrow(burnRateVar, true)}</span>
                        Actual ${formatCurrency(real.burnRate)} | Budget ${formatCurrency(Math.abs(budget.burnRate))} | Var: ${formatVariance(burnRateVar)}
                    </div>
                </div>

                <!-- Row 2 -->
                <div class="kpi-card-new">
                    <div class="kpi-card-label">Estimated Runway</div>
                    <div class="kpi-card-value">${real.burnRate > 0 ? '4-10m' : 'Profitable'}</div>
                    <div class="kpi-card-comparison neutral">
                        Based on current burn rate vs budget expectations
                    </div>
                </div>
                <div class="kpi-card-new">
                    <div class="kpi-card-label">EBITDA</div>
                    <div class="kpi-card-value">${formatCurrency(real.ebitda)}</div>
                    <div class="kpi-card-comparison ${getComparisonClass(ebitdaVar)}">
                        <span class="kpi-arrow">${getArrow(ebitdaVar)}</span>
                        Actual ${formatCurrency(real.ebitda)} | Budget ${formatCurrency(budget.ebitda)} | Var: ${formatCurrency(ebitdaVar)}
                    </div>
                </div>
                <div class="kpi-card-new">
                    <div class="kpi-card-label">CAC</div>
                    <div class="kpi-card-value">$${real.cac.toFixed(2)}</div>
                    <div class="kpi-card-comparison ${getComparisonClass(cacVar, true)}">
                        <span class="kpi-arrow">${getArrow(cacVar, true)}</span>
                        Actual $${real.cac.toFixed(2)} | Budget $${budget.cac.toFixed(2)} | Var: ${formatVariance(cacVar)}
                    </div>
                </div>
                <div class="kpi-card-new">
                    <div class="kpi-card-label">ARPU</div>
                    <div class="kpi-card-value">$${real.arpu.toFixed(2)}</div>
                    <div class="kpi-card-comparison ${getComparisonClass(arpuVar)}">
                        <span class="kpi-arrow">${getArrow(arpuVar)}</span>
                        Actual $${real.arpu.toFixed(2)} | Budget $${budget.arpu.toFixed(2)} | Var: ${formatVariance(arpuVar)}
                    </div>
                </div>
            `;
        }

        // ============================================
        // QUARTER DRILL-DOWN
        // ============================================
        function updateQuarterDrillDown() {
            const container = document.getElementById('quarterDrillDown');
            const drillDownContainer = document.getElementById('quarterDrillDownContainer');

            // Show drill-down for quarterly view only
            if (currentGranularity === 'quarterly' && currentPeriod !== 'YEAR') {
                drillDownContainer.style.display = 'block';

                const real = data.real[currentPeriod];
                const months = quarterMonths[currentPeriod];

                container.innerHTML = `
                    <div class="quarter-detail">
                        <div class="quarter-summary" onclick="toggleMonths('${currentPeriod}')">
                            <div class="quarter-summary-left">
                                <h3>${currentPeriod} 2025 Monthly Breakdown</h3>
                                <div class="quarter-summary-stats">
                                    <div>Revenue: <span>$${(real.revenue / 1000).toFixed(0)}K</span></div>
                                    <div>Subscribers: <span>${real.subs.toLocaleString()}</span></div>
                                    <div>CAC: <span>$${real.cac.toFixed(2)}</span></div>
                                    <div>ARPU: <span>$${real.arpu.toFixed(2)}</span></div>
                                </div>
                            </div>
                            <div class="expand-icon" id="expandIcon${currentPeriod}">▼</div>
                        </div>
                        <div class="months-grid" id="monthsGrid${currentPeriod}">
                            ${months.map(month => {
                                const m = monthlyData[month];
                                return `
                                <div class="month-card">
                                    <h4>${month}</h4>
                                    <div class="month-metric">
                                        <span class="month-metric-label">Revenue</span>
                                        <span class="month-metric-value">$${(m.revenue / 1000).toFixed(1)}K</span>
                                    </div>
                                    <div class="month-metric">
                                        <span class="month-metric-label">Subscribers</span>
                                        <span class="month-metric-value">${m.subs.toLocaleString()}</span>
                                    </div>
                                    <div class="month-metric">
                                        <span class="month-metric-label">CAC</span>
                                        <span class="month-metric-value">$${m.cac.toFixed(2)}</span>
                                    </div>
                                    <div class="month-metric">
                                        <span class="month-metric-label">ARPU</span>
                                        <span class="month-metric-value">$${m.arpu.toFixed(2)}</span>
                                    </div>
                                    <div class="month-metric">
                                        <span class="month-metric-label">Contribution Margin</span>
                                        <span class="month-metric-value" style="color: ${(m.arpu - m.cac) >= 0 ? '#22c55e' : '#ef4444'}">$${(m.arpu - m.cac).toFixed(2)}</span>
                                    </div>
                                    <div class="progress-bar-container">
                                        <div class="progress-bar ${(m.arpu - m.cac) >= 0 ? 'under' : 'over'}" style="width: ${Math.min(Math.abs((m.arpu - m.cac) / m.arpu * 100), 100)}%"></div>
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                `;
            } else {
                drillDownContainer.style.display = 'none';
                container.innerHTML = '';
            }
        }

        function toggleMonths(quarter) {
            const grid = document.getElementById(`monthsGrid${quarter}`);
            const icon = document.getElementById(`expandIcon${quarter}`);

            if (grid.classList.contains('expanded')) {
                grid.classList.remove('expanded');
                icon.classList.remove('expanded');
            } else {
                grid.classList.add('expanded');
                icon.classList.add('expanded');
            }
        }

        // ============================================
        // CONTRIBUTION MARGIN CHART
        // ============================================
        function createContributionMarginChart() {
            const ctx = document.getElementById('contributionMarginChart').getContext('2d');

            charts.contributionMargin = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [{
                        label: 'Actual',
                        data: contributionMarginActual.map(v => v / 1000),
                        backgroundColor: function(context) {
                            const value = context.raw;
                            return value >= 0 ? '#1e3a5f' : '#ef4444';
                        },
                        borderRadius: 4
                    }, {
                        label: 'Budget',
                        data: contributionMarginBudget.map(v => v / 1000),
                        backgroundColor: '#94a3b8',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#1e3a5f',
                                font: {
                                    size: 13,
                                    weight: 600
                                },
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            callbacks: {
                                label: function(context) {
                                    const actual = contributionMarginActual[context.dataIndex];
                                    const budget = contributionMarginBudget[context.dataIndex];
                                    const variance = ((actual - budget) / Math.abs(budget) * 100).toFixed(1);
                                    if (context.datasetIndex === 0) {
                                        return `Actual: $${context.parsed.y.toFixed(0)}K | Var: ${variance >= 0 ? '+' : ''}${variance}%`;
                                    }
                                    return `Budget: $${context.parsed.y.toFixed(0)}K`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#e2e8f0',
                                drawBorder: false
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value + 'K';
                                },
                                color: '#6b7280',
                                font: {
                                    size: 12
                                }
                            },
                            border: {
                                display: false
                            }
                        },
                        x: {
                            grid: {
                                display: false,
                                drawBorder: false
                            },
                            ticks: {
                                color: '#6b7280',
                                font: {
                                    size: 12
                                }
                            },
                            border: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // ============================================
        // REVENUE CHART
        // ============================================
        function getRevenueData(filter) {
            if (filter === 'all') {
                return {
                    actual: [
                        data.real.Q1.revenue / 1000,
                        data.real.Q2.revenue / 1000,
                        data.real.Q3.revenue / 1000,
                        data.real.Q4.revenue / 1000
                    ],
                    budget: [
                        data.budget.Q1.revenue / 1000,
                        data.budget.Q2.revenue / 1000,
                        data.budget.Q3.revenue / 1000,
                        data.budget.Q4.revenue / 1000
                    ]
                };
            } else {
                return {
                    actual: [
                        revenueBreakdown.actual[filter].Q1 / 1000,
                        revenueBreakdown.actual[filter].Q2 / 1000,
                        revenueBreakdown.actual[filter].Q3 / 1000,
                        revenueBreakdown.actual[filter].Q4 / 1000
                    ],
                    budget: [
                        revenueBreakdown.budget[filter].Q1 / 1000,
                        revenueBreakdown.budget[filter].Q2 / 1000,
                        revenueBreakdown.budget[filter].Q3 / 1000,
                        revenueBreakdown.budget[filter].Q4 / 1000
                    ]
                };
            }
        }

        function createRevenueChart() {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            const revenueData = getRevenueData('all');

            charts.revenue = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Q1', 'Q2', 'Q3', 'Q4'],
                    datasets: [{
                        label: 'Actual Revenue',
                        data: revenueData.actual,
                        backgroundColor: '#1e3a5f',
                        borderRadius: 6
                    }, {
                        label: 'Budget Revenue',
                        data: revenueData.budget,
                        backgroundColor: '#94a3b8',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#1e3a5f',
                                font: {
                                    size: 13,
                                    weight: 600
                                },
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toFixed(0) + 'K';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#e2e8f0',
                                drawBorder: false
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value + 'K';
                                },
                                color: '#6b7280',
                                font: {
                                    size: 12
                                }
                            },
                            border: {
                                display: false
                            }
                        },
                        x: {
                            grid: {
                                display: false,
                                drawBorder: false
                            },
                            ticks: {
                                color: '#6b7280',
                                font: {
                                    size: 12
                                }
                            },
                            border: {
                                display: false
                            }
                        }
                    }
                }
            });

            updateRevenueBreakdown('all');
        }

        // ============================================
        // REVENUE FILTER
        // ============================================
        function filterRevenue(filter) {
            currentRevenueFilter = filter;

            // Update button states
            document.querySelectorAll('.revenue-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update chart data
            const revenueData = getRevenueData(filter);
            charts.revenue.data.datasets[0].data = revenueData.actual;
            charts.revenue.data.datasets[1].data = revenueData.budget;
            charts.revenue.update();

            // Update breakdown
            updateRevenueBreakdown(filter);
        }

        function updateRevenueBreakdown(filter) {
            const container = document.getElementById('revenueBreakdown');

            if (filter === 'all') {
                // Calculate totals for full year
                const subsActual = revenueBreakdown.actual.subscriptions.Q1 + revenueBreakdown.actual.subscriptions.Q2 +
                                   revenueBreakdown.actual.subscriptions.Q3 + revenueBreakdown.actual.subscriptions.Q4;
                const offActual = revenueBreakdown.actual.offapp.Q1 + revenueBreakdown.actual.offapp.Q2 +
                                  revenueBreakdown.actual.offapp.Q3 + revenueBreakdown.actual.offapp.Q4;
                const partActual = revenueBreakdown.actual.partnership.Q1 + revenueBreakdown.actual.partnership.Q2 +
                                   revenueBreakdown.actual.partnership.Q3 + revenueBreakdown.actual.partnership.Q4;
                const totalActual = subsActual + offActual + partActual;

                const subsPercent = (subsActual / totalActual * 100).toFixed(1);
                const offPercent = (offActual / totalActual * 100).toFixed(1);
                const partPercent = (partActual / totalActual * 100).toFixed(1);

                container.innerHTML = `
                    <div class="revenue-breakdown-item">
                        <div class="revenue-breakdown-label">Subscriptions</div>
                        <div class="revenue-breakdown-value">${subsPercent}%</div>
                    </div>
                    <div class="revenue-breakdown-item">
                        <div class="revenue-breakdown-label">Off App Sales</div>
                        <div class="revenue-breakdown-value">${offPercent}%</div>
                    </div>
                    <div class="revenue-breakdown-item">
                        <div class="revenue-breakdown-label">Partnership</div>
                        <div class="revenue-breakdown-value">${partPercent}%</div>
                    </div>
                `;
            } else {
                // Show specific category info
                const actual = revenueBreakdown.actual[filter];
                const budget = revenueBreakdown.budget[filter];
                const totalActual = actual.Q1 + actual.Q2 + actual.Q3 + actual.Q4;
                const totalBudget = budget.Q1 + budget.Q2 + budget.Q3 + budget.Q4;
                const variance = ((totalActual - totalBudget) / totalBudget * 100).toFixed(1);

                const categoryNames = {
                    'subscriptions': 'Subscription Sales',
                    'offapp': 'Off App Sales',
                    'partnership': 'Partnership'
                };

                container.innerHTML = `
                    <div class="revenue-breakdown-item">
                        <div class="revenue-breakdown-label">Category</div>
                        <div class="revenue-breakdown-value">${categoryNames[filter]}</div>
                    </div>
                    <div class="revenue-breakdown-item">
                        <div class="revenue-breakdown-label">Actual (FY 2025)</div>
                        <div class="revenue-breakdown-value">$${(totalActual / 1000).toFixed(0)}K</div>
                    </div>
                    <div class="revenue-breakdown-item">
                        <div class="revenue-breakdown-label">Budget</div>
                        <div class="revenue-breakdown-value">$${(totalBudget / 1000).toFixed(0)}K</div>
                    </div>
                    <div class="revenue-breakdown-item">
                        <div class="revenue-breakdown-label">vs Budget</div>
                        <div class="revenue-breakdown-value" style="color: ${variance >= 0 ? '#22c55e' : '#ef4444'}">
                            ${variance >= 0 ? '↑' : '↓'} ${Math.abs(variance)}%
                        </div>
                    </div>
                `;
            }
        }

        // ============================================
        // EBITDA CHART
        // ============================================
        function createEbitdaChart() {
            const ctx = document.getElementById('ebitdaChart').getContext('2d');

            charts.ebitda = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Q1', 'Q2', 'Q3', 'Q4'],
                    datasets: [{
                        label: 'Actual EBITDA',
                        data: [
                            data.real.Q1.ebitda / 1000,
                            data.real.Q2.ebitda / 1000,
                            data.real.Q3.ebitda / 1000,
                            data.real.Q4.ebitda / 1000
                        ],
                        backgroundColor: function(context) {
                            const value = context.raw;
                            return value >= 0 ? '#22c55e' : '#ef4444';
                        },
                        borderRadius: 6
                    }, {
                        label: 'Budget EBITDA',
                        data: [
                            data.budget.Q1.ebitda / 1000,
                            data.budget.Q2.ebitda / 1000,
                            data.budget.Q3.ebitda / 1000,
                            data.budget.Q4.ebitda / 1000
                        ],
                        backgroundColor: '#94a3b8',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#1e3a5f',
                                font: {
                                    size: 13,
                                    weight: 600
                                },
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toFixed(0) + 'K';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#e2e8f0',
                                drawBorder: false
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value + 'K';
                                },
                                color: '#6b7280',
                                font: {
                                    size: 12
                                }
                            },
                            border: {
                                display: false
                            }
                        },
                        x: {
                            grid: {
                                display: false,
                                drawBorder: false
                            },
                            ticks: {
                                color: '#6b7280',
                                font: {
                                    size: 12
                                }
                            },
                            border: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // ============================================
        // SUBSCRIBERS CHART
        // ============================================
        // ============================================
        // MARKETING EFFICIENCY CHART (New Users, Spend, CPNU)
        // ============================================
        let subscribersToggles = {
            newUsers: true,
            marketingSpend: true,
            cpnu: true
        };

        function loadSubscribersToggles() {
            const saved = localStorage.getItem('subscribersToggles');
            if (saved) {
                subscribersToggles = JSON.parse(saved);
            }
            updateSubscribersToggleButtons();
        }

        function saveSubscribersToggles() {
            localStorage.setItem('subscribersToggles', JSON.stringify(subscribersToggles));
        }

        function updateSubscribersToggleButtons() {
            document.querySelectorAll('.sub-toggle-btn').forEach(btn => {
                const metric = btn.dataset.metric;
                if (subscribersToggles[metric]) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function getSubscribersChartData() {
            let labels = monthLabelsShort;
            let signupsActual = [];
            let spendActual = [];
            let cpnuActual = [];

            monthNames.forEach(month => {
                signupsActual.push(monthlyData[month].signups / 1000);
                spendActual.push(monthlyData[month].spend / 1000);
                cpnuActual.push(monthlyData[month].cpnu);
            });

            return {
                labels: labels,
                signupsActual: signupsActual,
                spendActual: spendActual,
                cpnuActual: cpnuActual
            };
        }

        function buildSubscribersDatasets(data) {
            const datasets = [];

            if (subscribersToggles.newUsers) {
                datasets.push({
                    label: 'New Users (K)',
                    data: data.signupsActual,
                    type: 'bar',
                    backgroundColor: '#3b82f6',
                    borderRadius: 4,
                    yAxisID: 'y',
                    order: 2
                });
            }

            if (subscribersToggles.marketingSpend) {
                datasets.push({
                    label: 'Marketing Spend ($K)',
                    data: data.spendActual,
                    type: 'bar',
                    backgroundColor: '#f97316',
                    borderRadius: 4,
                    yAxisID: 'y',
                    order: 3
                });
            }

            if (subscribersToggles.cpnu) {
                datasets.push({
                    label: 'CPNU ($)',
                    data: data.cpnuActual,
                    type: 'line',
                    borderColor: '#22c55e',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    pointBackgroundColor: '#22c55e',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    yAxisID: 'y1',
                    order: 1
                });
            }

            return datasets;
        }

        function needsCpnuAxis() {
            return subscribersToggles.cpnu;
        }

        function createMarketingEfficiencyChart() {
            const ctx = document.getElementById('subscribersChart').getContext('2d');
            const data = getSubscribersChartData();
            const datasets = buildSubscribersDatasets(data);

            charts.marketing = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#1e3a5f',
                                font: { size: 12, weight: 600 },
                                padding: 16,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label;
                                    const value = context.parsed.y;
                                    if (label.includes('CPNU')) {
                                        return label + ': $' + value.toFixed(2);
                                    } else if (label.includes('Spend')) {
                                        return label + ': $' + value.toFixed(0) + 'K';
                                    } else {
                                        return label + ': ' + value.toFixed(0) + 'K';
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Users (K) / Spend ($K)',
                                color: '#6b7280',
                                font: { size: 11, weight: 600 }
                            },
                            grid: { color: '#e2e8f0', drawBorder: false },
                            ticks: {
                                color: '#6b7280',
                                font: { size: 11 },
                                callback: function(value) { return value + 'K'; }
                            },
                            border: { display: false }
                        },
                        y1: {
                            type: 'linear',
                            display: needsCpnuAxis(),
                            position: 'right',
                            beginAtZero: true,
                            title: {
                                display: needsCpnuAxis(),
                                text: 'CPNU ($)',
                                color: '#22c55e',
                                font: { size: 11, weight: 600 }
                            },
                            grid: { drawOnChartArea: false },
                            ticks: {
                                color: '#22c55e',
                                font: { size: 11 },
                                callback: function(value) { return '$' + value.toFixed(2); }
                            },
                            border: { display: false }
                        },
                        x: {
                            grid: { display: false, drawBorder: false },
                            ticks: { color: '#6b7280', font: { size: 11 } },
                            border: { display: false }
                        }
                    }
                }
            });

            // Add click handlers to toggle buttons
            document.querySelectorAll('.sub-toggle-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const metric = this.dataset.metric;
                    const activeCount = Object.values(subscribersToggles).filter(v => v).length;
                    if (subscribersToggles[metric] && activeCount <= 1) return;

                    subscribersToggles[metric] = !subscribersToggles[metric];
                    updateSubscribersToggleButtons();
                    updateMarketingChart();
                    saveSubscribersToggles();
                });
            });

            loadSubscribersToggles();
        }

        function updateMarketingChart() {
            const data = getSubscribersChartData();
            const datasets = buildSubscribersDatasets(data);

            charts.marketing.data.labels = data.labels;
            charts.marketing.data.datasets = datasets;
            charts.marketing.options.scales.y1.display = needsCpnuAxis();
            charts.marketing.options.scales.y1.title.display = needsCpnuAxis();
            charts.marketing.update();
        }

        function resetSubscribersToggles() {
            subscribersToggles = { newUsers: true, marketingSpend: true, cpnu: true };
            updateSubscribersToggleButtons();
            updateMarketingChart();
            saveSubscribersToggles();
        }

        // ============================================
        // SUBSCRIBER ACQUISITION & CONVERSION CHART
        // ============================================
        let subscriberAcqToggles = {
            actualSubs: true,
            budgetSubs: false,
            conversionRate: true,
            conversionRateBudget: false
        };

        function loadSubscriberAcqToggles() {
            const saved = localStorage.getItem('subscriberAcqToggles');
            if (saved) {
                subscriberAcqToggles = JSON.parse(saved);
            }
            updateSubscriberAcqToggleButtons();
        }

        function saveSubscriberAcqToggles() {
            localStorage.setItem('subscriberAcqToggles', JSON.stringify(subscriberAcqToggles));
        }

        function updateSubscriberAcqToggleButtons() {
            document.querySelectorAll('.sacq-toggle-btn').forEach(btn => {
                const metric = btn.dataset.metric;
                if (subscriberAcqToggles[metric]) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function getSubscriberAcquisitionData() {
            let labels = monthLabelsShort;
            let actualSubs = [];
            let budgetSubs = [];
            let conversionActual = [];
            let conversionBudget = [];

            monthNames.forEach(month => {
                actualSubs.push(monthlyData[month].subs);
                budgetSubs.push(monthlyBudget[month].subs);
                conversionActual.push(monthlyData[month].conversion);
                conversionBudget.push(monthlyBudget[month].conversion);
            });

            return {
                labels: labels,
                actualSubs: actualSubs,
                budgetSubs: budgetSubs,
                conversionActual: conversionActual,
                conversionBudget: conversionBudget
            };
        }

        function buildSubscriberAcqDatasets(data) {
            const datasets = [];

            if (subscriberAcqToggles.actualSubs) {
                datasets.push({
                    label: 'Actual Subscribers',
                    data: data.actualSubs,
                    type: 'bar',
                    backgroundColor: '#1e3a5f',
                    borderRadius: 4,
                    yAxisID: 'y',
                    order: 2
                });
            }

            if (subscriberAcqToggles.budgetSubs) {
                datasets.push({
                    label: 'Budget Subscribers',
                    data: data.budgetSubs,
                    type: 'bar',
                    backgroundColor: '#94a3b8',
                    borderRadius: 4,
                    yAxisID: 'y',
                    order: 3
                });
            }

            if (subscriberAcqToggles.conversionRate) {
                datasets.push({
                    label: 'Conversion Rate',
                    data: data.conversionActual,
                    type: 'line',
                    borderColor: '#22c55e',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    pointBackgroundColor: '#22c55e',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    yAxisID: 'y1',
                    order: 1
                });
            }

            if (subscriberAcqToggles.conversionRateBudget) {
                datasets.push({
                    label: 'Conv. Rate Budget',
                    data: data.conversionBudget,
                    type: 'line',
                    borderColor: '#22c55e',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    borderDash: [6, 4],
                    fill: false,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: '#22c55e',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 1,
                    yAxisID: 'y1',
                    order: 0
                });
            }

            return datasets;
        }

        function needsConversionAxis() {
            return subscriberAcqToggles.conversionRate || subscriberAcqToggles.conversionRateBudget;
        }

        function createSubscriberAcquisitionChart() {
            const ctx = document.getElementById('subscriberAcquisitionChart').getContext('2d');
            const data = getSubscriberAcquisitionData();
            const datasets = buildSubscriberAcqDatasets(data);

            charts.subscriberAcquisition = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#1e3a5f',
                                font: { size: 12, weight: 600 },
                                padding: 16,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label;
                                    const value = context.parsed.y;
                                    if (label.includes('Conversion') || label.includes('Conv.')) {
                                        return label + ': ' + value.toFixed(2) + '%';
                                    } else {
                                        return label + ': ' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Subscribers',
                                color: '#6b7280',
                                font: { size: 11, weight: 600 }
                            },
                            grid: { color: '#e2e8f0', drawBorder: false },
                            ticks: {
                                color: '#6b7280',
                                font: { size: 11 },
                                callback: function(value) { return value.toLocaleString(); }
                            },
                            border: { display: false },
                            max: 12000
                        },
                        y1: {
                            type: 'linear',
                            display: needsConversionAxis(),
                            position: 'right',
                            beginAtZero: true,
                            title: {
                                display: needsConversionAxis(),
                                text: 'Conversion Rate (%)',
                                color: '#22c55e',
                                font: { size: 11, weight: 600 }
                            },
                            grid: { drawOnChartArea: false },
                            ticks: {
                                color: '#22c55e',
                                font: { size: 11 },
                                callback: function(value) { return value.toFixed(0) + '%'; }
                            },
                            border: { display: false },
                            max: 10
                        },
                        x: {
                            grid: { display: false, drawBorder: false },
                            ticks: { color: '#6b7280', font: { size: 11 } },
                            border: { display: false }
                        }
                    }
                }
            });

            // Add click handlers to toggle buttons
            document.querySelectorAll('.sacq-toggle-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const metric = this.dataset.metric;
                    const activeCount = Object.values(subscriberAcqToggles).filter(v => v).length;
                    if (subscriberAcqToggles[metric] && activeCount <= 1) return;

                    subscriberAcqToggles[metric] = !subscriberAcqToggles[metric];
                    updateSubscriberAcqToggleButtons();
                    updateSubscriberAcquisitionChart();
                    saveSubscriberAcqToggles();
                });
            });

            loadSubscriberAcqToggles();
        }

        function updateSubscriberAcquisitionChart() {
            const data = getSubscriberAcquisitionData();
            const datasets = buildSubscriberAcqDatasets(data);

            charts.subscriberAcquisition.data.labels = data.labels;
            charts.subscriberAcquisition.data.datasets = datasets;
            charts.subscriberAcquisition.options.scales.y1.display = needsConversionAxis();
            charts.subscriberAcquisition.options.scales.y1.title.display = needsConversionAxis();
            charts.subscriberAcquisition.update();
        }

        function resetSubscriberAcqToggles() {
            subscriberAcqToggles = {
                actualSubs: true,
                budgetSubs: false,
                conversionRate: true,
                conversionRateBudget: false
            };
            updateSubscriberAcqToggleButtons();
            updateSubscriberAcquisitionChart();
            saveSubscriberAcqToggles();
        }

        // ============================================
        // UNIT ECONOMICS CHART (ARPU, CAC, Contribution Margin)
        // ============================================
        let unitEconomicsToggles = {
            actualArpu: true,
            budgetArpu: false,
            actualCac: true,
            budgetCac: false,
            arpuCacRatio: false,
            contributionMargin: false
        };

        function loadUnitEconomicsToggles() {
            const saved = localStorage.getItem('unitEconomicsToggles');
            if (saved) {
                unitEconomicsToggles = JSON.parse(saved);
            }
            updateUnitEconomicsToggleButtons();
        }

        function saveUnitEconomicsToggles() {
            localStorage.setItem('unitEconomicsToggles', JSON.stringify(unitEconomicsToggles));
        }

        function updateUnitEconomicsToggleButtons() {
            document.querySelectorAll('.ue-toggle-btn').forEach(btn => {
                const metric = btn.dataset.metric;
                if (unitEconomicsToggles[metric]) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // Get Unit Economics data - ARPU from Row 21, CAC from Row 11, Contribution Margin = ARPU - CAC
        function getUnitEconomicsData() {
            let labels = monthLabelsShort;
            let actualArpu = [];
            let budgetArpu = [];
            let actualCac = [];
            let budgetCac = [];

            monthNames.forEach(month => {
                actualArpu.push(monthlyData[month].arpu);
                budgetArpu.push(monthlyBudget[month].arpu);
                actualCac.push(monthlyData[month].cac);
                budgetCac.push(monthlyBudget[month].cac);
            });

            // Calculate ARPU/CAC Ratio
            const ratioData = actualArpu.map((arpu, i) => {
                const cac = actualCac[i];
                return cac > 0 ? (arpu / cac) : 0;
            });

            // Calculate Contribution Margin as ARPU - CAC (in dollars)
            const cmActual = actualArpu.map((arpu, i) => arpu - actualCac[i]);
            const cmBudget = budgetArpu.map((arpu, i) => arpu - budgetCac[i]);

            return {
                labels: labels,
                actualArpu: actualArpu,
                budgetArpu: budgetArpu,
                actualCac: actualCac,
                budgetCac: budgetCac,
                arpuCacRatio: ratioData,
                contributionMargin: cmActual,
                contributionMarginBudget: cmBudget
            };
        }

        function buildUnitEconomicsDatasets(data) {
            const datasets = [];

            if (unitEconomicsToggles.actualArpu) {
                datasets.push({
                    label: 'Actual ARPU',
                    data: data.actualArpu,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    pointBackgroundColor: '#3b82f6',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    yAxisID: 'y'
                });
            }

            if (unitEconomicsToggles.budgetArpu) {
                datasets.push({
                    label: 'Budget ARPU',
                    data: data.budgetArpu,
                    borderColor: '#3b82f6',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    borderDash: [6, 4],
                    fill: false,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: '#3b82f6',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 1,
                    yAxisID: 'y'
                });
            }

            if (unitEconomicsToggles.actualCac) {
                datasets.push({
                    label: 'Actual CAC',
                    data: data.actualCac,
                    borderColor: '#f97316',
                    backgroundColor: 'rgba(249, 115, 22, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    pointBackgroundColor: '#f97316',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    yAxisID: 'y'
                });
            }

            if (unitEconomicsToggles.budgetCac) {
                datasets.push({
                    label: 'Budget CAC',
                    data: data.budgetCac,
                    borderColor: '#f97316',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    borderDash: [6, 4],
                    fill: false,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: '#f97316',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 1,
                    yAxisID: 'y'
                });
            }

            if (unitEconomicsToggles.arpuCacRatio) {
                datasets.push({
                    label: 'ARPU/CAC Ratio',
                    data: data.arpuCacRatio,
                    borderColor: '#22c55e',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    pointBackgroundColor: '#22c55e',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    yAxisID: 'y1'
                });
            }

            if (unitEconomicsToggles.contributionMargin) {
                datasets.push({
                    label: 'Cont. Margin ($)',
                    data: data.contributionMargin,
                    type: 'line',
                    borderColor: '#8b5cf6',
                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    pointBackgroundColor: '#8b5cf6',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    yAxisID: 'y'
                });
            }

            return datasets;
        }

        function needsRightAxis() {
            return unitEconomicsToggles.arpuCacRatio;
        }

        function createUnitEconomicsChart() {
            const ctx = document.getElementById('unitEconomicsChart').getContext('2d');
            const data = getUnitEconomicsData();
            const datasets = buildUnitEconomicsDatasets(data);

            charts.unitEconomics = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#1e3a5f',
                                font: { size: 12, weight: 600 },
                                padding: 16,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label;
                                    const value = context.parsed.y;
                                    if (label.includes('Ratio')) {
                                        return label + ': ' + value.toFixed(2) + 'x';
                                    } else {
                                        return label + ': $' + value.toFixed(2);
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Dollars ($)',
                                color: '#6b7280',
                                font: { size: 11, weight: 600 }
                            },
                            grid: { color: '#e2e8f0', drawBorder: false },
                            ticks: {
                                color: '#6b7280',
                                font: { size: 11 },
                                callback: function(value) { return '$' + value.toFixed(0); }
                            },
                            border: { display: false }
                        },
                        y1: {
                            type: 'linear',
                            display: needsRightAxis(),
                            position: 'right',
                            beginAtZero: true,
                            title: {
                                display: needsRightAxis(),
                                text: 'Ratio',
                                color: '#22c55e',
                                font: { size: 11, weight: 600 }
                            },
                            grid: { drawOnChartArea: false },
                            ticks: {
                                color: '#22c55e',
                                font: { size: 11 },
                                callback: function(value) { return value.toFixed(1) + 'x'; }
                            },
                            border: { display: false }
                        },
                        x: {
                            grid: { display: false, drawBorder: false },
                            ticks: { color: '#6b7280', font: { size: 11 } },
                            border: { display: false }
                        }
                    }
                }
            });

            // Add click handlers to toggle buttons
            document.querySelectorAll('.ue-toggle-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const metric = this.dataset.metric;
                    const activeCount = Object.values(unitEconomicsToggles).filter(v => v).length;
                    if (unitEconomicsToggles[metric] && activeCount <= 1) return;

                    unitEconomicsToggles[metric] = !unitEconomicsToggles[metric];
                    updateUnitEconomicsToggleButtons();
                    updateUnitEconomicsChart();
                    saveUnitEconomicsToggles();
                });
            });

            loadUnitEconomicsToggles();
        }

        function updateUnitEconomicsChart() {
            const data = getUnitEconomicsData();
            const datasets = buildUnitEconomicsDatasets(data);

            charts.unitEconomics.data.labels = data.labels;
            charts.unitEconomics.data.datasets = datasets;
            charts.unitEconomics.options.scales.y1.display = needsRightAxis();
            charts.unitEconomics.options.scales.y1.title.display = needsRightAxis();
            charts.unitEconomics.update();
        }

        function resetUnitEconomicsToggles() {
            unitEconomicsToggles = {
                actualArpu: true,
                budgetArpu: false,
                actualCac: true,
                budgetCac: false,
                arpuCacRatio: false,
                contributionMargin: false
            };
            updateUnitEconomicsToggleButtons();
            updateUnitEconomicsChart();
            saveUnitEconomicsToggles();
        }

        // ============================================
        // OPEX TABLE
        // ============================================
        function createOpexTable() {
            const tbody = document.getElementById('opexTableBody');
            let totalBudget = 0;
            let totalActual = 0;

            let rows = opexData.map(item => {
                totalBudget += item.budget;
                totalActual += item.actual;

                const varianceDollar = item.actual - item.budget;
                const variancePercent = ((varianceDollar / item.budget) * 100).toFixed(1);
                const isUnder = varianceDollar <= 0;

                return `
                    <tr>
                        <td><strong>${item.category}</strong></td>
                        <td>$${(item.budget / 1000).toFixed(0)}K</td>
                        <td>$${(item.actual / 1000).toFixed(0)}K</td>
                        <td class="${isUnder ? 'variance-positive' : 'variance-negative'}">
                            ${varianceDollar >= 0 ? '+' : ''}$${(varianceDollar / 1000).toFixed(0)}K
                        </td>
                        <td class="${isUnder ? 'variance-positive' : 'variance-negative'}">
                            ${varianceDollar >= 0 ? '+' : ''}${variancePercent}%
                        </td>
                        <td>
                            <span class="status-icon ${isUnder ? 'under-budget' : 'over-budget'}">
                                ${isUnder ? '✓' : '✗'}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');

            const totalVarianceDollar = totalActual - totalBudget;
            const totalVariancePercent = ((totalVarianceDollar / totalBudget) * 100).toFixed(1);
            const totalIsUnder = totalVarianceDollar <= 0;

            rows += `
                <tr class="total-row">
                    <td><strong>TOTAL</strong></td>
                    <td><strong>$${(totalBudget / 1000).toFixed(0)}K</strong></td>
                    <td><strong>$${(totalActual / 1000).toFixed(0)}K</strong></td>
                    <td class="${totalIsUnder ? 'variance-positive' : 'variance-negative'}">
                        <strong>${totalVarianceDollar >= 0 ? '+' : ''}$${(totalVarianceDollar / 1000).toFixed(0)}K</strong>
                    </td>
                    <td class="${totalIsUnder ? 'variance-positive' : 'variance-negative'}">
                        <strong>${totalVarianceDollar >= 0 ? '+' : ''}${totalVariancePercent}%</strong>
                    </td>
                    <td>
                        <span class="status-icon ${totalIsUnder ? 'under-budget' : 'over-budget'}">
                            ${totalIsUnder ? '✓' : '✗'}
                        </span>
                    </td>
                </tr>
            `;

            tbody.innerHTML = rows;
        }

        // ============================================
        // OPEX DONUT CHART
        // ============================================
        function createOpexDonutChart() {
            const ctx = document.getElementById('opexDonutChart').getContext('2d');

            const colors = ['#1e3a5f', '#22c55e', '#ef4444', '#f59e0b', '#6b7280'];

            charts.opexDonut = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: opexData.map(item => item.category),
                    datasets: [{
                        data: opexData.map(item => item.actual),
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#1e3a5f',
                                font: {
                                    size: 11
                                },
                                padding: 12,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return context.label + ': $' + (value / 1000).toFixed(0) + 'K (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        // ============================================
        // CHART TOGGLE SYSTEM
        // ============================================
        const chartToggleConfig = {
            contributionMargin: {
                datasets: [
                    { label: 'Actual', color: '#1e3a5f' },
                    { label: 'Budget', color: '#94a3b8' }
                ]
            },
            revenue: {
                datasets: [
                    { label: 'Actual Revenue', color: '#1e3a5f' },
                    { label: 'Budget Revenue', color: '#94a3b8' }
                ]
            },
            ebitda: {
                datasets: [
                    { label: 'Actual EBITDA', color: '#22c55e' },
                    { label: 'Budget EBITDA', color: '#94a3b8' }
                ]
            }
        };

        // Store original dataset visibility
        const originalDatasetVisibility = {};

        function getToggleStorageKey(chartName) {
            return `kinedu_chart_toggles_${chartName}`;
        }

        function loadTogglePreferences(chartName) {
            try {
                const stored = localStorage.getItem(getToggleStorageKey(chartName));
                if (stored) {
                    return JSON.parse(stored);
                }
            } catch (e) {
                console.warn('Could not load toggle preferences:', e);
            }
            return null;
        }

        function saveTogglePreferences(chartName, visibility) {
            try {
                localStorage.setItem(getToggleStorageKey(chartName), JSON.stringify(visibility));
            } catch (e) {
                console.warn('Could not save toggle preferences:', e);
            }
        }

        function createChartToggles(chartName) {
            const container = document.getElementById(`toggles-${chartName}`);
            if (!container) return;

            const config = chartToggleConfig[chartName];
            if (!config) return;

            const chart = charts[chartName];
            if (!chart) return;

            // Store original visibility
            originalDatasetVisibility[chartName] = chart.data.datasets.map(() => true);

            // Load saved preferences
            const savedPrefs = loadTogglePreferences(chartName);

            let html = '';
            config.datasets.forEach((dataset, index) => {
                const isVisible = savedPrefs ? savedPrefs[index] : true;
                html += `
                    <label class="chart-toggle-label ${isVisible ? 'active' : ''}" data-chart="${chartName}" data-index="${index}">
                        <input type="checkbox" ${isVisible ? 'checked' : ''} onchange="toggleDataset('${chartName}', ${index}, this.checked)">
                        <span class="chart-toggle-color" style="background-color: ${dataset.color}"></span>
                        ${dataset.label}
                    </label>
                `;

                // Apply saved visibility
                if (!isVisible) {
                    chart.setDatasetVisibility(index, false);
                }
            });

            html += `<button class="chart-toggle-reset" onclick="resetChartToggles('${chartName}')">Reset</button>`;
            container.innerHTML = html;

            // Update chart after applying saved preferences
            chart.update();
        }

        function toggleDataset(chartName, datasetIndex, isVisible) {
            const chart = charts[chartName];
            if (!chart) return;

            chart.setDatasetVisibility(datasetIndex, isVisible);
            chart.update();

            // Update toggle label styling
            const label = document.querySelector(`.chart-toggle-label[data-chart="${chartName}"][data-index="${datasetIndex}"]`);
            if (label) {
                label.classList.toggle('active', isVisible);
            }

            // Save preferences
            const visibility = chart.data.datasets.map((_, i) => chart.isDatasetVisible(i));
            saveTogglePreferences(chartName, visibility);
        }

        function resetChartToggles(chartName) {
            const chart = charts[chartName];
            if (!chart) return;

            // Reset all datasets to visible
            chart.data.datasets.forEach((_, index) => {
                chart.setDatasetVisibility(index, true);
            });
            chart.update();

            // Update toggle labels
            const labels = document.querySelectorAll(`.chart-toggle-label[data-chart="${chartName}"]`);
            labels.forEach(label => {
                label.classList.add('active');
                const checkbox = label.querySelector('input[type="checkbox"]');
                if (checkbox) checkbox.checked = true;
            });

            // Clear saved preferences
            localStorage.removeItem(getToggleStorageKey(chartName));
        }

        function initializeAllChartToggles() {
            Object.keys(chartToggleConfig).forEach(chartName => {
                createChartToggles(chartName);
            });
        }

        // Initialize toggles after charts are created
        const originalOnload = window.onload;
        window.onload = function() {
            originalOnload();
            initializeAllChartToggles();
        };
    </script>
</body>
</html>
