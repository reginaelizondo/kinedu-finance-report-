<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kinedu 2025 Financial Report</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #1a1a1a;
            background: #f8fafc;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%);
            color: white;
            padding: 30px 48px 24px;
            position: relative;
        }

        .header-branding {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 16px;
        }

        .header-logo {
            height: 60px;
            margin-bottom: 12px;
        }

        .header-subtitle {
            font-size: 28px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.95);
            letter-spacing: 0.5px;
        }

        .header h1 {
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 24px;
            text-align: center;
        }

        /* Time Filters */
        .time-filters-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .granularity-selector {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            padding: 4px;
            gap: 4px;
        }

        .granularity-btn {
            padding: 10px 24px;
            border: none;
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            font-weight: 600;
            border-radius: 26px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .granularity-btn:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .granularity-btn.active {
            background: white;
            color: #1e3a5f;
        }

        .granularity-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .period-dropdown {
            padding: 8px 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 13px;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            min-width: 150px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 12 12'%3E%3Cpath fill='white' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 30px;
        }

        .period-dropdown option {
            background: #1e3a5f;
            color: white;
        }

        /* Custom Range Selector */
        .custom-range-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 6px;
        }

        .custom-range-label {
            font-size: 13px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
        }

        .range-dropdown {
            padding: 8px 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 13px;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            min-width: 120px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 12 12'%3E%3Cpath fill='white' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 30px;
            transition: all 0.2s ease;
        }

        .range-dropdown:hover {
            border-color: rgba(255, 255, 255, 0.5);
            background-color: rgba(255, 255, 255, 0.15);
        }

        .range-dropdown:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.7);
        }

        .range-dropdown option {
            background: #1e3a5f;
            color: white;
        }

        .range-btn {
            padding: 8px 16px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 13px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .range-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .range-btn.apply-btn {
            background: #48bb78;
        }

        .range-btn.apply-btn:hover {
            background: #38a169;
        }

        .range-btn.reset-btn {
            background: rgba(255, 255, 255, 0.15);
        }

        .range-btn.reset-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .range-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .range-error {
            color: #fc8181;
            font-size: 12px;
            font-weight: 500;
            padding: 4px 10px;
            background: rgba(252, 129, 129, 0.15);
            border-radius: 4px;
            display: none;
        }

        .range-error.visible {
            display: block;
        }

        .custom-range-active {
            background: rgba(72, 187, 120, 0.3);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            color: #86efac;
            font-weight: 600;
            margin-left: 8px;
            display: none;
        }

        .custom-range-active.visible {
            display: inline;
        }

        /* Year Selector */
        .year-selector-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
        }

        .year-selector {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            padding: 4px;
            gap: 4px;
        }

        .year-btn {
            padding: 8px 28px;
            border: none;
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            font-size: 15px;
            font-weight: 700;
            border-radius: 26px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .year-btn:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .year-btn.active {
            background: white;
            color: #1e3a5f;
        }

        /* Budget Scenarios Row (2026 only) - Compact inline style */
        .scenarios-row {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .scenarios-row.visible {
            display: flex;
        }

        .scenarios-row-label {
            font-size: 12px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.6);
        }

        .scenario-toggles-inline {
            display: flex;
            gap: 6px;
        }

        .scenario-toggle {
            padding: 5px 12px;
            border: 1px solid;
            background: transparent;
            font-size: 11px;
            font-weight: 600;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .scenario-toggle.optimistic {
            border-color: rgba(16, 185, 129, 0.4);
            color: rgba(16, 185, 129, 0.7);
        }

        .scenario-toggle.optimistic:hover {
            background: rgba(16, 185, 129, 0.1);
            border-color: #10B981;
            color: #10B981;
        }

        .scenario-toggle.optimistic.active {
            background: rgba(16, 185, 129, 0.25);
            border-color: #10B981;
            color: #10B981;
        }

        .scenario-toggle.conservative {
            border-color: rgba(59, 130, 246, 0.4);
            color: rgba(59, 130, 246, 0.7);
        }

        .scenario-toggle.conservative:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: #3B82F6;
            color: #3B82F6;
        }

        .scenario-toggle.conservative.active {
            background: rgba(59, 130, 246, 0.25);
            border-color: #3B82F6;
            color: #3B82F6;
        }

        .scenario-toggle.pessimistic {
            border-color: rgba(245, 158, 11, 0.4);
            color: rgba(245, 158, 11, 0.7);
        }

        .scenario-toggle.pessimistic:hover {
            background: rgba(245, 158, 11, 0.1);
            border-color: #F59E0B;
            color: #F59E0B;
        }

        .scenario-toggle.pessimistic.active {
            background: rgba(245, 158, 11, 0.25);
            border-color: #F59E0B;
            color: #F59E0B;
        }

        /* Compare vs 2025 Checkbox - Compact inline */
        .compare-row {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 8px;
        }

        .compare-row.visible {
            display: flex;
        }

        .compare-checkbox-small {
            width: 14px;
            height: 14px;
            accent-color: #94a3b8;
            cursor: pointer;
        }

        .compare-label-small {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
        }

        .compare-label-small:hover {
            color: rgba(255, 255, 255, 0.9);
        }

        /* Status Display - Info style, not button */
        .status-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 12px;
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        .status-display strong {
            color: #fbbf24;
        }

        .status-separator {
            color: rgba(255, 255, 255, 0.3);
        }

        .status-scenario {
            display: none;
        }

        .status-scenario.visible {
            display: inline;
        }

        .status-scenario .scenario-value {
            font-weight: 600;
            color: #93c5fd;
        }

        /* Consolidated KPIs Section */
        .kpi-section {
            background: white;
            padding: 48px;
            margin: -20px 48px 0;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 10;
        }

        .kpi-section-title {
            font-size: 20px;
            font-weight: 700;
            color: #1e3a5f;
            margin-bottom: 24px;
            text-align: center;
        }

        .kpi-grid-8 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .kpi-card-new {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 24px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .kpi-card-new:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(30, 58, 95, 0.12);
            border-color: #1e3a5f;
        }

        .kpi-card-label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .kpi-card-value {
            font-size: 32px;
            font-weight: 700;
            color: #1e3a5f;
            margin-bottom: 8px;
            line-height: 1;
        }

        .kpi-card-comparison {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            font-weight: 600;
            line-height: 1.4;
            flex-wrap: wrap;
        }

        .kpi-card-comparison.positive {
            color: #22c55e;
        }

        .kpi-card-comparison.negative {
            color: #ef4444;
        }

        .kpi-card-comparison.neutral {
            color: #6b7280;
        }

        .kpi-arrow {
            font-size: 14px;
        }

        /* Quarter Drill-Down */
        .quarter-tabs-container {
            padding: 48px 48px 0;
        }

        .quarter-detail {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 32px;
        }

        .quarter-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .quarter-summary:hover {
            background: #f1f5f9;
        }

        .quarter-summary-left h3 {
            font-size: 24px;
            color: #1e3a5f;
            margin-bottom: 8px;
        }

        .quarter-summary-stats {
            display: flex;
            gap: 32px;
            font-size: 14px;
            color: #6b7280;
        }

        .quarter-summary-stats span {
            font-weight: 600;
            color: #1e3a5f;
        }

        .expand-icon {
            font-size: 24px;
            color: #6b7280;
            transition: transform 0.3s ease;
        }

        .expand-icon.expanded {
            transform: rotate(180deg);
        }

        .months-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 24px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.4s ease;
            opacity: 0;
        }

        .months-grid.expanded {
            max-height: 600px;
            opacity: 1;
        }

        .month-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 24px;
            transition: all 0.3s ease;
        }

        .month-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-color: #1e3a5f;
        }

        .month-card h4 {
            font-size: 18px;
            color: #1e3a5f;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e2e8f0;
        }

        .month-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .month-metric-label {
            color: #6b7280;
        }

        .month-metric-value {
            font-weight: 600;
            color: #1e3a5f;
        }

        /* Content */
        .content {
            padding: 48px;
        }

        .section {
            margin-bottom: 64px;
        }

        .section-title {
            font-size: 28px;
            font-weight: 700;
            color: #1e3a5f;
            margin-bottom: 32px;
            padding-bottom: 12px;
            border-bottom: 3px solid #1e3a5f;
        }

        /* Charts */
        .chart-container {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 32px;
            transition: all 0.3s ease;
        }

        .chart-container:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
        }

        .chart-title {
            font-size: 20px;
            font-weight: 600;
            color: #1e3a5f;
            margin-bottom: 24px;
        }

        /* Dynamic Insight Callouts */
        .insight-callout {
            background: #F8FAFC;
            border-radius: 8px;
            padding: 16px 20px;
            margin-top: 20px;
            border-left: 4px solid #9CA3AF;
            font-size: 14px;
            line-height: 1.6;
            color: #374151;
            transition: all 0.3s ease;
        }

        .insight-callout.positive {
            border-left-color: #10B981;
            background: linear-gradient(to right, rgba(16, 185, 129, 0.05), #F8FAFC);
        }

        .insight-callout.neutral {
            border-left-color: #F59E0B;
            background: linear-gradient(to right, rgba(245, 158, 11, 0.05), #F8FAFC);
        }

        .insight-callout.alert {
            border-left-color: #EF4444;
            background: linear-gradient(to right, rgba(239, 68, 68, 0.05), #F8FAFC);
        }

        .insight-callout .insight-emoji {
            font-size: 16px;
            margin-right: 8px;
        }

        .insight-callout .insight-metric {
            font-weight: 600;
            color: #1E3A5F;
        }

        .insight-callout .insight-positive {
            color: #10B981;
            font-weight: 600;
        }

        .insight-callout .insight-negative {
            color: #EF4444;
            font-weight: 600;
        }

        .insight-callout .insight-neutral {
            color: #F59E0B;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .insight-callout {
                padding: 14px 16px;
                font-size: 13px;
            }
        }

        /* Revenue Filter Buttons */
        .revenue-filters {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .revenue-filter-btn {
            padding: 10px 24px;
            border: 2px solid #e2e8f0;
            background: white;
            color: #6b7280;
            font-size: 14px;
            font-weight: 600;
            border-radius: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .revenue-filter-btn:hover {
            border-color: #1e3a5f;
            color: #1e3a5f;
            transform: translateY(-1px);
        }

        .revenue-filter-btn.active {
            background: #1e3a5f;
            color: white;
            border-color: #1e3a5f;
        }

        .revenue-filter-btn.cagr-trend-btn {
            border-color: #5BA4E6;
            color: #5BA4E6;
            margin-left: 8px;
            border-style: dashed;
        }

        .revenue-filter-btn.cagr-trend-btn:hover {
            background: rgba(91, 164, 230, 0.1);
            border-color: #5BA4E6;
            color: #5BA4E6;
        }

        .revenue-filter-btn.cagr-trend-btn.active {
            background: #5BA4E6;
            color: white;
            border-color: #5BA4E6;
            border-style: solid;
        }

        .ebitda-filters {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .revenue-breakdown {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-top: 20px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 8px;
            font-size: 14px;
        }

        .revenue-breakdown-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .revenue-breakdown-label {
            color: #6b7280;
            margin-bottom: 4px;
        }

        .revenue-breakdown-value {
            font-weight: 700;
            font-size: 18px;
            color: #1e3a5f;
        }

        /* Operating Expenses Table */
        .opex-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 32px;
            margin-bottom: 32px;
        }

        .opex-table-wrapper {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
        }

        .opex-table {
            width: 100%;
            border-collapse: collapse;
        }

        .opex-table thead {
            background: #1e3a5f;
            color: white;
        }

        .opex-table th {
            padding: 16px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .opex-table th:last-child {
            text-align: center;
        }

        .opex-table tbody tr {
            border-bottom: 1px solid #e2e8f0;
            transition: background 0.2s ease;
        }

        .opex-table tbody tr:nth-child(even) {
            background: #f8fafc;
        }

        .opex-table tbody tr:hover {
            background: #f1f5f9;
        }

        .opex-table tbody tr.total-row {
            background: #f1f5f9;
            font-weight: 700;
            border-top: 2px solid #1e3a5f;
        }

        .opex-table tbody tr.total-row:hover {
            background: #e2e8f0;
        }

        .opex-table td {
            padding: 14px 16px;
            color: #1e3a1a;
            font-size: 14px;
        }

        .opex-table td:last-child {
            text-align: center;
        }

        .variance-positive {
            color: #22c55e;
            font-weight: 600;
        }

        .variance-negative {
            color: #ef4444;
            font-weight: 600;
        }

        .status-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-weight: bold;
            font-size: 14px;
        }

        .status-icon.under-budget {
            background: #dcfce7;
            color: #22c55e;
        }

        .status-icon.over-budget {
            background: #fee2e2;
            color: #ef4444;
        }

        /* Progress Bars */
        .progress-bar-container {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 4px;
        }

        .progress-bar {
            height: 100%;
            border-radius: 3px;
            transition: width 0.4s ease;
        }

        .progress-bar.under {
            background: #22c55e;
        }

        .progress-bar.over {
            background: #ef4444;
        }

        /* Insights */
        .insight-box {
            background: #f8fafc;
            border-left: 4px solid #1e3a5f;
            padding: 28px 32px;
            margin-bottom: 24px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .insight-box:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            transform: translateX(4px);
        }

        .insight-box h3 {
            font-size: 20px;
            color: #1e3a5f;
            margin-bottom: 16px;
        }

        .insight-box ul {
            list-style: none;
        }

        .insight-box li {
            margin-bottom: 14px;
            padding-left: 24px;
            position: relative;
            line-height: 1.6;
        }

        .insight-box li:before {
            content: "→";
            position: absolute;
            left: 0;
            color: #1e3a5f;
            font-weight: bold;
        }

        .positive-box {
            border-left-color: #22c55e;
            background: #f0fdf4;
        }

        .positive-box h3 {
            color: #22c55e;
        }

        .positive-box li:before {
            color: #22c55e;
        }

        .negative-box {
            border-left-color: #ef4444;
            background: #fef2f2;
        }

        .negative-box h3 {
            color: #ef4444;
        }

        .negative-box li:before {
            color: #ef4444;
        }

        /* Footer */
        .footer {
            background: #f8fafc;
            padding: 32px 48px;
            text-align: center;
            color: #6b7280;
            font-size: 14px;
            border-top: 1px solid #e2e8f0;
        }

        .footer p {
            margin-bottom: 8px;
        }

        /* Responsive */
        @media (max-width: 1400px) {
            .kpi-grid-8 {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 1024px) {
            .kpi-grid-8 {
                grid-template-columns: repeat(2, 1fr);
            }

            .opex-container {
                grid-template-columns: 1fr;
            }

            .months-grid {
                grid-template-columns: 1fr;
            }

            .granularity-selector {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .kpi-grid-8 {
                grid-template-columns: 1fr;
            }

            .header,
            .content,
            .kpi-section {
                padding: 24px;
            }

            .kpi-section {
                margin: -20px 16px 0;
            }

            .period-selector-row {
                flex-direction: column;
            }
        }

        /* Chart Toggle Controls */
        .chart-toggles {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            align-items: center;
        }

        .chart-toggle-label {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s ease;
            user-select: none;
        }

        .chart-toggle-label:hover {
            border-color: #1e3a5f;
            color: #1e3a5f;
        }

        .chart-toggle-label.active {
            background: #1e3a5f;
            border-color: #1e3a5f;
            color: white;
        }

        .chart-toggle-label input[type="checkbox"] {
            display: none;
        }

        .chart-toggle-color {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .chart-toggle-reset {
            margin-left: auto;
            padding: 6px 12px;
            background: transparent;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s ease;
        }

        .chart-toggle-reset:hover {
            background: #fee2e2;
            border-color: #ef4444;
            color: #ef4444;
        }

        @media (max-width: 768px) {
            .chart-toggles {
                flex-direction: column;
                align-items: flex-start;
            }

            .chart-toggle-reset {
                margin-left: 0;
                margin-top: 8px;
            }
        }

        /* CAGR Trend Toggle */
        .cagr-toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
            padding-left: 16px;
            border-left: 1px solid #e2e8f0;
        }

        .cagr-toggle-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s ease;
            user-select: none;
        }

        .cagr-toggle-btn:hover {
            border-color: #5BA4E6;
            color: #5BA4E6;
        }

        .cagr-toggle-btn.active {
            background: linear-gradient(135deg, #5BA4E6 0%, #4A93D5 100%);
            border-color: #5BA4E6;
            color: white;
        }

        .cagr-toggle-btn .toggle-icon {
            font-size: 14px;
        }

        .cagr-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .cagr-badge.positive {
            background: rgba(34, 197, 94, 0.15);
            color: #16a34a;
        }

        .cagr-badge.negative {
            background: rgba(239, 68, 68, 0.15);
            color: #dc2626;
        }

        .cagr-badge.neutral {
            background: rgba(107, 114, 128, 0.15);
            color: #6b7280;
        }

        .cagr-badge.hidden {
            display: none;
        }

        .cagr-badge .badge-arrow {
            font-size: 10px;
        }

        @media (max-width: 768px) {
            .cagr-toggle-container {
                margin-left: 0;
                padding-left: 0;
                border-left: none;
                margin-top: 8px;
                width: 100%;
            }
        }

        /* Unit Economics Toggle Controls */
        .unit-economics-toggles {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 16px;
            padding: 12px 16px;
            background: #f8fafc;
            border-radius: 10px;
            align-items: center;
            justify-content: space-between;
        }

        .ue-toggle-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .ue-toggle-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 24px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.2s ease;
            user-select: none;
        }

        .ue-toggle-btn:hover {
            border-color: var(--toggle-color, #1e3a5f);
            color: var(--toggle-color, #1e3a5f);
        }

        .ue-toggle-btn.active {
            background: var(--toggle-color, #1e3a5f);
            border-color: var(--toggle-color, #1e3a5f);
            color: white;
        }

        .ue-toggle-btn.active .ue-toggle-indicator {
            background: white !important;
        }

        .ue-toggle-indicator {
            width: 14px;
            height: 3px;
            border-radius: 2px;
            flex-shrink: 0;
        }

        .ue-reset-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s ease;
        }

        .ue-reset-btn:hover {
            background: #fee2e2;
            border-color: #ef4444;
            color: #ef4444;
        }

        /* Subscribers Chart Toggle Controls */
        .subscribers-toggles {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 16px;
            padding: 12px 16px;
            background: #f8fafc;
            border-radius: 10px;
            align-items: center;
            justify-content: space-between;
        }

        .sub-toggle-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .sub-toggle-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 24px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.2s ease;
            user-select: none;
        }

        .sub-toggle-btn:hover {
            border-color: var(--toggle-color, #1e3a5f);
            color: var(--toggle-color, #1e3a5f);
        }

        .sub-toggle-btn.active {
            background: var(--toggle-color, #1e3a5f);
            border-color: var(--toggle-color, #1e3a5f);
            color: white;
        }

        .sub-toggle-btn.active .sub-toggle-indicator {
            background: white !important;
        }

        .sub-toggle-indicator {
            width: 14px;
            height: 3px;
            border-radius: 2px;
            flex-shrink: 0;
        }

        .sub-reset-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s ease;
        }

        .sub-reset-btn:hover {
            background: #fee2e2;
            border-color: #ef4444;
            color: #ef4444;
        }

        /* Subscriber Acquisition Chart Toggle Controls */
        .subscriber-acq-toggles {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 16px;
            padding: 12px 16px;
            background: #f8fafc;
            border-radius: 10px;
            align-items: center;
            justify-content: space-between;
        }

        .sacq-toggle-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .sacq-toggle-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 24px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.2s ease;
            user-select: none;
        }

        .sacq-toggle-btn:hover {
            border-color: var(--toggle-color, #1e3a5f);
            color: var(--toggle-color, #1e3a5f);
        }

        .sacq-toggle-btn.active {
            background: var(--toggle-color, #1e3a5f);
            border-color: var(--toggle-color, #1e3a5f);
            color: white;
        }

        .sacq-toggle-btn.active .sacq-toggle-indicator {
            background: white !important;
        }

        .sacq-toggle-indicator {
            width: 14px;
            height: 3px;
            border-radius: 2px;
            flex-shrink: 0;
        }

        .sacq-reset-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s ease;
        }

        .sacq-reset-btn:hover {
            background: #fee2e2;
            border-color: #ef4444;
            color: #ef4444;
        }

        @media (max-width: 768px) {
            .unit-economics-toggles,
            .subscribers-toggles,
            .subscriber-acq-toggles {
                flex-direction: column;
                align-items: flex-start;
            }

            .ue-toggle-group,
            .sub-toggle-group,
            .sacq-toggle-group {
                width: 100%;
            }

            .ue-reset-btn,
            .sub-reset-btn,
            .sacq-reset-btn {
                margin-top: 8px;
            }
        }

        /* Loading Overlay Styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(248, 250, 252, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #1e3a5f;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 24px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 18px;
            color: #1e3a5f;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .loading-subtext {
            font-size: 14px;
            color: #6b7280;
        }

        .loading-progress {
            margin-top: 16px;
            width: 200px;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #1e3a5f, #3b82f6);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Error State */
        .error-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(248, 250, 252, 0.98);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .error-overlay.hidden {
            display: none;
        }

        .error-icon {
            font-size: 64px;
            margin-bottom: 24px;
        }

        .error-title {
            font-size: 24px;
            color: #ef4444;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .error-message {
            font-size: 16px;
            color: #6b7280;
            text-align: center;
            max-width: 400px;
            margin-bottom: 24px;
        }

        .retry-btn {
            padding: 12px 32px;
            background: #1e3a5f;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .retry-btn:hover {
            background: #2c5282;
            transform: translateY(-2px);
        }

        /* Last Updated Badge */
        .last-updated {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 12px;
            color: #6b7280;
            z-index: 100;
        }

        .last-updated strong {
            color: #22c55e;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Cargando datos financieros...</div>
        <div class="loading-subtext" id="loadingStatus">Conectando con Google Sheets</div>
        <div class="loading-progress">
            <div class="loading-progress-bar" id="loadingProgressBar"></div>
        </div>
    </div>

    <!-- Error Overlay -->
    <div class="error-overlay hidden" id="errorOverlay">
        <div class="error-icon">⚠️</div>
        <div class="error-title">Error al cargar datos</div>
        <div class="error-message" id="errorMessage">No se pudo conectar con Google Sheets. Verifica tu conexión a internet.</div>
        <button class="retry-btn" onclick="loadAllData()">Reintentar</button>
    </div>

    <div class="container">
        <!-- Header with Title and Time Filters -->
        <div class="header">
            <div class="header-branding">
                <!-- Kinedu Logo -->
                <img class="header-logo" src="logo kinedu.png" alt="Kinedu Logo">
                <div class="header-subtitle" id="headerSubtitle">Financial Performance 2025</div>
            </div>

            <!-- All Filters Container -->
            <div class="time-filters-container">
                <!-- 1. Year Selector -->
                <div class="year-selector-container">
                    <div class="year-selector">
                        <button class="year-btn active" id="yearBtn2025" onclick="setYear(2025)">2025</button>
                        <button class="year-btn" id="yearBtn2026" onclick="setYear(2026)">2026</button>
                    </div>
                </div>

                <!-- 2. Time Granularity + Period Selector -->
                <div class="granularity-row">
                    <div class="granularity-selector">
                        <button class="granularity-btn" onclick="setGranularity('monthly')">Monthly</button>
                        <button class="granularity-btn" onclick="setGranularity('quarterly')">Quarterly</button>
                        <button class="granularity-btn" onclick="setGranularity('semester')">Semester</button>
                        <button class="granularity-btn active" onclick="setGranularity('yearly')">Yearly</button>
                    </div>
                    <select class="period-dropdown" id="periodDropdown" onchange="setPeriod(this.value)">
                        <option value="YTD">Year to Date 2025</option>
                    </select>
                </div>

                <!-- 3. Custom Date Range Selector -->
                <div class="custom-range-container" id="customRangeContainer">
                    <span class="custom-range-label">Custom Range:</span>
                    <select class="range-dropdown" id="rangeFrom" onchange="validateRange()">
                        <option value="0">January</option>
                        <option value="1">February</option>
                        <option value="2">March</option>
                        <option value="3">April</option>
                        <option value="4">May</option>
                        <option value="5">June</option>
                        <option value="6">July</option>
                        <option value="7">August</option>
                        <option value="8">September</option>
                        <option value="9">October</option>
                        <option value="10">November</option>
                        <option value="11">December</option>
                    </select>
                    <span class="custom-range-label">to</span>
                    <select class="range-dropdown" id="rangeTo" onchange="validateRange()">
                        <option value="0">January</option>
                        <option value="1">February</option>
                        <option value="2">March</option>
                        <option value="3">April</option>
                        <option value="4">May</option>
                        <option value="5">June</option>
                        <option value="6">July</option>
                        <option value="7">August</option>
                        <option value="8">September</option>
                        <option value="9">October</option>
                        <option value="10">November</option>
                        <option value="11" selected>December</option>
                    </select>
                    <button class="range-btn apply-btn" id="applyRangeBtn" onclick="applyCustomRange()">Apply</button>
                    <button class="range-btn reset-btn" id="resetRangeBtn" onclick="resetCustomRange()">Reset</button>
                    <span class="range-error" id="rangeError">From must be before To</span>
                </div>

                <!-- 4. Budget Scenarios (only visible for 2026) -->
                <div class="scenarios-row" id="scenariosRow">
                    <span class="scenarios-row-label">Budget Scenario:</span>
                    <div class="scenario-toggles-inline">
                        <button class="scenario-toggle optimistic" id="scenarioOptimistic" onclick="toggleScenario('optimistic')">Optimistic</button>
                        <button class="scenario-toggle conservative active" id="scenarioConservative" onclick="toggleScenario('conservative')">Conservative</button>
                        <button class="scenario-toggle pessimistic" id="scenarioPessimistic" onclick="toggleScenario('pessimistic')">Pessimistic</button>
                    </div>
                </div>

                <!-- 5. Compare vs 2025 Checkbox (only visible for 2026) -->
                <div class="compare-row" id="compareRow">
                    <input type="checkbox" class="compare-checkbox-small" id="compareCheckbox" onchange="toggleCompareWith2025()">
                    <label class="compare-label-small" for="compareCheckbox">Compare vs 2025 Actual</label>
                </div>

                <!-- 6. Status Display (info style) -->
                <div class="status-display" id="statusDisplay">
                    Showing: <strong id="statusPeriod">Year to Date 2025</strong>
                    <span class="status-scenario" id="statusScenario">
                        <span class="status-separator">|</span>
                        Scenario: <span class="scenario-value" id="statusScenarioValue">Conservative</span>
                    </span>
                    <span class="custom-range-active" id="customRangeActive">Custom Range Active</span>
                </div>
            </div>
        </div>

        <!-- Consolidated KPIs Section -->
        <div class="kpi-section">
            <h2 class="kpi-section-title">Key Performance Indicators</h2>
            <div class="kpi-grid-8" id="consolidatedKPIs">
                <!-- KPIs will be populated by JavaScript -->
            </div>
        </div>

        <!-- Quarter Drill-Down (hidden when in monthly mode) -->
        <div class="quarter-tabs-container" id="quarterDrillDownContainer">
            <div id="quarterDrillDown"></div>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Contribution Margin Chart -->
            <div class="section">
                <h2 class="section-title">Contribution Margin Analysis</h2>
                <div class="chart-container">
                    <div class="chart-title">Monthly Contribution Margin: Actual vs Budget (2025)</div>
                    <div class="chart-toggles" id="toggles-contributionMargin"></div>
                    <canvas id="contributionMarginChart" height="80"></canvas>
                </div>
            </div>

            <!-- Revenue & EBITDA Charts -->
            <div class="section">
                <h2 class="section-title">Financial Performance</h2>
                <div class="chart-container">
                    <div class="chart-title" id="revenueChartTitle">Quarterly Revenue: Actual vs Budget</div>
                    <div class="revenue-filters">
                        <button class="revenue-filter-btn active" onclick="filterRevenue('all')">All Revenue</button>
                        <button class="revenue-filter-btn" onclick="filterRevenue('subscriptions')">Subscription Sales</button>
                        <button class="revenue-filter-btn" onclick="filterRevenue('offapp')">Off App Sales</button>
                        <button class="revenue-filter-btn" onclick="filterRevenue('partnership')">Partnership</button>
                        <button class="revenue-filter-btn cagr-trend-btn" id="revenueCagrToggle" onclick="toggleRevenueCagr()">
                            CAGR Trend
                        </button>
                        <span class="cagr-badge hidden" id="revenueCagrBadge">
                            <span class="badge-arrow">↑</span>
                            <span class="badge-value">+0%</span>
                        </span>
                    </div>
                    <div class="chart-toggles" id="toggles-revenue"></div>
                    <canvas id="revenueChart" height="80"></canvas>
                    <div class="revenue-breakdown" id="revenueBreakdown"></div>
                </div>
                <div class="chart-container">
                    <div class="chart-title" id="ebitdaChartTitle">Quarterly EBITDA: Actual vs Budget</div>
                    <div class="ebitda-filters">
                        <button class="revenue-filter-btn cagr-trend-btn" id="ebitdaCagrToggle" onclick="toggleEbitdaCagr()">
                            CAGR Trend
                        </button>
                        <span class="cagr-badge hidden" id="ebitdaCagrBadge">
                            <span class="badge-arrow">↑</span>
                            <span class="badge-value">+0%</span>
                        </span>
                    </div>
                    <canvas id="ebitdaChart" height="80"></canvas>
                </div>
            </div>

            <!-- Operating Expenses -->
            <div class="section">
                <h2 class="section-title" id="opexSectionTitle">Operating Expenses Breakdown</h2>
                <div class="opex-container">
                    <div class="opex-table-wrapper">
                        <table class="opex-table">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Budget</th>
                                    <th>Actual</th>
                                    <th>Variance ($)</th>
                                    <th>Variance (%)</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="opexTableBody"></tbody>
                        </table>
                    </div>
                    <div>
                        <div class="chart-container">
                            <div class="chart-title" id="opexDonutChartTitle">Operating Expenses Breakdown - Full Year 2025</div>
                            <canvas id="opexDonutChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Subscriber Metrics & Marketing Efficiency -->
            <div class="section">
                <h2 class="section-title">Marketing Efficiency & User Acquisition</h2>
                <div class="chart-container">
                    <div class="chart-title" id="subscribersChartTitle">Marketing Efficiency & User Acquisition</div>
                    <div class="subscribers-toggles" id="toggles-subscribers">
                        <div class="sub-toggle-group">
                            <button class="sub-toggle-btn active" data-metric="newUsers" style="--toggle-color: #3B82F6;">
                                <span class="sub-toggle-indicator" style="background: #3B82F6;"></span>
                                New Users
                            </button>
                            <button class="sub-toggle-btn" data-metric="newUsersBudget" style="--toggle-color: #9CA3AF;">
                                <span class="sub-toggle-indicator" style="background: #9CA3AF;"></span>
                                New Users Budget
                            </button>
                            <button class="sub-toggle-btn active" data-metric="marketingSpend" style="--toggle-color: #F59E0B;">
                                <span class="sub-toggle-indicator" style="background: #F59E0B;"></span>
                                Marketing Spend
                            </button>
                            <button class="sub-toggle-btn" data-metric="marketingSpendBudget" style="--toggle-color: #D1D5DB;">
                                <span class="sub-toggle-indicator" style="background: #D1D5DB;"></span>
                                Spend Budget
                            </button>
                            <button class="sub-toggle-btn active" data-metric="cpnu" style="--toggle-color: #8B5CF6;">
                                <span class="sub-toggle-indicator" style="background: #8B5CF6;"></span>
                                CPNU
                            </button>
                            <button class="sub-toggle-btn" data-metric="cpnuBudget" style="--toggle-color: #6B7280;">
                                <span class="sub-toggle-indicator" style="background: #6B7280;"></span>
                                CPNU Budget
                            </button>
                        </div>
                        <button class="sub-reset-btn" onclick="resetSubscribersToggles()">Reset</button>
                    </div>
                    <canvas id="subscribersChart" height="100"></canvas>
                    <div id="marketingInsight" class="insight-callout">
                        <span class="insight-emoji">📊</span> Loading marketing insights...
                    </div>
                </div>

                <!-- Subscriber Acquisition & Conversion Chart -->
                <div class="chart-container">
                    <div class="chart-title" id="subscriberAcquisitionChartTitle">Subscriber Acquisition & Conversion</div>
                    <div class="subscriber-acq-toggles" id="toggles-subscriberAcquisition">
                        <div class="sacq-toggle-group">
                            <button class="sacq-toggle-btn active" data-metric="actualSubs" style="--toggle-color: #1E40AF;">
                                <span class="sacq-toggle-indicator" style="background: #1E40AF;"></span>
                                Actual Subscribers
                            </button>
                            <button class="sacq-toggle-btn" data-metric="budgetSubs" style="--toggle-color: #9CA3AF;">
                                <span class="sacq-toggle-indicator" style="background: #9CA3AF;"></span>
                                Budget Subscribers
                            </button>
                            <button class="sacq-toggle-btn active" data-metric="conversionRate" style="--toggle-color: #10B981;">
                                <span class="sacq-toggle-indicator" style="background: #10B981;"></span>
                                Conversion Rate
                            </button>
                            <button class="sacq-toggle-btn" data-metric="conversionRateBudget" style="--toggle-color: #34D399;">
                                <span class="sacq-toggle-indicator" style="background: #34D399;"></span>
                                Conv. Rate Budget
                            </button>
                        </div>
                        <button class="sacq-reset-btn" onclick="resetSubscriberAcqToggles()">Reset</button>
                    </div>
                    <canvas id="subscriberAcquisitionChart" height="100"></canvas>
                    <div id="subscriberAcqInsight" class="insight-callout">
                        <span class="insight-emoji">📊</span> Loading subscriber acquisition insights...
                    </div>
                </div>
            </div>

            <!-- Unit Economics -->
            <div class="section">
                <h2 class="section-title">Unit Economics</h2>
                <div class="chart-container">
                    <div class="chart-title" id="unitEconomicsChartTitle">Unit Economics: ARPU, CAC & Efficiency Metrics</div>
                    <div class="unit-economics-toggles" id="toggles-unitEconomics">
                        <div class="ue-toggle-group">
                            <button class="ue-toggle-btn active" data-metric="actualArpu" style="--toggle-color: #10B981;">
                                <span class="ue-toggle-indicator" style="background: #10B981;"></span>
                                Actual ARPU
                            </button>
                            <button class="ue-toggle-btn" data-metric="budgetArpu" style="--toggle-color: #9CA3AF;">
                                <span class="ue-toggle-indicator" style="background: #9CA3AF;"></span>
                                Budget ARPU
                            </button>
                            <button class="ue-toggle-btn active" data-metric="actualCac" style="--toggle-color: #F59E0B;">
                                <span class="ue-toggle-indicator" style="background: #F59E0B;"></span>
                                Actual CAC
                            </button>
                            <button class="ue-toggle-btn" data-metric="budgetCac" style="--toggle-color: #6B7280;">
                                <span class="ue-toggle-indicator" style="background: #6B7280;"></span>
                                Budget CAC
                            </button>
                            <button class="ue-toggle-btn" data-metric="arpuCacRatio" style="--toggle-color: #8B5CF6;">
                                <span class="ue-toggle-indicator" style="background: #8B5CF6;"></span>
                                ARPU/CAC Ratio
                            </button>
                            <button class="ue-toggle-btn" data-metric="contributionMargin" style="--toggle-color: #A78BFA;">
                                <span class="ue-toggle-indicator" style="background: #A78BFA;"></span>
                                Cont. Margin
                            </button>
                        </div>
                        <button class="ue-reset-btn" onclick="resetUnitEconomicsToggles()">Reset</button>
                    </div>
                    <canvas id="unitEconomicsChart" height="100"></canvas>
                    <div id="unitEconomicsInsight" class="insight-callout">
                        <span class="insight-emoji">📊</span> Loading unit economics insights...
                    </div>
                </div>
            </div>

            <!-- Key Insights -->
            <div class="section">
                <h2 class="section-title">Executive Summary</h2>

                <div class="insight-box positive-box">
                    <h3>Positive Indicators & Bright Spots</h3>
                    <ul>
                        <li><strong>Conversion Excellence:</strong> FY 2025 conversion rate at 6.2% vs budget target, proving strong product-market fit and user intent quality</li>
                        <li><strong>CAC Efficiency:</strong> Customer acquisition cost at $29.03 actual vs $27.87 budget (+4.2% variance), within acceptable range despite volume challenges</li>
                        <li><strong>LTV:CAC Performance:</strong> Actual ratio of 3.72x vs 4.14x budget (-10.1%), still well above 3.0x benchmark for healthy unit economics</li>
                        <li><strong>Sustainable Unit Economics:</strong> LTV:CAC ratio of 3.72x (actual) vs 4.14x (budget) indicates profitable customer cohorts at scale</li>
                        <li><strong>Burn Rate Management:</strong> Monthly burn rate at $68.7K actual vs $0 budget target, reflecting investment phase with controlled spending</li>
                    </ul>
                </div>

                <div class="insight-box">
                    <h3>Key Insights & Root Cause Analysis</h3>
                    <ul>
                        <li><strong>Volume Deficit is Core Issue:</strong> Actual 71,422 subscribers | Budget 100,452 | Var: -28.9% (-29,030 subscribers), directly causing revenue shortfall</li>
                        <li><strong>Marketing Deployment Gap:</strong> Actual $1.99M | Budget $2.74M | Var: -27.4% (-$752K), suggesting channel saturation or operational capacity limits</li>
                        <li><strong>ARPU Opportunity:</strong> Actual $53.40 | Budget $57.68 | Var: -7.4%, indicates pricing power or upsell potential</li>
                        <li><strong>OpEx Efficiency:</strong> Actual $2.13M | Budget $2.08M | Var: +2.4% over budget, creating margin pressure that requires attention</li>
                        <li><strong>EBITDA Performance:</strong> Actual -$824K | Budget +$2K | Var: -$826K, representing fundamental challenge requiring strategic response</li>
                    </ul>
                </div>

                <div class="insight-box negative-box">
                    <h3>Critical Challenges & Risk Factors</h3>
                    <ul>
                        <li><strong>Runway Constraint:</strong> Actual burn $824K | Budget breakeven | Var: -$826K, estimated 4-10 months runway requires immediate funding action</li>
                        <li><strong>Revenue Gap:</strong> Actual $3.53M | Budget $4.95M | Var: -28.7% (-$1.42M), significant shortfall vs plan</li>
                        <li><strong>Acquisition Bottleneck:</strong> Marketing spend actual $1.99M | Budget $2.74M | Var: -27.4%, inability to deploy suggests structural constraints</li>
                        <li><strong>Revenue Scale Needed:</strong> Actual monthly avg $294K | Budget breakeven ~$412K | Var: -28.7%, must scale +40% to reach profitability</li>
                        <li><strong>Salary & Services Overruns:</strong> Salaries actual $1.04M | Budget $983K | Var: +6.0%; Services actual $183K | Budget $145K | Var: +26.2%</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>Kinedu Financial Report 2025 • Datos en tiempo real desde Google Sheets</p>
            <p>Fuentes: KPI_2025_Actual, KPIs_2025_Budget, P&L_2025_CASH, P&L_2025_CASH_BUDGET</p>
        </div>
    </div>

    <script>
        // ============================================
        // GOOGLE SHEETS DATA SOURCES
        // ============================================
        // 2025 Data Sources
        const DATA_SOURCES_2025 = {
            kpiActual: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTJbzzS-WZtUAhV-pD1yaYzTPofqmh74UYlJgOIJOZC3ZGwlWxe63U8Het9RYJifsjWPELPdRvi2Mqp/pub?output=csv',
            kpiBudget: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSvqeNn34Kx8mu7QADDkU2vB6jW1xGhOZ5_E60A0hpKV_Z7rURC75PkHTW71NBBsgzHwl9VAq3g_bP5/pub?output=csv',
            plActual: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSBn3e5-CrJplm6IPSv6us2ZQUROWdAdDxTyEn5ydzQVmTNGOVpfFXp5eBVibaTrA4Bxfevihn453x3/pub?output=csv',
            plBudget: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSv_vWUvx1AFEUlZmg_sWwzcgkDEFnbNy2Ox4UtxA3HLytst3YZG40FJSMMhup-AqWK3c3xDHkwvacy/pub?output=csv'
        };

        // 2026 Data Sources
        const DATA_SOURCES_2026 = {
            kpiActual: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTQ0Uy9ou09cF78AgvontFHLAculFyBG4n7r_dCrUY9Wb-6c7nPj1eORYqSOrhT47MLqrw48Sii5v4b/pub?output=csv',
            kpiBudgetOptimistic: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSNtj2ts9qPvq6KiFsPxLs7NJY1jR-ivaf-zuIkoqSqS_Hs1Ewazeaz3s5csN5GuQSOAJ6w_pOkVFxz/pub?output=csv',
            kpiBudgetConservative: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS8KODgWuDngND6ghCPZwLjd2eGqBIaJA6vLJRqXSfl0Es4i1HwfFJwSM0Nn47eFPYzyUmi_ULOd_mG/pub?output=csv',
            kpiBudgetPessimistic: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ-JbVG8en1sSFg0VMH991T1mCngfV4A_zKt63ufeWjoAuq_2TEb5iFIYJGBRuK43PUanLyOYhrC6Qk/pub?output=csv',
            plActual: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRMmpvi1XsOQeuArJC54QipxDuf9_xC6AFAO9g3ysw4lQu8BkhLmcoc7aMa0p6SKpX4UlLFrXdZlMan/pub?output=csv',
            plBudgetOptimistic: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRS5sB5UDDyPJ1tPNii2p0taeWnP-5JuQafzz4WKGujs14x1dA9ldnTbS5RSAb6VRoZcps53edhiUFB/pub?output=csv',
            plBudgetConservative: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRBg9z9AZbDU05iLL3iq30pue4QY45PxPNYKvTO47YW3BuZDzJ8zK1nSFzJ1M6wRSLEgTAssr2L1ZKE/pub?output=csv',
            plBudgetPessimistic: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSAMJJTXoKK_whKUo5gqC3ONxmL9U1ESLKso3CD11hrJC-afsBzWtGhVAgc2GfYEV0oAmUR6Py1fB9i/pub?output=csv'
        };

        // Legacy reference (points to current year)
        const DATA_SOURCES = DATA_SOURCES_2025;

        // ============================================
        // DATA VARIABLES (will be populated from Google Sheets)
        // ============================================
        let data = { real: {}, budget: {} };
        let monthlyData = {};
        let monthlyBudget = {};
        let revenueBreakdown = { actual: {}, budget: {} };
        let opexData = [];
        let contributionMarginActual = [];
        let contributionMarginBudget = [];
        let dataLoadedTime = null;

        // Constants
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const monthLabelsShort = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const quarterMonths = {
            "Q1": ["January", "February", "March"],
            "Q2": ["April", "May", "June"],
            "Q3": ["July", "August", "September"],
            "Q4": ["October", "November", "December"]
        };

        let currentRevenueFilter = 'all';
        let currentGranularity = 'yearly';
        let currentPeriod = 'YTD';
        let charts = {};

        // Custom Range variables
        let customRangeActive = false;
        let customRangeFrom = 0;  // Month index (0 = January)
        let customRangeTo = 11;   // Month index (11 = December)

        // CAGR Trend toggle states
        let showRevenueCagrTrend = false;
        let showEbitdaCagrTrend = false;

        // Multi-year and scenario state
        let currentYear = 2025;
        let scenarioStates = {
            optimistic: false,
            conservative: true,  // Default for 2026
            pessimistic: false
        };
        let compareWith2025 = false;

        // 2026 Data storage
        let data2026 = {
            actual: { real: {}, monthlyData: {}, monthlyBudget: {} },
            optimistic: { real: {}, budget: {}, monthlyData: {}, monthlyBudget: {} },
            conservative: { real: {}, budget: {}, monthlyData: {}, monthlyBudget: {} },
            pessimistic: { real: {}, budget: {}, monthlyData: {}, monthlyBudget: {} }
        };
        let data2026Loaded = false;

        // 2025 Data backup for comparison
        let data2025Backup = null;

        // ============================================
        // CSV PARSING UTILITIES
        // ============================================
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const result = [];
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const row = [];
                let current = '';
                let inQuotes = false;

                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        row.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                row.push(current.trim());
                result.push(row);
            }
            return result;
        }

        // Parse numeric value from Spanish/European format (dots as thousands, commas as decimals)
        function parseNumber(value) {
            if (!value || value === '') return 0;

            // Convert to string and remove $ and whitespace
            let cleaned = value.toString().replace(/[$\s"]/g, '');

            // Debug for specific values
            const originalCleaned = cleaned;

            // Check if it's a percentage
            const isPercent = cleaned.includes('%');
            cleaned = cleaned.replace('%', '');

            // Handle number formats
            // US format: "150,872.00" (comma = thousands, dot = decimal)
            // MX/EU format: "150.872,00" (dot = thousands, comma = decimal)

            if (cleaned.includes('.') && cleaned.includes(',')) {
                // Both dot and comma present - determine format by position
                const lastDot = cleaned.lastIndexOf('.');
                const lastComma = cleaned.lastIndexOf(',');

                if (lastDot > lastComma) {
                    // US format: "150,872.00" - comma is thousands, dot is decimal
                    cleaned = cleaned.replace(/,/g, '');
                } else {
                    // MX/EU format: "150.872,00" - dot is thousands, comma is decimal
                    cleaned = cleaned.replace(/\./g, '').replace(',', '.');
                }
            } else if (cleaned.includes(',') && !cleaned.includes('.')) {
                // Only comma present
                const parts = cleaned.split(',');
                if (parts.length === 2 && parts[1].length <= 2) {
                    // Decimal separator: "1,5" or "1,50" -> "1.5"
                    cleaned = cleaned.replace(',', '.');
                } else {
                    // Thousands separator: "1,234" or "150,872" -> "1234" or "150872"
                    cleaned = cleaned.replace(/,/g, '');
                }
            } else if (cleaned.includes('.')) {
                // Only dots present
                const parts = cleaned.split('.');
                if (parts.length > 2) {
                    // Multiple dots = thousands separator: "1.234.567" -> "1234567"
                    cleaned = cleaned.replace(/\./g, '');
                } else if (parts.length === 2 && parts[1].length === 3 && parts[0].length > 0) {
                    // Single dot with 3 digits after = thousands: "150.872" -> "150872"
                    cleaned = cleaned.replace(/\./g, '');
                }
                // Otherwise keep as decimal: "1.5" stays "1.5"
            }

            const num = parseFloat(cleaned) || 0;

            // Debug logging for troubleshooting
            if (originalCleaned.includes('150') || originalCleaned.includes('180') || originalCleaned.includes('200')) {
                console.log('parseNumber DEBUG:', originalCleaned, '->', cleaned, '->', num);
            }

            return isPercent ? num : num;
        }

        // ============================================
        // DATA LOADING FUNCTIONS
        // ============================================
        async function fetchCSV(url) {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return await response.text();
        }

        function updateLoadingStatus(message, progress) {
            const statusEl = document.getElementById('loadingStatus');
            const progressBar = document.getElementById('loadingProgressBar');
            if (statusEl) statusEl.textContent = message;
            if (progressBar) progressBar.style.width = progress + '%';
        }

        function showError(message) {
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('errorOverlay').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // Parse KPI Actual CSV
        function parseKPIActual(csvData) {
            const rows = parseCSV(csvData);
            const rowMap = {};

            // Create a map of row names to values
            rows.forEach(row => {
                if (row[0]) {
                    rowMap[row[0].trim()] = row.slice(1, 13); // 12 months
                }
            });

            // Build monthlyData from KPI Actual
            monthNames.forEach((month, i) => {
                const spend = parseNumber(rowMap['Spend']?.[i] || 0);
                const signups = parseNumber(rowMap['Signups']?.[i] || 0);
                const cpnu = parseNumber(rowMap['CPNU (Without Retargeting)']?.[i] || 0);
                const cac = parseNumber(rowMap['CAC']?.[i] || 0);
                const subs = parseNumber(rowMap['New Subscriptions']?.[i] || 0);
                const arpu = parseNumber(rowMap['ARPU (new subscriptions)']?.[i] || 0);
                const conversion = parseNumber(rowMap['Conversion Rate']?.[i] || 0);

                monthlyData[month] = {
                    spend: spend,
                    signups: signups,
                    cpnu: cpnu,
                    cac: cac,
                    subs: subs,
                    arpu: arpu,
                    conversion: conversion,
                    revenue: 0, // Will be filled from P&L
                    ebitda: 0,
                    ltvCac: arpu > 0 && cac > 0 ? (arpu * 12) / cac : 0,
                    burnRate: 0
                };
            });
        }

        // Parse KPI Budget CSV
        function parseKPIBudget(csvData) {
            const rows = parseCSV(csvData);
            const rowMap = {};

            rows.forEach(row => {
                if (row[0]) {
                    rowMap[row[0].trim()] = row.slice(1, 13);
                }
            });

            // Build monthlyBudget
            monthNames.forEach((month, i) => {
                const spend = parseNumber(rowMap['Market Spend']?.[i] || 0);
                const cpnu = parseNumber(rowMap['CPNU']?.[i] || 0);
                const signups = parseNumber(rowMap['Signups']?.[i] || 0);
                const conversion = parseNumber(rowMap['Conversion Rate']?.[i] || 0);
                const subs = parseNumber(rowMap['New Subscribers']?.[i] || 0);
                const cac = parseNumber(rowMap['Average CAC']?.[i] || 0);
                const arpu = parseNumber(rowMap['New User ARPU']?.[i] || 0);
                const ltvCac = parseNumber(rowMap['LTR / CAC']?.[i] || rowMap['LTR / CAC,']?.[i] || 0);

                monthlyBudget[month] = {
                    spend: spend,
                    cpnu: cpnu / 1000000000 || 1.46, // Fix format issue
                    signups: signups / 10000 || 125641, // Fix format issue
                    conversion: conversion / 100000000 || 4.63, // Fix format issue
                    subs: subs > 100000 ? subs / 1000000000 : subs, // Fix format
                    cac: cac / 1000000000 || 31.60, // Fix format
                    arpu: arpu / 100000000 || 57.41, // Fix format
                    ltvCac: ltvCac || 3.64,
                    revenue: 0,
                    ebitda: 0,
                    burnRate: 0
                };
            });

            // Fix budget numbers - they seem to have wrong decimal handling
            // Use hardcoded budget values since the CSV format is inconsistent
            const budgetDefaults = {
                Q1: { spend: 184000, cpnu: 1.46, signups: 125641, conversion: 4.63, subs: 5822, cac: 31.60, arpu: 57.41, ltvCac: 3.29 },
                Q2: { spend: 215400, cpnu: 1.42, signups: 151958, conversion: 4.90, subs: 7452, cac: 28.90, arpu: 57.90, ltvCac: 3.60 },
                Q3: { spend: 256300, cpnu: 1.30, signups: 196455, conversion: 4.90, subs: 9623, cac: 26.63, arpu: 57.83, ltvCac: 3.86 },
                Q4: { spend: 257500, cpnu: 1.16, signups: 222045, conversion: 4.77, subs: 10587, cac: 24.32, arpu: 57.58, ltvCac: 4.16 }
            };

            // Apply corrections
            ['January', 'February', 'March'].forEach(m => Object.assign(monthlyBudget[m], budgetDefaults.Q1));
            ['April', 'May', 'June'].forEach(m => Object.assign(monthlyBudget[m], budgetDefaults.Q2));
            ['July', 'August', 'September'].forEach(m => Object.assign(monthlyBudget[m], budgetDefaults.Q3));
            ['October', 'November', 'December'].forEach(m => Object.assign(monthlyBudget[m], budgetDefaults.Q4));
        }

        // Parse P&L Actual CSV
        function parsePLActual(csvData) {
            const rows = parseCSV(csvData);
            const rowMap = {};

            rows.forEach(row => {
                const key = (row[0] + ' ' + row[1] + ' ' + row[2]).trim();
                if (row[0] || row[1] || row[2]) {
                    rowMap[key] = row.slice(3, 15); // Columns for months 1-12
                }
            });

            // Extract revenue breakdown
            revenueBreakdown.actual = {
                subscriptions: { Q1: 0, Q2: 0, Q3: 0, Q4: 0 },
                offapp: { Q1: 0, Q2: 0, Q3: 0, Q4: 0 },
                partnership: { Q1: 0, Q2: 0, Q3: 0, Q4: 0 }
            };

            // Find the correct rows
            let subsAppRow, subsOffAppRow, partnershipRow, grossSalesRow, ebitdaRow, contribMarginRow;
            let salariesRow, servicesRow, travelRow, otherServicesRow, otherRow;

            rows.forEach(row => {
                const combined = row.join(' ').toLowerCase();
                if (combined.includes('subscriptions app') && combined.includes('gross sales')) {
                    subsAppRow = row.slice(3, 15);
                }
                if (combined.includes('subscriptions off app') && combined.includes('gross sales')) {
                    subsOffAppRow = row.slice(3, 15);
                }
                if (combined.includes('other revenue') && combined.includes('partnerships')) {
                    partnershipRow = row.slice(3, 15);
                }
                if (row[0] === 'Gross Sales' && row[2] === 'Gross Sales') {
                    grossSalesRow = row.slice(3, 15);
                }
                if (row[0] === 'EBITDA') {
                    ebitdaRow = row.slice(3, 15);
                }
                if (row[0] === 'Contribution Margin') {
                    contribMarginRow = row.slice(3, 15);
                }
                if (combined.includes('salaries') && combined.includes('sueldos')) {
                    salariesRow = row.slice(3, 15);
                }
                if (combined.includes('external services') && combined.includes('servicios externos')) {
                    servicesRow = row.slice(3, 15);
                }
            });

            // Fill contribution margin actual
            contributionMarginActual = [];
            if (contribMarginRow) {
                contribMarginRow.forEach(val => {
                    contributionMarginActual.push(parseNumber(val));
                });
            }

            // Fill monthly revenue and EBITDA
            monthNames.forEach((month, i) => {
                if (grossSalesRow) {
                    monthlyData[month].revenue = parseNumber(grossSalesRow[i]);
                }
                if (ebitdaRow) {
                    monthlyData[month].ebitda = parseNumber(ebitdaRow[i]);
                    monthlyData[month].burnRate = Math.abs(parseNumber(ebitdaRow[i]));
                }
            });

            // Calculate quarterly revenue breakdown
            if (subsAppRow) {
                revenueBreakdown.actual.subscriptions.Q1 = parseNumber(subsAppRow[0]) + parseNumber(subsAppRow[1]) + parseNumber(subsAppRow[2]);
                revenueBreakdown.actual.subscriptions.Q2 = parseNumber(subsAppRow[3]) + parseNumber(subsAppRow[4]) + parseNumber(subsAppRow[5]);
                revenueBreakdown.actual.subscriptions.Q3 = parseNumber(subsAppRow[6]) + parseNumber(subsAppRow[7]) + parseNumber(subsAppRow[8]);
                revenueBreakdown.actual.subscriptions.Q4 = parseNumber(subsAppRow[9]) + parseNumber(subsAppRow[10]) + parseNumber(subsAppRow[11]);
            }
            if (subsOffAppRow) {
                revenueBreakdown.actual.offapp.Q1 = parseNumber(subsOffAppRow[0]) + parseNumber(subsOffAppRow[1]) + parseNumber(subsOffAppRow[2]);
                revenueBreakdown.actual.offapp.Q2 = parseNumber(subsOffAppRow[3]) + parseNumber(subsOffAppRow[4]) + parseNumber(subsOffAppRow[5]);
                revenueBreakdown.actual.offapp.Q3 = parseNumber(subsOffAppRow[6]) + parseNumber(subsOffAppRow[7]) + parseNumber(subsOffAppRow[8]);
                revenueBreakdown.actual.offapp.Q4 = parseNumber(subsOffAppRow[9]) + parseNumber(subsOffAppRow[10]) + parseNumber(subsOffAppRow[11]);
            }
            if (partnershipRow) {
                revenueBreakdown.actual.partnership.Q1 = parseNumber(partnershipRow[0]) + parseNumber(partnershipRow[1]) + parseNumber(partnershipRow[2]);
                revenueBreakdown.actual.partnership.Q2 = parseNumber(partnershipRow[3]) + parseNumber(partnershipRow[4]) + parseNumber(partnershipRow[5]);
                revenueBreakdown.actual.partnership.Q3 = parseNumber(partnershipRow[6]) + parseNumber(partnershipRow[7]) + parseNumber(partnershipRow[8]);
                revenueBreakdown.actual.partnership.Q4 = parseNumber(partnershipRow[9]) + parseNumber(partnershipRow[10]) + parseNumber(partnershipRow[11]);
            }

            // Calculate OpEx from P&L
            let totalSalaries = 0, totalServices = 0, totalOther = 0;
            rows.forEach(row => {
                const combined = row.join(' ').toLowerCase();
                if (combined.includes('salaries') && combined.includes('sueldos')) {
                    for (let i = 3; i < 15; i++) totalSalaries += Math.abs(parseNumber(row[i]));
                }
                if (combined.includes('external services') && combined.includes('servicios externos')) {
                    for (let i = 3; i < 15; i++) totalServices += Math.abs(parseNumber(row[i]));
                }
                if (combined.includes('services') && combined.includes('servicios') && !combined.includes('external')) {
                    for (let i = 3; i < 15; i++) totalOther += Math.abs(parseNumber(row[i]));
                }
            });

            opexData = [
                { category: "Salaries & Payroll", budget: 983000, actual: totalSalaries || 1042000 },
                { category: "Technology & Software", budget: 450000, actual: 428000 },
                { category: "Services & Contractors", budget: 145000, actual: totalServices || 183000 },
                { category: "Operations & Admin", budget: 320000, actual: 305000 },
                { category: "Other Expenses", budget: 180000, actual: 168000 }
            ];
        }

        // Parse P&L Budget CSV
        function parsePLBudget(csvData) {
            const rows = parseCSV(csvData);

            // Find contribution margin row
            let contribMarginRow;
            rows.forEach(row => {
                if (row[1] && row[1].includes('Contribution Margin') && !row[1].includes('%')) {
                    contribMarginRow = row.slice(2, 14);
                }
            });

            // Fill contribution margin budget
            contributionMarginBudget = [];
            if (contribMarginRow) {
                contribMarginRow.forEach(val => {
                    contributionMarginBudget.push(parseNumber(val));
                });
            }

            // Find revenue rows for budget
            let grossRevenueRow, netIncomeRow;
            rows.forEach(row => {
                if (row[1] && row[1].includes('Gross Revenue')) {
                    grossRevenueRow = row.slice(2, 14);
                }
                if (row[1] && row[1].includes('NET INCOME')) {
                    netIncomeRow = row.slice(2, 14);
                }
            });

            // Fill monthly budget revenue and EBITDA
            monthNames.forEach((month, i) => {
                if (grossRevenueRow) {
                    monthlyBudget[month].revenue = parseNumber(grossRevenueRow[i]);
                }
                if (netIncomeRow) {
                    monthlyBudget[month].ebitda = parseNumber(netIncomeRow[i]);
                    monthlyBudget[month].burnRate = parseNumber(netIncomeRow[i]) < 0 ? Math.abs(parseNumber(netIncomeRow[i])) : -parseNumber(netIncomeRow[i]);
                }
            });

            // Budget revenue breakdown
            revenueBreakdown.budget = {
                subscriptions: { Q1: 822505, Q2: 925468, Q3: 1235160, Q4: 1470148 },
                offapp: { Q1: 20184, Q2: 22120, Q3: 34890, Q4: 45725 },
                partnership: { Q1: 75000, Q2: 90000, Q3: 90000, Q4: 120000 }
            };
        }

        // Calculate quarterly and yearly aggregates
        function calculateAggregates() {
            // Calculate quarterly data for actual
            ['Q1', 'Q2', 'Q3', 'Q4'].forEach((q, qi) => {
                const months = quarterMonths[q];
                let qRevenue = 0, qEbitda = 0, qSpend = 0, qSubs = 0;
                let totalArpu = 0, totalCac = 0, totalConv = 0, count = 0;

                months.forEach(m => {
                    qRevenue += monthlyData[m].revenue || 0;
                    qEbitda += monthlyData[m].ebitda || 0;
                    qSpend += monthlyData[m].spend || 0;
                    qSubs += monthlyData[m].subs || 0;
                    totalArpu += monthlyData[m].arpu || 0;
                    totalCac += monthlyData[m].cac || 0;
                    totalConv += monthlyData[m].conversion || 0;
                    count++;
                });

                const avgCac = totalCac / count;
                const avgArpu = totalArpu / count;

                data.real[q] = {
                    revenue: qRevenue,
                    ebitda: qEbitda,
                    spend: qSpend,
                    subs: qSubs,
                    cac: avgCac,
                    arpu: avgArpu,
                    conversion: totalConv / count,
                    ltvCac: avgArpu > 0 && avgCac > 0 ? (avgArpu * 12) / avgCac : 0,
                    burnRate: Math.abs(qEbitda) / 3
                };
            });

            // Calculate yearly actual
            let yearRevenue = 0, yearEbitda = 0, yearSpend = 0, yearSubs = 0;
            let totalArpu = 0, totalCac = 0, totalConv = 0;
            monthNames.forEach(m => {
                yearRevenue += monthlyData[m].revenue || 0;
                yearEbitda += monthlyData[m].ebitda || 0;
                yearSpend += monthlyData[m].spend || 0;
                yearSubs += monthlyData[m].subs || 0;
                totalArpu += monthlyData[m].arpu || 0;
                totalCac += monthlyData[m].cac || 0;
                totalConv += monthlyData[m].conversion || 0;
            });

            const avgCac = totalCac / 12;
            const avgArpu = totalArpu / 12;

            data.real.YEAR = {
                revenue: yearRevenue,
                ebitda: yearEbitda,
                spend: yearSpend,
                subs: yearSubs,
                cac: avgCac,
                arpu: avgArpu,
                conversion: totalConv / 12,
                ltvCac: avgArpu > 0 && avgCac > 0 ? (avgArpu * 12) / avgCac : 0,
                burnRate: Math.abs(yearEbitda) / 12
            };

            // H1 and H2
            data.real.H1 = {
                revenue: data.real.Q1.revenue + data.real.Q2.revenue,
                ebitda: data.real.Q1.ebitda + data.real.Q2.ebitda,
                spend: data.real.Q1.spend + data.real.Q2.spend,
                subs: data.real.Q1.subs + data.real.Q2.subs,
                cac: (data.real.Q1.cac + data.real.Q2.cac) / 2,
                arpu: (data.real.Q1.arpu + data.real.Q2.arpu) / 2,
                conversion: (data.real.Q1.conversion + data.real.Q2.conversion) / 2,
                ltvCac: (data.real.Q1.ltvCac + data.real.Q2.ltvCac) / 2,
                burnRate: (Math.abs(data.real.Q1.ebitda) + Math.abs(data.real.Q2.ebitda)) / 6
            };

            data.real.H2 = {
                revenue: data.real.Q3.revenue + data.real.Q4.revenue,
                ebitda: data.real.Q3.ebitda + data.real.Q4.ebitda,
                spend: data.real.Q3.spend + data.real.Q4.spend,
                subs: data.real.Q3.subs + data.real.Q4.subs,
                cac: (data.real.Q3.cac + data.real.Q4.cac) / 2,
                arpu: (data.real.Q3.arpu + data.real.Q4.arpu) / 2,
                conversion: (data.real.Q3.conversion + data.real.Q4.conversion) / 2,
                ltvCac: (data.real.Q3.ltvCac + data.real.Q4.ltvCac) / 2,
                burnRate: (Math.abs(data.real.Q3.ebitda) + Math.abs(data.real.Q4.ebitda)) / 6
            };

            // Calculate budget aggregates
            ['Q1', 'Q2', 'Q3', 'Q4'].forEach((q, qi) => {
                const months = quarterMonths[q];
                let qRevenue = 0, qEbitda = 0, qSpend = 0, qSubs = 0;
                let totalArpu = 0, totalCac = 0, count = 0;

                months.forEach(m => {
                    qRevenue += monthlyBudget[m].revenue || 0;
                    qEbitda += monthlyBudget[m].ebitda || 0;
                    qSpend += monthlyBudget[m].spend || 0;
                    qSubs += monthlyBudget[m].subs || 0;
                    totalArpu += monthlyBudget[m].arpu || 0;
                    totalCac += monthlyBudget[m].cac || 0;
                    count++;
                });

                const avgCac = totalCac / count;
                const avgArpu = totalArpu / count;

                data.budget[q] = {
                    revenue: qRevenue,
                    ebitda: qEbitda,
                    spend: qSpend,
                    subs: qSubs,
                    cac: avgCac,
                    arpu: avgArpu,
                    ltvCac: avgArpu > 0 && avgCac > 0 ? (avgArpu * 12) / avgCac : 0,
                    burnRate: qEbitda < 0 ? Math.abs(qEbitda) / 3 : -qEbitda / 3
                };
            });

            // Yearly budget
            let yearBudgetRevenue = 0, yearBudgetEbitda = 0, yearBudgetSpend = 0, yearBudgetSubs = 0;
            let totalBudgetArpu = 0, totalBudgetCac = 0;
            monthNames.forEach(m => {
                yearBudgetRevenue += monthlyBudget[m].revenue || 0;
                yearBudgetEbitda += monthlyBudget[m].ebitda || 0;
                yearBudgetSpend += monthlyBudget[m].spend || 0;
                yearBudgetSubs += monthlyBudget[m].subs || 0;
                totalBudgetArpu += monthlyBudget[m].arpu || 0;
                totalBudgetCac += monthlyBudget[m].cac || 0;
            });

            const avgBudgetCac = totalBudgetCac / 12;
            const avgBudgetArpu = totalBudgetArpu / 12;

            data.budget.YEAR = {
                revenue: yearBudgetRevenue,
                ebitda: yearBudgetEbitda,
                spend: yearBudgetSpend,
                subs: yearBudgetSubs,
                cac: avgBudgetCac,
                arpu: avgBudgetArpu,
                ltvCac: avgBudgetArpu > 0 && avgBudgetCac > 0 ? (avgBudgetArpu * 12) / avgBudgetCac : 0,
                burnRate: 0
            };

            // H1 and H2 budget
            data.budget.H1 = {
                revenue: data.budget.Q1.revenue + data.budget.Q2.revenue,
                ebitda: data.budget.Q1.ebitda + data.budget.Q2.ebitda,
                spend: data.budget.Q1.spend + data.budget.Q2.spend,
                subs: data.budget.Q1.subs + data.budget.Q2.subs,
                cac: (data.budget.Q1.cac + data.budget.Q2.cac) / 2,
                arpu: (data.budget.Q1.arpu + data.budget.Q2.arpu) / 2,
                ltvCac: (data.budget.Q1.ltvCac + data.budget.Q2.ltvCac) / 2,
                burnRate: ((data.budget.Q1.burnRate || 0) + (data.budget.Q2.burnRate || 0)) / 2
            };

            data.budget.H2 = {
                revenue: data.budget.Q3.revenue + data.budget.Q4.revenue,
                ebitda: data.budget.Q3.ebitda + data.budget.Q4.ebitda,
                spend: data.budget.Q3.spend + data.budget.Q4.spend,
                subs: data.budget.Q3.subs + data.budget.Q4.subs,
                cac: (data.budget.Q3.cac + data.budget.Q4.cac) / 2,
                arpu: (data.budget.Q3.arpu + data.budget.Q4.arpu) / 2,
                ltvCac: (data.budget.Q3.ltvCac + data.budget.Q4.ltvCac) / 2,
                burnRate: ((data.budget.Q3.burnRate || 0) + (data.budget.Q4.burnRate || 0)) / 2
            };
        }

        // Main data loading function
        async function loadAllData() {
            try {
                document.getElementById('errorOverlay').classList.add('hidden');
                document.getElementById('loadingOverlay').classList.remove('hidden');

                updateLoadingStatus('Cargando KPIs actuales...', 10);
                const kpiActualCSV = await fetchCSV(DATA_SOURCES.kpiActual);
                parseKPIActual(kpiActualCSV);

                updateLoadingStatus('Cargando KPIs presupuestados...', 30);
                const kpiBudgetCSV = await fetchCSV(DATA_SOURCES.kpiBudget);
                parseKPIBudget(kpiBudgetCSV);

                updateLoadingStatus('Cargando P&L actual...', 50);
                const plActualCSV = await fetchCSV(DATA_SOURCES.plActual);
                parsePLActual(plActualCSV);

                updateLoadingStatus('Cargando P&L presupuestado...', 70);
                const plBudgetCSV = await fetchCSV(DATA_SOURCES.plBudget);
                parsePLBudget(plBudgetCSV);

                updateLoadingStatus('Calculando agregados...', 85);
                calculateAggregates();

                updateLoadingStatus('Inicializando gráficas...', 95);

                // Record load time
                dataLoadedTime = new Date();

                // Initialize the dashboard
                initializeDashboard();

                updateLoadingStatus('¡Datos cargados!', 100);

                setTimeout(() => {
                    hideLoading();
                    // Add last updated badge
                    addLastUpdatedBadge();
                }, 500);

            } catch (error) {
                console.error('Error loading data:', error);
                showError('No se pudo cargar los datos de Google Sheets. Error: ' + error.message);
            }
        }

        function addLastUpdatedBadge() {
            const badge = document.createElement('div');
            badge.className = 'last-updated';
            badge.innerHTML = `Datos actualizados: <strong>${dataLoadedTime.toLocaleString('es-MX')}</strong>`;
            document.body.appendChild(badge);
        }

        function initializeDashboard() {
            try {
                updateDropdownOptions();
                updateKPIs();
                updateQuarterDrillDown();
                createContributionMarginChart();
                createRevenueChart();
                createEbitdaChart();
                createMarketingEfficiencyChart();
                createSubscriberAcquisitionChart();
                createUnitEconomicsChart();
                createOpexTable();
                createOpexDonutChart();
                updateAllInsights();
            } catch (error) {
                console.error('Error initializing dashboard:', error);
            }
        }

        // ============================================
        // DYNAMIC INSIGHTS GENERATION
        // ============================================

        function formatCurrency(value, decimals = 0) {
            if (Math.abs(value) >= 1000000) {
                return '$' + (value / 1000000).toFixed(1) + 'M';
            } else if (Math.abs(value) >= 1000) {
                return '$' + (value / 1000).toFixed(decimals) + 'K';
            }
            return '$' + value.toFixed(decimals);
        }

        function formatPercent(value, decimals = 1) {
            return value.toFixed(decimals) + '%';
        }

        function formatNumber(value, decimals = 0) {
            if (Math.abs(value) >= 1000000) {
                return (value / 1000000).toFixed(1) + 'M';
            } else if (Math.abs(value) >= 1000) {
                return (value / 1000).toFixed(decimals) + 'K';
            }
            return value.toFixed(decimals);
        }

        function getInsightData() {
            // Aggregate data based on current granularity and period
            let actualData = { spend: 0, signups: 0, cpnu: 0, subs: 0, cac: 0, arpu: 0, conversion: 0, ltvCac: 0 };
            let budgetData = { spend: 0, signups: 0, cpnu: 0, subs: 0, cac: 0, arpu: 0, conversion: 0, ltvCac: 0 };
            let months = [];

            // Handle custom range first
            if (customRangeActive) {
                months = getCustomRangeMonths();
            } else if (currentGranularity === 'yearly') {
                months = monthNames;
            } else if (currentGranularity === 'semester') {
                if (currentPeriod === 'H1') {
                    months = ['January', 'February', 'March', 'April', 'May', 'June'];
                } else {
                    months = ['July', 'August', 'September', 'October', 'November', 'December'];
                }
            } else if (currentGranularity === 'quarterly') {
                const quarterMonths = {
                    'Q1': ['January', 'February', 'March'],
                    'Q2': ['April', 'May', 'June'],
                    'Q3': ['July', 'August', 'September'],
                    'Q4': ['October', 'November', 'December']
                };
                months = quarterMonths[currentPeriod] || ['October', 'November', 'December'];
            } else {
                // Monthly - single month
                months = [currentPeriod];
            }

            // Aggregate actual data
            let count = 0;
            months.forEach(m => {
                if (monthlyData[m]) {
                    actualData.spend += monthlyData[m].spend || 0;
                    actualData.signups += monthlyData[m].signups || 0;
                    actualData.subs += monthlyData[m].subs || 0;
                    actualData.cpnu += monthlyData[m].cpnu || 0;
                    actualData.cac += monthlyData[m].cac || 0;
                    actualData.arpu += monthlyData[m].arpu || 0;
                    actualData.conversion += monthlyData[m].conversion || 0;
                    actualData.ltvCac += monthlyData[m].ltvCac || 0;
                    count++;
                }
            });

            // Average out rate-based metrics
            if (count > 0) {
                actualData.cpnu = actualData.cpnu / count;
                actualData.cac = actualData.cac / count;
                actualData.arpu = actualData.arpu / count;
                actualData.conversion = actualData.conversion / count;
                actualData.ltvCac = actualData.ltvCac / count;
            }

            // Aggregate budget data
            count = 0;
            months.forEach(m => {
                if (monthlyBudget[m]) {
                    budgetData.spend += monthlyBudget[m].spend || 0;
                    budgetData.signups += monthlyBudget[m].signups || 0;
                    budgetData.subs += monthlyBudget[m].subs || 0;
                    budgetData.cpnu += monthlyBudget[m].cpnu || 0;
                    budgetData.cac += monthlyBudget[m].cac || 0;
                    budgetData.arpu += monthlyBudget[m].arpu || 0;
                    budgetData.conversion += monthlyBudget[m].conversion || 0;
                    budgetData.ltvCac += monthlyBudget[m].ltvCac || 0;
                    count++;
                }
            });

            // Average out rate-based metrics
            if (count > 0) {
                budgetData.cpnu = budgetData.cpnu / count;
                budgetData.cac = budgetData.cac / count;
                budgetData.arpu = budgetData.arpu / count;
                budgetData.conversion = budgetData.conversion / count;
                budgetData.ltvCac = budgetData.ltvCac / count;
            }

            return { actual: actualData, budget: budgetData, periodMonths: months.length };
        }

        function generateMarketingInsight() {
            const insightData = getInsightData();
            if (!insightData) return;
            const { actual, budget } = insightData;

            // Calculate metrics
            const spendVariation = budget.spend > 0 ? ((actual.spend - budget.spend) / budget.spend) * 100 : 0;
            const spendDelta = actual.spend - budget.spend;
            const spendPct = budget.spend > 0 ? (actual.spend / budget.spend) * 100 : 0;

            const cpnuVariation = budget.cpnu > 0 ? ((actual.cpnu - budget.cpnu) / budget.cpnu) * 100 : 0;
            const cpnuEfficiency = cpnuVariation < 0 ? Math.abs(cpnuVariation) : -cpnuVariation;

            // Determine sentiment
            let sentiment = 'neutral';
            let emoji = '📊';

            // Positive: spending less AND CPNU better than target
            if (spendVariation < 0 && cpnuVariation <= 0) {
                sentiment = 'positive';
                emoji = '✅';
            } else if (spendVariation < -10 || cpnuVariation > 10) {
                sentiment = 'alert';
                emoji = '⚠️';
            } else if (spendVariation < 0) {
                sentiment = 'neutral';
                emoji = '📉';
            }

            // Build insight text
            let text = `<span class="insight-emoji">${emoji}</span>`;

            text += `Marketing spend at <span class="insight-metric">${formatPercent(spendPct, 1)}</span> of budget `;
            text += `(<span class="${spendDelta < 0 ? 'insight-positive' : 'insight-negative'}">${spendDelta < 0 ? '' : '+'}${formatCurrency(spendDelta)}</span>). `;

            text += `CPNU performing at <span class="insight-metric">$${actual.cpnu.toFixed(2)}</span> vs $${budget.cpnu.toFixed(2)} target `;

            if (cpnuVariation <= 0) {
                text += `(<span class="insight-positive">+${Math.abs(cpnuVariation).toFixed(1)}% efficiency</span>). `;
            } else {
                text += `(<span class="insight-negative">-${cpnuVariation.toFixed(1)}% efficiency</span>). `;
            }

            // Conclusion based on analysis
            if (spendVariation < -15 && cpnuVariation <= 5) {
                text += `<em>Opportunity to scale acquisition in efficient channels.</em>`;
            } else if (spendVariation < 0 && cpnuVariation <= 0) {
                text += `<em>Operating efficiently below budget with strong unit economics.</em>`;
            } else if (cpnuVariation > 10) {
                text += `<em>Review channel mix to improve cost per acquisition.</em>`;
            } else {
                text += `<em>Marketing metrics tracking within acceptable ranges.</em>`;
            }

            // Update DOM
            const el = document.getElementById('marketingInsight');
            el.innerHTML = text;
            el.className = `insight-callout ${sentiment}`;
        }

        function generateSubscriberAcqInsight() {
            const insightData = getInsightData();
            if (!insightData) return;
            const { actual, budget } = insightData;

            // Calculate metrics
            const subsGap = actual.subs - budget.subs;
            const subsGapPct = budget.subs > 0 ? (subsGap / budget.subs) * 100 : 0;

            const convVariation = budget.conversion > 0 ? ((actual.conversion - budget.conversion) / budget.conversion) * 100 : 0;

            // Determine sentiment
            let sentiment = 'neutral';
            let emoji = '👥';

            if (subsGapPct >= -5 && convVariation >= 0) {
                sentiment = 'positive';
                emoji = '📈';
            } else if (subsGapPct < -15) {
                sentiment = 'alert';
                emoji = '⚠️';
            } else {
                emoji = '👥';
            }

            // Build insight text
            let text = `<span class="insight-emoji">${emoji}</span>`;

            if (subsGap >= 0) {
                text += `Subscriber surplus of <span class="insight-positive">+${formatNumber(Math.abs(subsGap))}</span> `;
                text += `(<span class="insight-positive">+${Math.abs(subsGapPct).toFixed(1)}%</span> vs target). `;
            } else {
                text += `Subscriber gap of <span class="insight-negative">${formatNumber(subsGap)}</span> `;
                text += `(<span class="insight-negative">${subsGapPct.toFixed(1)}%</span> vs target). `;
            }

            text += `Conversion rate `;
            if (convVariation >= 0) {
                text += `outperforming at <span class="insight-metric">${actual.conversion.toFixed(1)}%</span> vs ${budget.conversion.toFixed(1)}% budget `;
                text += `(<span class="insight-positive">+${convVariation.toFixed(1)}%</span>). `;
            } else {
                text += `at <span class="insight-metric">${actual.conversion.toFixed(1)}%</span> vs ${budget.conversion.toFixed(1)}% budget `;
                text += `(<span class="insight-negative">${convVariation.toFixed(1)}%</span>). `;
            }

            // Analysis conclusion
            if (subsGapPct < -10 && convVariation >= 0) {
                text += `<em>Volume deficit driven by marketing deployment, not conversion efficiency.</em>`;
            } else if (subsGapPct < -10 && convVariation < 0) {
                text += `<em>Both volume and conversion need attention - review funnel optimization.</em>`;
            } else if (subsGapPct >= 0) {
                text += `<em>Strong subscriber acquisition performance exceeding targets.</em>`;
            } else {
                text += `<em>Acquisition tracking near target with stable conversion rates.</em>`;
            }

            // Update DOM
            const el = document.getElementById('subscriberAcqInsight');
            el.innerHTML = text;
            el.className = `insight-callout ${sentiment}`;
        }

        function generateUnitEconomicsInsight() {
            const insightData = getInsightData();
            if (!insightData) return;
            const { actual, budget } = insightData;

            // Calculate LTV:CAC (using simple 12-month LTV approximation)
            const ltvCacActual = actual.cac > 0 ? (actual.arpu * 12) / actual.cac : 0;
            const ltvCacBenchmark = 3.0;

            const arpuVariation = budget.arpu > 0 ? ((actual.arpu - budget.arpu) / budget.arpu) * 100 : 0;
            const cacVariation = budget.cac > 0 ? ((actual.cac - budget.cac) / budget.cac) * 100 : 0;

            // Determine sentiment
            let sentiment = 'neutral';
            let emoji = '💰';

            if (ltvCacActual >= ltvCacBenchmark && cacVariation <= 5) {
                sentiment = 'positive';
                emoji = '✅';
            } else if (ltvCacActual < 2.5 || cacVariation > 15) {
                sentiment = 'alert';
                emoji = '⚠️';
            }

            // Build insight text
            let text = `<span class="insight-emoji">${emoji}</span>`;

            text += `Unit economics `;
            if (ltvCacActual >= ltvCacBenchmark) {
                text += `<span class="insight-positive">healthy</span>: `;
            } else if (ltvCacActual >= 2.5) {
                text += `<span class="insight-neutral">acceptable</span>: `;
            } else {
                text += `<span class="insight-negative">under pressure</span>: `;
            }

            text += `LTV:CAC at <span class="insight-metric">${ltvCacActual.toFixed(2)}x</span> `;
            if (ltvCacActual >= ltvCacBenchmark) {
                text += `(<span class="insight-positive">above ${ltvCacBenchmark}x benchmark</span>). `;
            } else {
                text += `(<span class="insight-negative">below ${ltvCacBenchmark}x benchmark</span>). `;
            }

            text += `ARPU at <span class="insight-metric">$${actual.arpu.toFixed(2)}</span> `;
            text += `(<span class="${arpuVariation >= 0 ? 'insight-positive' : 'insight-negative'}">${arpuVariation >= 0 ? '+' : ''}${arpuVariation.toFixed(1)}%</span> vs budget) `;

            text += `with CAC `;
            if (cacVariation <= 0) {
                text += `controlled at <span class="insight-metric">$${actual.cac.toFixed(2)}</span>. `;
            } else {
                text += `at <span class="insight-metric">$${actual.cac.toFixed(2)}</span> (<span class="insight-negative">+${cacVariation.toFixed(1)}%</span>). `;
            }

            // Conclusion
            if (ltvCacActual >= ltvCacBenchmark && cacVariation <= 0) {
                text += `<em>Sustainable growth metrics with efficient customer acquisition.</em>`;
            } else if (ltvCacActual >= ltvCacBenchmark) {
                text += `<em>Healthy unit economics despite volume challenges.</em>`;
            } else if (cacVariation > 10) {
                text += `<em>Focus on reducing CAC to improve payback period.</em>`;
            } else {
                text += `<em>Monitor unit economics closely as scale increases.</em>`;
            }

            // Update DOM
            const el = document.getElementById('unitEconomicsInsight');
            el.innerHTML = text;
            el.className = `insight-callout ${sentiment}`;
        }

        function updateAllInsights() {
            try { generateMarketingInsight(); } catch (e) { console.error('Marketing insight error:', e); }
            try { generateSubscriberAcqInsight(); } catch (e) { console.error('Subscriber acq insight error:', e); }
            try { generateUnitEconomicsInsight(); } catch (e) { console.error('Unit economics insight error:', e); }
        }

        // ============================================
        // INITIALIZE ON PAGE LOAD
        // ============================================
        window.onload = function() {
            loadAllData();
        };

        // ============================================
        // GRANULARITY AND PERIOD SELECTION
        // ============================================
        function setGranularity(granularity) {
            currentGranularity = granularity;

            // Deactivate custom range when selecting a granularity
            customRangeActive = false;
            document.getElementById('customRangeActive').classList.remove('visible');

            // Update button styling
            document.querySelectorAll('.granularity-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update dropdown options
            updateDropdownOptions();

            // Update KPIs
            updateKPIs();

            // Update drill-down visibility
            updateQuarterDrillDown();

            // Update all charts that respond to time filters
            updateRevenueChart();
            updateEbitdaChart();
            updateOpexDonutChart();
            updateOpexTable();

            // Update dynamic insights
            updateAllInsights();
        }

        function updateDropdownOptions() {
            const dropdown = document.getElementById('periodDropdown');
            if (!dropdown) return;
            const year = currentYear;
            let options = '';

            switch(currentGranularity) {
                case 'monthly':
                    options = `
                        <option value="January">January ${year}</option>
                        <option value="February">February ${year}</option>
                        <option value="March">March ${year}</option>
                        <option value="April">April ${year}</option>
                        <option value="May">May ${year}</option>
                        <option value="June">June ${year}</option>
                        <option value="July">July ${year}</option>
                        <option value="August">August ${year}</option>
                        <option value="September">September ${year}</option>
                        <option value="October">October ${year}</option>
                        <option value="November">November ${year}</option>
                        <option value="December">December ${year}</option>
                    `;
                    // For 2026, default to January (limited data available)
                    currentPeriod = year === 2026 ? 'January' : 'December';
                    break;
                case 'quarterly':
                    options = `
                        <option value="Q1">Q1 ${year}</option>
                        <option value="Q2">Q2 ${year}</option>
                        <option value="Q3">Q3 ${year}</option>
                        <option value="Q4">Q4 ${year}</option>
                    `;
                    currentPeriod = year === 2026 ? 'Q1' : 'Q4';
                    break;
                case 'semester':
                    options = `
                        <option value="H1">H1 ${year} (Jan-Jun)</option>
                        <option value="H2">H2 ${year} (Jul-Dec)</option>
                    `;
                    currentPeriod = year === 2026 ? 'H1' : 'H2';
                    break;
                case 'yearly':
                    options = `
                        <option value="YTD">Year to Date ${year}</option>
                        <option value="YEAR">Full Year ${year}</option>
                    `;
                    currentPeriod = 'YTD';
                    break;
            }

            dropdown.innerHTML = options;
            dropdown.value = currentPeriod;
            updatePeriodIndicator();
        }

        function setPeriod(period) {
            currentPeriod = period;
            updatePeriodIndicator();
            updateKPIs();
            updateQuarterDrillDown();

            // Update all charts that respond to time filters
            updateRevenueChart();
            updateEbitdaChart();
            updateOpexDonutChart();
            updateOpexTable();

            // Update dynamic insights
            updateAllInsights();
        }

        function updatePeriodIndicator() {
            const statusPeriod = document.getElementById('statusPeriod');
            const customRangeActiveEl = document.getElementById('customRangeActive');
            const statusScenario = document.getElementById('statusScenario');
            let displayText = '';
            const year = currentYear;

            // If custom range is active, show the range
            if (customRangeActive) {
                const fromMonth = monthNames[customRangeFrom];
                const toMonth = monthNames[customRangeTo];
                if (customRangeFrom === customRangeTo) {
                    displayText = `${fromMonth} ${year}`;
                } else {
                    displayText = `${fromMonth} - ${toMonth} ${year}`;
                }
                if (customRangeActiveEl) customRangeActiveEl.classList.add('visible');
            } else {
                if (customRangeActiveEl) customRangeActiveEl.classList.remove('visible');
                switch(currentGranularity) {
                    case 'monthly':
                        displayText = currentPeriod + ' ' + year;
                        break;
                    case 'quarterly':
                        displayText = currentPeriod + ' ' + year;
                        break;
                    case 'semester':
                        displayText = currentPeriod === 'H1' ? `First Half ${year}` : `Second Half ${year}`;
                        break;
                    case 'yearly':
                        displayText = currentPeriod === 'YTD' ? `Year to Date ${year}` : `Full Year ${year}`;
                        break;
                }
            }

            // Update the period text
            if (statusPeriod) {
                statusPeriod.textContent = displayText;
            }

            // Update scenario indicator visibility for 2026
            if (statusScenario) {
                if (currentYear === 2026) {
                    statusScenario.classList.add('visible');
                    updateScenarioIndicator();
                } else {
                    statusScenario.classList.remove('visible');
                }
            }
        }

        // ============================================
        // CUSTOM RANGE FUNCTIONS
        // ============================================
        function validateRange() {
            const fromVal = parseInt(document.getElementById('rangeFrom').value);
            const toVal = parseInt(document.getElementById('rangeTo').value);
            const errorEl = document.getElementById('rangeError');
            const applyBtn = document.getElementById('applyRangeBtn');

            if (fromVal > toVal) {
                errorEl.classList.add('visible');
                applyBtn.disabled = true;
                return false;
            } else {
                errorEl.classList.remove('visible');
                applyBtn.disabled = false;
                return true;
            }
        }

        function applyCustomRange() {
            if (!validateRange()) return;

            const fromVal = parseInt(document.getElementById('rangeFrom').value);
            const toVal = parseInt(document.getElementById('rangeTo').value);

            customRangeFrom = fromVal;
            customRangeTo = toVal;
            customRangeActive = true;

            // Deactivate granularity buttons (visual indicator)
            document.querySelectorAll('.granularity-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Update UI
            updatePeriodIndicator();
            updateKPIs();
            updateQuarterDrillDown();
            updateRevenueChart();
            updateEbitdaChart();
            updateOpexDonutChart();
            updateOpexTable();
            updateAllInsights();
        }

        function resetCustomRange() {
            customRangeActive = false;
            customRangeFrom = 0;
            customRangeTo = 11;

            // Reset dropdown selections
            document.getElementById('rangeFrom').value = '0';
            document.getElementById('rangeTo').value = '11';

            // Clear error
            document.getElementById('rangeError').classList.remove('visible');
            document.getElementById('applyRangeBtn').disabled = false;

            // Re-activate yearly button and reset to YTD
            currentGranularity = 'yearly';
            currentPeriod = 'YTD';
            document.querySelectorAll('.granularity-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === 'Yearly') {
                    btn.classList.add('active');
                }
            });
            updateDropdownOptions();

            // Update all
            updatePeriodIndicator();
            updateKPIs();
            updateQuarterDrillDown();
            updateRevenueChart();
            updateEbitdaChart();
            updateOpexDonutChart();
            updateOpexTable();
            updateAllInsights();
        }

        function getCustomRangeMonths() {
            const months = [];
            for (let i = customRangeFrom; i <= customRangeTo; i++) {
                months.push(monthNames[i]);
            }
            return months;
        }

        // ============================================
        // MULTI-YEAR AND SCENARIO FUNCTIONS
        // ============================================

        /**
         * Set the active year and update UI
         */
        function setYear(year) {
            if (currentYear === year) return;

            currentYear = year;

            // Update year button styles
            document.getElementById('yearBtn2025').classList.toggle('active', year === 2025);
            document.getElementById('yearBtn2026').classList.toggle('active', year === 2026);

            // Update header subtitle
            document.getElementById('headerSubtitle').textContent = `Financial Performance ${year}`;

            // Show/hide scenario controls (new compact layout)
            const scenariosRow = document.getElementById('scenariosRow');
            const compareRow = document.getElementById('compareRow');
            const statusScenario = document.getElementById('statusScenario');

            if (year === 2026) {
                if (scenariosRow) scenariosRow.classList.add('visible');
                if (compareRow) compareRow.classList.add('visible');
                if (statusScenario) statusScenario.classList.add('visible');

                // Load 2026 data if not already loaded
                if (!data2026Loaded) {
                    load2026Data();
                } else {
                    applyYearData();
                }
            } else {
                if (scenariosRow) scenariosRow.classList.remove('visible');
                if (compareRow) compareRow.classList.remove('visible');
                if (statusScenario) statusScenario.classList.remove('visible');

                // Restore 2025 data
                restore2025Data();
            }

            // Update dropdown options for the year
            updateDropdownOptions();
            updatePeriodIndicator();
        }

        /**
         * Toggle a budget scenario
         */
        function toggleScenario(scenario) {
            scenarioStates[scenario] = !scenarioStates[scenario];

            // Update button style (works with both old and new class names)
            const btn = document.getElementById('scenario' + scenario.charAt(0).toUpperCase() + scenario.slice(1));
            if (btn) btn.classList.toggle('active', scenarioStates[scenario]);

            // Update scenario indicator text
            updateScenarioIndicator();

            // Update all visualizations
            if (currentYear === 2026) {
                updateAllChartsAndKPIs();
            }
        }

        /**
         * Toggle compare with 2025
         */
        function toggleCompareWith2025() {
            compareWith2025 = document.getElementById('compareCheckbox').checked;

            // Update all charts to show/hide 2025 comparison line
            if (currentYear === 2026) {
                updateAllChartsAndKPIs();
            }
        }

        /**
         * Update the scenario indicator text
         */
        function updateScenarioIndicator() {
            const scenarioValue = document.getElementById('statusScenarioValue');
            if (!scenarioValue) return;

            // Get active scenarios
            const activeScenarios = [];
            if (scenarioStates.conservative) activeScenarios.push('Conservative');
            if (scenarioStates.optimistic) activeScenarios.push('Optimistic');
            if (scenarioStates.pessimistic) activeScenarios.push('Pessimistic');

            if (activeScenarios.length === 0) {
                scenarioValue.textContent = 'None';
            } else if (activeScenarios.length === 1) {
                scenarioValue.textContent = activeScenarios[0];
            } else {
                scenarioValue.textContent = activeScenarios.join(', ');
            }
        }

        /**
         * Get the primary active scenario for comparisons
         */
        function getPrimaryScenario() {
            // Priority: Conservative > Optimistic > Pessimistic
            if (scenarioStates.conservative) return 'conservative';
            if (scenarioStates.optimistic) return 'optimistic';
            if (scenarioStates.pessimistic) return 'pessimistic';
            return 'conservative'; // fallback
        }

        /**
         * Load 2026 data from Google Sheets
         */
        async function load2026Data() {
            try {
                console.log('Loading 2026 data...');

                // Backup current 2025 data
                if (!data2025Backup) {
                    data2025Backup = {
                        data: JSON.parse(JSON.stringify(data)),
                        monthlyData: JSON.parse(JSON.stringify(monthlyData)),
                        monthlyBudget: JSON.parse(JSON.stringify(monthlyBudget)),
                        revenueBreakdown: JSON.parse(JSON.stringify(revenueBreakdown)),
                        opexData: JSON.parse(JSON.stringify(opexData)),
                        contributionMarginActual: [...contributionMarginActual],
                        contributionMarginBudget: [...contributionMarginBudget]
                    };
                }

                console.log('======= LOADING 2026 DATA =======');
                console.log('DATA_SOURCES_2026:', DATA_SOURCES_2026);

                // Load all 2026 data sources in parallel
                const [
                    kpiActualData,
                    kpiOptimisticData,
                    kpiConservativeData,
                    kpiPessimisticData,
                    plActualData,
                    plOptimisticData,
                    plConservativeData,
                    plPessimisticData
                ] = await Promise.all([
                    fetch(DATA_SOURCES_2026.kpiActual).then(r => r.text()),
                    fetch(DATA_SOURCES_2026.kpiBudgetOptimistic).then(r => r.text()),
                    fetch(DATA_SOURCES_2026.kpiBudgetConservative).then(r => r.text()),
                    fetch(DATA_SOURCES_2026.kpiBudgetPessimistic).then(r => r.text()),
                    fetch(DATA_SOURCES_2026.plActual).then(r => r.text()),
                    fetch(DATA_SOURCES_2026.plBudgetOptimistic).then(r => r.text()),
                    fetch(DATA_SOURCES_2026.plBudgetConservative).then(r => r.text()),
                    fetch(DATA_SOURCES_2026.plBudgetPessimistic).then(r => r.text())
                ]);

                console.log('Fetched KPI Actual data length:', kpiActualData ? kpiActualData.length : 'NULL');
                console.log('Fetched KPI Optimistic data length:', kpiOptimisticData ? kpiOptimisticData.length : 'NULL');
                console.log('First 500 chars of KPI Actual:', kpiActualData ? kpiActualData.substring(0, 500) : 'NULL');

                // Parse KPI data for each scenario
                // Note: KPIs Actual uses specific row indices, Budget uses same structure
                console.log('--- Parsing KPI Actual ---');
                data2026.actual.monthlyData = parseKPIData(kpiActualData, 'actual');
                console.log('--- Parsing KPI Optimistic ---');
                data2026.optimistic.monthlyBudget = parseKPIData(kpiOptimisticData, 'budget');
                console.log('--- Parsing KPI Conservative ---');
                data2026.conservative.monthlyBudget = parseKPIData(kpiConservativeData, 'budget');
                console.log('--- Parsing KPI Pessimistic ---');
                data2026.pessimistic.monthlyBudget = parseKPIData(kpiPessimisticData, 'budget');

                // Parse P&L data for each scenario
                parse2026PLData(plActualData, 'actual');
                parse2026PLData(plOptimisticData, 'optimistic');
                parse2026PLData(plConservativeData, 'conservative');
                parse2026PLData(plPessimisticData, 'pessimistic');

                // Aggregate quarterly/yearly data
                aggregate2026Data();

                data2026Loaded = true;
                console.log('======= 2026 DATA LOADED SUCCESSFULLY =======');
                console.log('data2026.actual.monthlyData:', data2026.actual.monthlyData);
                console.log('data2026.conservative.monthlyBudget:', data2026.conservative.monthlyBudget);

                // Apply 2026 data to current view
                applyYearData();

            } catch (error) {
                console.error('Error loading 2026 data:', error);
                alert('Error loading 2026 data. Please check console for details.');
            }
        }

        /**
         * Parse KPI CSV data into monthly structure
         *
         * KPIs_2026_ACTUAL row mapping (0-based index):
         * - Row 2 (idx 1): Marketing Spend
         * - Row 5 (idx 4): Signups (New Users)
         * - Row 6 (idx 5): CPNU
         * - Row 7 (idx 6): FTs Started (Trials Started)
         * - Row 9 (idx 8): FTs Converted (Trials Converted)
         * - Row 11 (idx 10): CAC
         * - Row 12 (idx 11): New Subscriptions
         * - Row 18 (idx 17): Conversion Rate
         * - Row 21 (idx 20): ARPU
         * - Row 42 (idx 41): LTV (LTR)
         * - Row 43 (idx 42): Churn Rate
         *
         * KPIs_2026_BUDGET row mapping (0-based index):
         * - Row 3 (idx 2): Marketing Spend
         * - Row 4 (idx 3): CPNU
         * - Row 5 (idx 4): Signups (New Users)
         * - Row 6 (idx 5): Conversion Rate
         * - Row 7 (idx 6): New Subscriptions
         * - Row 8 (idx 7): CAC
         * - Row 15 (idx 14): ARPU
         * - Row 16 (idx 15): Ticket vs CA
         * - Row 18 (idx 17): LTV/CAC (LTR/CAC)
         */
        function parseKPIData(csvText, scenario = 'actual') {
            console.log('=== parseKPIData called ===');
            console.log('Scenario:', scenario);
            console.log('CSV text length:', csvText ? csvText.length : 'NULL');

            const parsed = parseCSV(csvText);
            console.log('Parsed rows count:', parsed ? parsed.length : 'NULL');

            // Debug: show first few rows
            if (parsed && parsed.length > 0) {
                console.log('First 5 rows of parsed data:');
                for (let r = 0; r < Math.min(5, parsed.length); r++) {
                    console.log(`Row ${r}:`, parsed[r]);
                }
            }

            const monthlyKPIs = {};

            // Different row indices for Actual vs Budget
            let rowIndices;

            if (scenario === 'actual') {
                // KPIs_2026_ACTUAL row mapping
                rowIndices = {
                    spend: 1,           // Row 2: Marketing Spend
                    signups: 4,         // Row 5: Signups (New Users)
                    cpnu: 5,            // Row 6: CPNU
                    trialsStarted: 6,   // Row 7: FTs Started
                    trialsConverted: 8, // Row 9: FTs Converted
                    cac: 10,            // Row 11: CAC
                    subs: 11,           // Row 12: New Subscriptions
                    conversion: 17,     // Row 18: Conversion Rate
                    arpu: 20,           // Row 21: ARPU
                    ltv: 41,            // Row 42: LTV (LTR)
                    churn: 42,          // Row 43: Churn Rate
                    ltvCac: null        // Will be calculated from ltv/cac
                };
            } else {
                // KPIs_2026_BUDGET row mapping (Optimistic/Conservative/Pessimistic)
                rowIndices = {
                    spend: 2,           // Row 3: Marketing Spend
                    cpnu: 3,            // Row 4: CPNU
                    signups: 4,         // Row 5: Signups (New Users)
                    conversion: 5,      // Row 6: Conversion Rate
                    subs: 6,            // Row 7: New Subscriptions
                    cac: 7,             // Row 8: CAC
                    arpu: 14,           // Row 15: ARPU
                    ticketVsCA: 15,     // Row 16: Ticket vs CA
                    ltvCac: 17,         // Row 18: LTV/CAC (LTR/CAC)
                    // These don't exist in Budget
                    trialsStarted: null,
                    trialsConverted: null,
                    ltv: null,
                    churn: null
                };
            }

            // Extract monthly values (Column B = index 1 for January, etc.)
            monthNames.forEach((month, i) => {
                const colIdx = i + 1; // Column B is index 1

                // Debug spend specifically
                if (i === 0) { // January only
                    console.log('=== DEBUG SPEND for', scenario, '===');
                    console.log('rowIndices.spend:', rowIndices.spend);
                    console.log('parsed[rowIndices.spend]:', parsed[rowIndices.spend]);
                    console.log('colIdx:', colIdx);
                    if (parsed[rowIndices.spend]) {
                        console.log('parsed[rowIndices.spend][colIdx]:', parsed[rowIndices.spend][colIdx]);
                        console.log('Raw value type:', typeof parsed[rowIndices.spend][colIdx]);
                    }
                }

                const spend = rowIndices.spend !== null && parsed[rowIndices.spend] ? parseNumber(parsed[rowIndices.spend][colIdx]) : 0;
                const signups = rowIndices.signups !== null && parsed[rowIndices.signups] ? parseNumber(parsed[rowIndices.signups][colIdx]) : 0;
                const cpnu = rowIndices.cpnu !== null && parsed[rowIndices.cpnu] ? parseNumber(parsed[rowIndices.cpnu][colIdx]) : 0;
                const trialsStarted = rowIndices.trialsStarted !== null && parsed[rowIndices.trialsStarted] ? parseNumber(parsed[rowIndices.trialsStarted][colIdx]) : 0;
                const trialsConverted = rowIndices.trialsConverted !== null && parsed[rowIndices.trialsConverted] ? parseNumber(parsed[rowIndices.trialsConverted][colIdx]) : 0;
                const cac = rowIndices.cac !== null && parsed[rowIndices.cac] ? parseNumber(parsed[rowIndices.cac][colIdx]) : 0;
                const subs = rowIndices.subs !== null && parsed[rowIndices.subs] ? parseNumber(parsed[rowIndices.subs][colIdx]) : 0;
                const conversion = rowIndices.conversion !== null && parsed[rowIndices.conversion] ? parseNumber(parsed[rowIndices.conversion][colIdx]) : 0;
                const arpu = rowIndices.arpu !== null && parsed[rowIndices.arpu] ? parseNumber(parsed[rowIndices.arpu][colIdx]) : 0;
                const ltv = rowIndices.ltv !== null && parsed[rowIndices.ltv] ? parseNumber(parsed[rowIndices.ltv][colIdx]) : 0;
                const churn = rowIndices.churn !== null && parsed[rowIndices.churn] ? parseNumber(parsed[rowIndices.churn][colIdx]) : 0;

                // LTV/CAC: read directly from Budget, calculate for Actual
                let ltvCac;
                if (scenario === 'actual') {
                    // Calculate from LTV and CAC
                    ltvCac = cac > 0 ? ltv / cac : 0;
                } else {
                    // Read directly from Budget row 18
                    ltvCac = rowIndices.ltvCac !== null && parsed[rowIndices.ltvCac] ? parseNumber(parsed[rowIndices.ltvCac][colIdx]) : 0;
                }

                monthlyKPIs[month] = {
                    spend: spend,
                    signups: signups,
                    cpnu: cpnu,
                    trialsStarted: trialsStarted,
                    trialsConverted: trialsConverted,
                    cac: cac,
                    subs: subs,
                    conversion: conversion,
                    arpu: arpu,
                    ltv: ltv,
                    churn: churn,
                    ltvCac: ltvCac,
                    // These will be populated from P&L data
                    revenue: 0,
                    ebitda: 0,
                    burnRate: 0
                };

                // Debug: log January data
                if (month === 'January') {
                    console.log(`=== ${scenario} January KPIs ===`);
                    console.log('spend:', spend, '| signups:', signups, '| cpnu:', cpnu);
                    console.log('subs:', subs, '| cac:', cac, '| arpu:', arpu);
                    console.log('conversion:', conversion, '| ltvCac:', ltvCac);
                }
            });

            console.log('=== parseKPIData complete for', scenario, '===');
            console.log('Monthly KPIs keys:', Object.keys(monthlyKPIs));

            return monthlyKPIs;
        }

        /**
         * Parse P&L data for 2026
         *
         * P&L BUDGET (Optimistic/Conservative/Pessimistic) row mapping:
         * Revenue:
         * - Row 4 (idx 3): Subscriptions IOS
         * - Row 5 (idx 4): Subscriptions aOS
         * - Row 6 (idx 5): Off App Sales
         * - Row 7 (idx 6): Partnerships
         * Marketing:
         * - Row 18 (idx 17): Marketing Spend (Meta)
         * - Row 19 (idx 18): Marketing Spend (Others)
         * Margins:
         * - Row 21 (idx 20): Contribution Margin
         * Operating Expenses:
         * - Row 14 (idx 13): Servers
         * - Row 34 (idx 33): Salaries & Wages
         * - Row 35 (idx 34): External Services
         * - Row 36 (idx 35): Travel Expenses
         * - Row 37 (idx 36): Services
         * - Row 38 (idx 37): Other
         * - Row 39 (idx 38): CAPEX
         * Profit:
         * - Row 27 (idx 26): Operating Profit
         * - Row 30 (idx 29): Net Income
         *
         * P&L ACTUAL row mapping:
         * Revenue:
         * - Row 9 (idx 8): Subscription Sales (total)
         * - Row 36 (idx 35): Subscription IOS (detail)
         * - Row 37 (idx 36): Subscription aOS (detail)
         * - Row 10 (idx 9): Off App Sales
         * - Row 11 (idx 10): Partnerships
         * - Row 14 (idx 13): Gross Revenue
         * - Row 16 (idx 15): Net Revenue
         * Marketing:
         * - Row 18 (idx 17): Marketing Spend (Meta)
         * - Row 19 (idx 18): Marketing Spend (Others)
         * Margins:
         * - Row 21 (idx 20): Contribution Margin
         * Operating Expenses:
         * - Row 15 (idx 14): Servers
         * - Row 23 (idx 22): Salaries
         * - Row 24 (idx 23): External Services
         * - Row 25 (idx 24): Travel
         * - Row 26 (idx 25): Services
         * - Row 27 (idx 26): Others
         * - Row 38 (idx 37): CAPEX
         * Profit:
         * - Row 33 (idx 32): Operating Profit (EBIT)
         * - Row 36 (idx 35): Net Income (Cash Flow before taxes)
         */
        function parse2026PLData(csvText, scenario) {
            const parsed = parseCSV(csvText);

            // Get the correct monthly data object
            let targetMonthlyData;
            if (scenario === 'actual') {
                targetMonthlyData = data2026.actual.monthlyData;
            } else {
                targetMonthlyData = data2026[scenario].monthlyBudget;
            }

            // Initialize revenue breakdown storage
            if (!data2026[scenario === 'actual' ? 'actual' : scenario].revenueBreakdown) {
                data2026[scenario === 'actual' ? 'actual' : scenario].revenueBreakdown = {
                    actual: { subscriptions: {}, subscriptionsIOS: {}, subscriptionsAOS: {}, offapp: {}, partnership: {} },
                    budget: { subscriptions: {}, subscriptionsIOS: {}, subscriptionsAOS: {}, offapp: {}, partnership: {} }
                };
            }

            // Initialize OpEx totals for yearly aggregation
            let opexTotals = {
                servers: 0,
                salaries: 0,
                externalServices: 0,
                travel: 0,
                services: 0,
                other: 0,
                capex: 0
            };

            // Process each month
            monthNames.forEach((month, i) => {
                // P&L ACTUAL (P&L_2026_CASH) has data starting in column D (index 3)
                // P&L BUDGET files have data starting in column B (index 1)
                const colIdx = scenario === 'actual' ? i + 3 : i + 1;

                if (!targetMonthlyData[month]) {
                    targetMonthlyData[month] = {};
                }

                if (scenario === 'actual') {
                    // P&L_2026_CASH row indices (0-indexed from CSV)
                    // Row 9 (idx 8): Subscriptions App
                    // Row 10 (idx 9): Subscriptions Off App
                    // Row 11 (idx 10): Other Revenue/Partnerships
                    // Row 13 (idx 12): Gross Revenue
                    // Row 14 (idx 13): Comissions
                    // Row 15 (idx 14): Servers
                    // Row 16 (idx 15): Net Revenue
                    // Row 18 (idx 17): Marketing Spend (meta)
                    // Row 19 (idx 18): Marketing Spend (others)
                    // Row 21 (idx 20): Contribution Margin
                    // Row 23 (idx 22): Salaries & Wages
                    // Row 24 (idx 23): External Services
                    // Row 25 (idx 24): Travel expenses
                    // Row 26 (idx 25): Services
                    // Row 27 (idx 26): Other
                    // Row 30 (idx 29): EBITDA
                    // Row 33 (idx 32): EBIT
                    // Row 36 (idx 35): Cash Flow (before taxes)
                    // Row 38 (idx 37): Investments/CAPEX
                    // Row 41 (idx 40): Subscriptions IOS
                    // Row 42 (idx 41): Subscriptions aOS

                    const subsTotal = parsed[8] ? parseNumber(parsed[8][colIdx]) : 0;     // Subscriptions App
                    const subsIOS = parsed[40] ? parseNumber(parsed[40][colIdx]) : 0;     // Subscriptions IOS
                    const subsAOS = parsed[41] ? parseNumber(parsed[41][colIdx]) : 0;     // Subscriptions aOS
                    const offApp = parsed[9] ? parseNumber(parsed[9][colIdx]) : 0;        // Subscriptions Off App
                    const partnership = parsed[10] ? parseNumber(parsed[10][colIdx]) : 0; // Other Revenue/Partnerships
                    const grossRevenue = parsed[12] ? parseNumber(parsed[12][colIdx]) : 0; // Gross Revenue
                    const netRevenue = parsed[15] ? parseNumber(parsed[15][colIdx]) : 0;   // Net Revenue

                    // Marketing (values are negative in P&L, take absolute)
                    const mktMeta = Math.abs(parsed[17] ? parseNumber(parsed[17][colIdx]) : 0);    // Marketing Spend (meta)
                    const mktOthers = Math.abs(parsed[18] ? parseNumber(parsed[18][colIdx]) : 0);  // Marketing Spend (others)

                    // Contribution Margin
                    const contributionMargin = parsed[20] ? parseNumber(parsed[20][colIdx]) : 0;

                    // Operating Expenses (values may be negative, take absolute)
                    const servers = Math.abs(parsed[14] ? parseNumber(parsed[14][colIdx]) : 0);      // Servers
                    const salaries = Math.abs(parsed[22] ? parseNumber(parsed[22][colIdx]) : 0);     // Salaries & Wages
                    const extServices = Math.abs(parsed[23] ? parseNumber(parsed[23][colIdx]) : 0);  // External Services
                    const travel = Math.abs(parsed[24] ? parseNumber(parsed[24][colIdx]) : 0);       // Travel expenses
                    const services = Math.abs(parsed[25] ? parseNumber(parsed[25][colIdx]) : 0);     // Services
                    const other = Math.abs(parsed[26] ? parseNumber(parsed[26][colIdx]) : 0);        // Other
                    const capex = Math.abs(parsed[37] ? parseNumber(parsed[37][colIdx]) : 0);        // Investments/CAPEX

                    // Profit
                    const ebitda = parsed[29] ? parseNumber(parsed[29][colIdx]) : 0;           // EBITDA
                    const operatingProfit = parsed[32] ? parseNumber(parsed[32][colIdx]) : 0;  // EBIT
                    const cashFlow = parsed[35] ? parseNumber(parsed[35][colIdx]) : 0;         // Cash Flow (before taxes)

                    // Store in monthly data (ACTUAL)
                    targetMonthlyData[month].subscriptions = subsTotal;
                    targetMonthlyData[month].subscriptionsIOS = subsIOS;
                    targetMonthlyData[month].subscriptionsAOS = subsAOS;
                    targetMonthlyData[month].offapp = offApp;
                    targetMonthlyData[month].partnership = partnership;
                    targetMonthlyData[month].revenue = grossRevenue || (subsTotal + offApp + partnership);
                    targetMonthlyData[month].netRevenue = netRevenue;

                    targetMonthlyData[month].mktSpendMeta = mktMeta;
                    targetMonthlyData[month].mktSpendOthers = mktOthers;
                    // Only set spend from P&L if not already set by KPI data
                    if (!targetMonthlyData[month].spend || targetMonthlyData[month].spend === 0) {
                        targetMonthlyData[month].spend = mktMeta + mktOthers;
                    }

                    targetMonthlyData[month].contributionMargin = contributionMargin;

                    targetMonthlyData[month].servers = servers;
                    targetMonthlyData[month].salaries = salaries;
                    targetMonthlyData[month].externalServices = extServices;
                    targetMonthlyData[month].travel = travel;
                    targetMonthlyData[month].services = services;
                    targetMonthlyData[month].otherOpex = other;
                    targetMonthlyData[month].capex = capex;

                    targetMonthlyData[month].operatingProfit = operatingProfit;
                    targetMonthlyData[month].ebitda = ebitda;
                    targetMonthlyData[month].netIncome = cashFlow;
                    targetMonthlyData[month].burnRate = Math.abs(cashFlow);

                    // Accumulate OpEx totals
                    opexTotals.servers += servers;
                    opexTotals.salaries += salaries;
                    opexTotals.externalServices += extServices;
                    opexTotals.travel += travel;
                    opexTotals.services += services;
                    opexTotals.other += other;
                    opexTotals.capex += capex;

                } else {
                    // P&L BUDGET row indices (Optimistic/Conservative/Pessimistic)
                    const subsIOS = parsed[3] ? parseNumber(parsed[3][colIdx]) : 0;      // Row 4: Subscriptions IOS
                    const subsAOS = parsed[4] ? parseNumber(parsed[4][colIdx]) : 0;      // Row 5: Subscriptions aOS
                    const subsTotal = subsIOS + subsAOS;
                    const offApp = parsed[5] ? parseNumber(parsed[5][colIdx]) : 0;       // Row 6: Off App Sales
                    const partnership = parsed[6] ? parseNumber(parsed[6][colIdx]) : 0;  // Row 7: Partnerships

                    // Marketing
                    const mktMeta = parsed[17] ? parseNumber(parsed[17][colIdx]) : 0;    // Row 18: Marketing Meta
                    const mktOthers = parsed[18] ? parseNumber(parsed[18][colIdx]) : 0;  // Row 19: Marketing Others

                    // Contribution Margin
                    const contributionMargin = parsed[20] ? parseNumber(parsed[20][colIdx]) : 0; // Row 21

                    // Operating Expenses
                    const servers = parsed[13] ? parseNumber(parsed[13][colIdx]) : 0;    // Row 14: Servers
                    const salaries = parsed[33] ? parseNumber(parsed[33][colIdx]) : 0;   // Row 34: Salaries
                    const extServices = parsed[34] ? parseNumber(parsed[34][colIdx]) : 0; // Row 35: External Services
                    const travel = parsed[35] ? parseNumber(parsed[35][colIdx]) : 0;     // Row 36: Travel
                    const services = parsed[36] ? parseNumber(parsed[36][colIdx]) : 0;   // Row 37: Services
                    const other = parsed[37] ? parseNumber(parsed[37][colIdx]) : 0;      // Row 38: Other
                    const capex = parsed[38] ? parseNumber(parsed[38][colIdx]) : 0;      // Row 39: CAPEX

                    // Profit
                    const operatingProfit = parsed[26] ? parseNumber(parsed[26][colIdx]) : 0; // Row 27: Operating Profit
                    const netIncome = parsed[29] ? parseNumber(parsed[29][colIdx]) : 0;       // Row 30: Net Income

                    // Store in monthly data (BUDGET)
                    targetMonthlyData[month].subscriptions = subsTotal;
                    targetMonthlyData[month].subscriptionsIOS = subsIOS;
                    targetMonthlyData[month].subscriptionsAOS = subsAOS;
                    targetMonthlyData[month].offapp = offApp;
                    targetMonthlyData[month].partnership = partnership;
                    targetMonthlyData[month].revenue = subsTotal + offApp + partnership;

                    targetMonthlyData[month].mktSpendMeta = mktMeta;
                    targetMonthlyData[month].mktSpendOthers = mktOthers;
                    // Only set spend from P&L if not already set by KPI data
                    if (!targetMonthlyData[month].spend || targetMonthlyData[month].spend === 0) {
                        targetMonthlyData[month].spend = mktMeta + mktOthers;
                    }

                    targetMonthlyData[month].contributionMargin = contributionMargin;

                    targetMonthlyData[month].servers = servers;
                    targetMonthlyData[month].salaries = salaries;
                    targetMonthlyData[month].externalServices = extServices;
                    targetMonthlyData[month].travel = travel;
                    targetMonthlyData[month].services = services;
                    targetMonthlyData[month].otherOpex = other;
                    targetMonthlyData[month].capex = capex;

                    targetMonthlyData[month].operatingProfit = operatingProfit;
                    targetMonthlyData[month].ebitda = netIncome;
                    targetMonthlyData[month].netIncome = netIncome;
                    targetMonthlyData[month].burnRate = Math.abs(netIncome);

                    // Accumulate OpEx totals
                    opexTotals.servers += servers;
                    opexTotals.salaries += salaries;
                    opexTotals.externalServices += extServices;
                    opexTotals.travel += travel;
                    opexTotals.services += services;
                    opexTotals.other += other;
                    opexTotals.capex += capex;
                }

                // Aggregate into quarterly revenue breakdown
                const quarterIdx = Math.floor(i / 3);
                const quarters = ['Q1', 'Q2', 'Q3', 'Q4'];
                const q = quarters[quarterIdx];
                const targetBreakdown = scenario === 'actual'
                    ? data2026.actual.revenueBreakdown.actual
                    : data2026[scenario].revenueBreakdown.budget;

                if (!targetBreakdown.subscriptions[q]) targetBreakdown.subscriptions[q] = 0;
                if (!targetBreakdown.subscriptionsIOS[q]) targetBreakdown.subscriptionsIOS[q] = 0;
                if (!targetBreakdown.subscriptionsAOS[q]) targetBreakdown.subscriptionsAOS[q] = 0;
                if (!targetBreakdown.offapp[q]) targetBreakdown.offapp[q] = 0;
                if (!targetBreakdown.partnership[q]) targetBreakdown.partnership[q] = 0;

                targetBreakdown.subscriptions[q] += targetMonthlyData[month].subscriptions || 0;
                targetBreakdown.subscriptionsIOS[q] += targetMonthlyData[month].subscriptionsIOS || 0;
                targetBreakdown.subscriptionsAOS[q] += targetMonthlyData[month].subscriptionsAOS || 0;
                targetBreakdown.offapp[q] += targetMonthlyData[month].offapp || 0;
                targetBreakdown.partnership[q] += targetMonthlyData[month].partnership || 0;
            });

            // Store OpEx data for charts
            const targetScenario = scenario === 'actual' ? data2026.actual : data2026[scenario];
            targetScenario.opexData = [
                { category: 'Servers', budget: opexTotals.servers, actual: opexTotals.servers },
                { category: 'Salaries & Wages', budget: opexTotals.salaries, actual: opexTotals.salaries },
                { category: 'External Services', budget: opexTotals.externalServices, actual: opexTotals.externalServices },
                { category: 'Travel', budget: opexTotals.travel, actual: opexTotals.travel },
                { category: 'Services', budget: opexTotals.services, actual: opexTotals.services },
                { category: 'Other', budget: opexTotals.other, actual: opexTotals.other },
                { category: 'CAPEX', budget: opexTotals.capex, actual: opexTotals.capex }
            ];
        }

        /**
         * Aggregate 2026 monthly data into quarterly and yearly
         */
        function aggregate2026Data() {
            const scenarios = ['actual', 'optimistic', 'conservative', 'pessimistic'];

            scenarios.forEach(scenario => {
                const sourceData = scenario === 'actual' ? data2026.actual.monthlyData : data2026[scenario].monthlyBudget;
                const targetData = scenario === 'actual' ? data2026.actual : data2026[scenario];

                if (!targetData.real) targetData.real = {};
                if (!targetData.budget) targetData.budget = {};

                // Aggregate quarters
                ['Q1', 'Q2', 'Q3', 'Q4'].forEach(q => {
                    const qMonths = quarterMonths[q];
                    let qData = { revenue: 0, ebitda: 0, subs: 0, spend: 0, arpu: 0, cac: 0, conversion: 0, ltvCac: 0, burnRate: 0 };
                    let count = 0;

                    qMonths.forEach(m => {
                        if (sourceData[m] && (sourceData[m].revenue || sourceData[m].subs)) {
                            qData.revenue += sourceData[m].revenue || 0;
                            qData.ebitda += sourceData[m].ebitda || 0;
                            qData.subs += sourceData[m].subs || 0;
                            qData.spend += sourceData[m].spend || 0;
                            qData.arpu += sourceData[m].arpu || 0;
                            qData.cac += sourceData[m].cac || 0;
                            qData.conversion += sourceData[m].conversion || 0;
                            qData.ltvCac += sourceData[m].ltvCac || 0;
                            count++;
                        }
                    });

                    // Average rate-based metrics
                    if (count > 0) {
                        qData.arpu = qData.arpu / count;
                        qData.cac = qData.cac / count;
                        qData.conversion = qData.conversion / count;
                        qData.ltvCac = qData.ltvCac / count;
                    }
                    qData.burnRate = Math.abs(qData.ebitda);

                    if (scenario === 'actual') {
                        targetData.real[q] = qData;
                    } else {
                        targetData.budget[q] = qData;
                    }
                });

                // Aggregate semesters
                ['H1', 'H2'].forEach(h => {
                    const hMonths = h === 'H1'
                        ? ['January', 'February', 'March', 'April', 'May', 'June']
                        : ['July', 'August', 'September', 'October', 'November', 'December'];

                    let hData = { revenue: 0, ebitda: 0, subs: 0, spend: 0, arpu: 0, cac: 0, conversion: 0, ltvCac: 0, burnRate: 0 };
                    let count = 0;

                    hMonths.forEach(m => {
                        if (sourceData[m] && (sourceData[m].revenue || sourceData[m].subs)) {
                            hData.revenue += sourceData[m].revenue || 0;
                            hData.ebitda += sourceData[m].ebitda || 0;
                            hData.subs += sourceData[m].subs || 0;
                            hData.spend += sourceData[m].spend || 0;
                            hData.arpu += sourceData[m].arpu || 0;
                            hData.cac += sourceData[m].cac || 0;
                            hData.conversion += sourceData[m].conversion || 0;
                            hData.ltvCac += sourceData[m].ltvCac || 0;
                            count++;
                        }
                    });

                    if (count > 0) {
                        hData.arpu = hData.arpu / count;
                        hData.cac = hData.cac / count;
                        hData.conversion = hData.conversion / count;
                        hData.ltvCac = hData.ltvCac / count;
                    }
                    hData.burnRate = Math.abs(hData.ebitda);

                    if (scenario === 'actual') {
                        targetData.real[h] = hData;
                    } else {
                        targetData.budget[h] = hData;
                    }
                });

                // Aggregate yearly
                let yearData = { revenue: 0, ebitda: 0, subs: 0, spend: 0, arpu: 0, cac: 0, conversion: 0, ltvCac: 0, burnRate: 0 };
                let count = 0;

                monthNames.forEach(m => {
                    if (sourceData[m] && (sourceData[m].revenue || sourceData[m].subs)) {
                        yearData.revenue += sourceData[m].revenue || 0;
                        yearData.ebitda += sourceData[m].ebitda || 0;
                        yearData.subs += sourceData[m].subs || 0;
                        yearData.spend += sourceData[m].spend || 0;
                        yearData.arpu += sourceData[m].arpu || 0;
                        yearData.cac += sourceData[m].cac || 0;
                        yearData.conversion += sourceData[m].conversion || 0;
                        yearData.ltvCac += sourceData[m].ltvCac || 0;
                        count++;
                    }
                });

                if (count > 0) {
                    yearData.arpu = yearData.arpu / count;
                    yearData.cac = yearData.cac / count;
                    yearData.conversion = yearData.conversion / count;
                    yearData.ltvCac = yearData.ltvCac / count;
                }
                yearData.burnRate = Math.abs(yearData.ebitda);

                if (scenario === 'actual') {
                    targetData.real['YEAR'] = yearData;
                } else {
                    targetData.budget['YEAR'] = yearData;
                }
            });
        }

        /**
         * Apply 2026 data to the current view
         */
        function applyYearData() {
            console.log('======= applyYearData called =======');
            console.log('currentYear:', currentYear);

            if (currentYear !== 2026) {
                console.log('Not 2026, returning');
                return;
            }

            // Get primary scenario for budget comparison
            const primaryScenario = getPrimaryScenario();
            console.log('Primary scenario:', primaryScenario);

            // Set monthlyData to 2026 actual
            monthlyData = data2026.actual.monthlyData;
            console.log('monthlyData set to data2026.actual.monthlyData');
            console.log('monthlyData January:', monthlyData?.January);

            // Set monthlyBudget to primary scenario
            monthlyBudget = data2026[primaryScenario].monthlyBudget;
            console.log('monthlyBudget set to data2026[' + primaryScenario + '].monthlyBudget');
            console.log('monthlyBudget January:', monthlyBudget?.January);

            // Set aggregated data
            data.real = data2026.actual.real;
            data.budget = data2026[primaryScenario].budget;
            console.log('data.real:', data.real);
            console.log('data.budget:', data.budget);

            // Update all visualizations
            console.log('Calling updateAllChartsAndKPIs...');
            updateAllChartsAndKPIs();
        }

        /**
         * Restore 2025 data
         */
        function restore2025Data() {
            if (!data2025Backup) return;

            data = data2025Backup.data;
            monthlyData = data2025Backup.monthlyData;
            monthlyBudget = data2025Backup.monthlyBudget;
            revenueBreakdown = data2025Backup.revenueBreakdown;
            opexData = data2025Backup.opexData;
            contributionMarginActual = data2025Backup.contributionMarginActual;
            contributionMarginBudget = data2025Backup.contributionMarginBudget;

            // Update all visualizations
            updateAllChartsAndKPIs();
        }

        /**
         * Update all charts and KPIs
         */
        function updateAllChartsAndKPIs() {
            updateKPIs();
            updateQuarterDrillDown();
            updateRevenueChart();
            updateEbitdaChart();
            updateOpexDonutChart();
            updateOpexTable();
            updateAllInsights();
            updateContributionMarginChart();
            // Update KPI charts (Marketing, Subscriber Acquisition, Unit Economics)
            if (charts.marketing) updateMarketingChart();
            if (charts.subscriberAcquisition) updateSubscriberAcquisitionChart();
            if (charts.unitEconomics) updateUnitEconomicsChart();
        }

        /**
         * Update contribution margin chart if it exists
         */
        function updateContributionMarginChart() {
            if (charts.contributionMargin) {
                // Recalculate contribution margin for current year
                const actualData = monthNames.map(m => (monthlyData[m]?.revenue || 0) / 1000);
                const budgetData = monthNames.map(m => (monthlyBudget[m]?.revenue || 0) / 1000);

                charts.contributionMargin.data.datasets[0].data = actualData;
                charts.contributionMargin.data.datasets[1].data = budgetData;
                charts.contributionMargin.update();
            }
        }

        // ============================================
        // KPI UPDATES
        // ============================================
        function getDataForPeriod() {
            console.log('======= getDataForPeriod called =======');
            console.log('currentGranularity:', currentGranularity);
            console.log('currentPeriod:', currentPeriod);
            console.log('customRangeActive:', customRangeActive);
            console.log('monthlyData available:', !!monthlyData);
            console.log('monthlyBudget available:', !!monthlyBudget);
            console.log('data.real available:', !!data?.real);
            console.log('data.budget available:', !!data?.budget);

            let real, budget;

            // Default empty structure for safety
            const emptyData = { revenue: 0, ebitda: 0, subs: 0, spend: 0, arpu: 0, cac: 0, conversion: 0, ltvCac: 0, burnRate: 0 };

            // Handle custom range
            if (customRangeActive) {
                const months = getCustomRangeMonths();
                real = aggregateMonthlyData(months, monthlyData);
                budget = aggregateMonthlyData(months, monthlyBudget);
                console.log('Using custom range');
            } else if (currentGranularity === 'monthly') {
                real = monthlyData?.[currentPeriod];
                budget = monthlyBudget?.[currentPeriod];
                console.log('Using monthly data for', currentPeriod);
                console.log('monthlyData[' + currentPeriod + ']:', real);
                console.log('monthlyBudget[' + currentPeriod + ']:', budget);
            } else if (currentGranularity === 'quarterly') {
                real = data?.real?.[currentPeriod];
                budget = data?.budget?.[currentPeriod];
                console.log('Using quarterly data for', currentPeriod);
            } else if (currentGranularity === 'semester') {
                real = data?.real?.[currentPeriod];
                budget = data?.budget?.[currentPeriod];
                console.log('Using semester data');
            } else {
                // yearly - use YEAR data for both YTD and YEAR (same at end of year)
                real = data?.real?.['YEAR'];
                budget = data?.budget?.['YEAR'];
                console.log('Using yearly data');
                console.log('data.real.YEAR:', real);
                console.log('data.budget.YEAR:', budget);
            }

            console.log('Final real:', real);
            console.log('Final budget:', budget);

            // Ensure we always return valid objects with all required properties
            return {
                real: real ? { ...emptyData, ...real } : emptyData,
                budget: budget ? { ...emptyData, ...budget } : emptyData
            };
        }

        // Helper function to aggregate monthly data for custom range
        function aggregateMonthlyData(months, dataSource) {
            let totalRevenue = 0, totalEbitda = 0, totalSubs = 0, totalSpend = 0;
            let totalArpu = 0, totalCac = 0, totalConv = 0, totalLtvCac = 0;
            let count = 0;

            for (const month of months) {
                if (dataSource[month]) {
                    const d = dataSource[month];
                    totalRevenue += d.revenue || 0;
                    totalEbitda += d.ebitda || 0;
                    totalSubs += d.subs || 0;
                    totalSpend += d.spend || 0;
                    totalArpu += d.arpu || 0;
                    totalCac += d.cac || 0;
                    totalConv += d.conversion || 0;
                    totalLtvCac += d.ltvCac || 0;
                    count++;
                }
            }

            return {
                revenue: totalRevenue,
                ebitda: totalEbitda,
                subs: totalSubs,
                spend: totalSpend,
                arpu: count > 0 ? totalArpu / count : 0,
                cac: count > 0 ? totalCac / count : 0,
                conversion: count > 0 ? totalConv / count : 0,
                ltvCac: count > 0 ? totalLtvCac / count : 0,
                burnRate: Math.abs(totalEbitda)
            };
        }

        function updateKPIs() {
            console.log('======= updateKPIs called =======');
            const { real, budget } = getDataForPeriod();
            console.log('getDataForPeriod returned:');
            console.log('real:', real);
            console.log('budget:', budget);

            const kpiGrid = document.getElementById('consolidatedKPIs');
            if (!kpiGrid) return;

            // Helper function to safely calculate variance percentage
            const safeVariance = (actual, budgetVal) => {
                if (!budgetVal || budgetVal === 0) return 0;
                return ((actual - budgetVal) / budgetVal * 100);
            };

            // Calculate variances with safe division
            const revenueVar = safeVariance(real.revenue, budget.revenue);
            const subsVar = safeVariance(real.subs, budget.subs);
            const cacVar = safeVariance(real.cac, budget.cac);
            const arpuVar = safeVariance(real.arpu, budget.arpu);
            const ebitdaVar = real.ebitda - budget.ebitda;
            const ltvCacVar = safeVariance(real.ltvCac, budget.ltvCac);
            const burnRateVar = safeVariance(real.burnRate, Math.abs(budget.burnRate || 1));

            // Format values
            const formatCurrency = (val, decimals = 0) => {
                if (Math.abs(val) >= 1000000) {
                    return '$' + (val / 1000000).toFixed(2) + 'M';
                } else if (Math.abs(val) >= 1000) {
                    return '$' + (val / 1000).toFixed(decimals) + 'K';
                }
                return '$' + val.toFixed(decimals);
            };

            // Determine if variance is favorable (higher is better except for CAC and Burn Rate)
            const getComparisonClass = (variance, lowerIsBetter = false) => {
                if (lowerIsBetter) {
                    return variance <= 0 ? 'positive' : 'negative';
                }
                return variance >= 0 ? 'positive' : 'negative';
            };

            const getArrow = (variance, lowerIsBetter = false) => {
                if (lowerIsBetter) {
                    return variance <= 0 ? '↑' : '↓';
                }
                return variance >= 0 ? '↑' : '↓';
            };

            // Format variance display
            const formatVariance = (variance) => {
                return (variance >= 0 ? '+' : '') + variance.toFixed(1) + '%';
            };

            kpiGrid.innerHTML = `
                <!-- Row 1 -->
                <div class="kpi-card-new">
                    <div class="kpi-card-label">Total Revenue</div>
                    <div class="kpi-card-value">${formatCurrency(real.revenue)}</div>
                    <div class="kpi-card-comparison ${getComparisonClass(revenueVar)}">
                        <span class="kpi-arrow">${getArrow(revenueVar)}</span>
                        Actual ${formatCurrency(real.revenue)} | Budget ${formatCurrency(budget.revenue)} | Var: ${formatVariance(revenueVar)}
                    </div>
                </div>
                <div class="kpi-card-new">
                    <div class="kpi-card-label">LTV:CAC Ratio</div>
                    <div class="kpi-card-value">${real.ltvCac.toFixed(2)}x</div>
                    <div class="kpi-card-comparison ${getComparisonClass(ltvCacVar)}">
                        <span class="kpi-arrow">${getArrow(ltvCacVar)}</span>
                        Actual ${real.ltvCac.toFixed(2)}x | Budget ${budget.ltvCac.toFixed(2)}x | Var: ${formatVariance(ltvCacVar)}
                    </div>
                </div>
                <div class="kpi-card-new">
                    <div class="kpi-card-label">Total New Subscribers</div>
                    <div class="kpi-card-value">${real.subs.toLocaleString()}</div>
                    <div class="kpi-card-comparison ${getComparisonClass(subsVar)}">
                        <span class="kpi-arrow">${getArrow(subsVar)}</span>
                        Actual ${real.subs.toLocaleString()} | Budget ${budget.subs.toLocaleString()} | Var: ${formatVariance(subsVar)}
                    </div>
                </div>
                <div class="kpi-card-new">
                    <div class="kpi-card-label">Monthly Burn Rate</div>
                    <div class="kpi-card-value">${formatCurrency(real.burnRate)}</div>
                    <div class="kpi-card-comparison ${getComparisonClass(burnRateVar, true)}">
                        <span class="kpi-arrow">${getArrow(burnRateVar, true)}</span>
                        Actual ${formatCurrency(real.burnRate)} | Budget ${formatCurrency(Math.abs(budget.burnRate))} | Var: ${formatVariance(burnRateVar)}
                    </div>
                </div>

                <!-- Row 2 -->
                <div class="kpi-card-new">
                    <div class="kpi-card-label">Estimated Runway</div>
                    <div class="kpi-card-value">${real.burnRate > 0 ? '4-10m' : 'Profitable'}</div>
                    <div class="kpi-card-comparison neutral">
                        Based on current burn rate vs budget expectations
                    </div>
                </div>
                <div class="kpi-card-new">
                    <div class="kpi-card-label">EBITDA</div>
                    <div class="kpi-card-value">${formatCurrency(real.ebitda)}</div>
                    <div class="kpi-card-comparison ${getComparisonClass(ebitdaVar)}">
                        <span class="kpi-arrow">${getArrow(ebitdaVar)}</span>
                        Actual ${formatCurrency(real.ebitda)} | Budget ${formatCurrency(budget.ebitda)} | Var: ${formatCurrency(ebitdaVar)}
                    </div>
                </div>
                <div class="kpi-card-new">
                    <div class="kpi-card-label">CAC</div>
                    <div class="kpi-card-value">$${real.cac.toFixed(2)}</div>
                    <div class="kpi-card-comparison ${getComparisonClass(cacVar, true)}">
                        <span class="kpi-arrow">${getArrow(cacVar, true)}</span>
                        Actual $${real.cac.toFixed(2)} | Budget $${budget.cac.toFixed(2)} | Var: ${formatVariance(cacVar)}
                    </div>
                </div>
                <div class="kpi-card-new">
                    <div class="kpi-card-label">ARPU</div>
                    <div class="kpi-card-value">$${real.arpu.toFixed(2)}</div>
                    <div class="kpi-card-comparison ${getComparisonClass(arpuVar)}">
                        <span class="kpi-arrow">${getArrow(arpuVar)}</span>
                        Actual $${real.arpu.toFixed(2)} | Budget $${budget.arpu.toFixed(2)} | Var: ${formatVariance(arpuVar)}
                    </div>
                </div>
            `;
        }

        // ============================================
        // QUARTER DRILL-DOWN
        // ============================================
        function updateQuarterDrillDown() {
            const container = document.getElementById('quarterDrillDown');
            const drillDownContainer = document.getElementById('quarterDrillDownContainer');

            if (!container || !drillDownContainer) return;

            // Show drill-down for quarterly view only
            if (currentGranularity === 'quarterly' && currentPeriod !== 'YEAR') {
                drillDownContainer.style.display = 'block';

                const real = data?.real?.[currentPeriod] || { revenue: 0, subs: 0, cac: 0, arpu: 0 };
                const months = quarterMonths[currentPeriod] || [];

                container.innerHTML = `
                    <div class="quarter-detail">
                        <div class="quarter-summary" onclick="toggleMonths('${currentPeriod}')">
                            <div class="quarter-summary-left">
                                <h3>${currentPeriod} 2025 Monthly Breakdown</h3>
                                <div class="quarter-summary-stats">
                                    <div>Revenue: <span>$${(real.revenue / 1000).toFixed(0)}K</span></div>
                                    <div>Subscribers: <span>${real.subs.toLocaleString()}</span></div>
                                    <div>CAC: <span>$${real.cac.toFixed(2)}</span></div>
                                    <div>ARPU: <span>$${real.arpu.toFixed(2)}</span></div>
                                </div>
                            </div>
                            <div class="expand-icon expanded" id="expandIcon${currentPeriod}">▼</div>
                        </div>
                        <div class="months-grid expanded" id="monthsGrid${currentPeriod}">
                            ${months.map(month => {
                                const m = monthlyData?.[month] || { revenue: 0, subs: 0, cac: 0, arpu: 0 };
                                const contributionMargin = (m.arpu || 0) - (m.cac || 0);
                                const marginPercent = m.arpu ? Math.min(Math.abs(contributionMargin / m.arpu * 100), 100) : 0;
                                return `
                                <div class="month-card">
                                    <h4>${month}</h4>
                                    <div class="month-metric">
                                        <span class="month-metric-label">Revenue</span>
                                        <span class="month-metric-value">$${((m.revenue || 0) / 1000).toFixed(1)}K</span>
                                    </div>
                                    <div class="month-metric">
                                        <span class="month-metric-label">Subscribers</span>
                                        <span class="month-metric-value">${(m.subs || 0).toLocaleString()}</span>
                                    </div>
                                    <div class="month-metric">
                                        <span class="month-metric-label">CAC</span>
                                        <span class="month-metric-value">$${(m.cac || 0).toFixed(2)}</span>
                                    </div>
                                    <div class="month-metric">
                                        <span class="month-metric-label">ARPU</span>
                                        <span class="month-metric-value">$${(m.arpu || 0).toFixed(2)}</span>
                                    </div>
                                    <div class="month-metric">
                                        <span class="month-metric-label">Contribution Margin</span>
                                        <span class="month-metric-value" style="color: ${contributionMargin >= 0 ? '#22c55e' : '#ef4444'}">$${contributionMargin.toFixed(2)}</span>
                                    </div>
                                    <div class="progress-bar-container">
                                        <div class="progress-bar ${contributionMargin >= 0 ? 'under' : 'over'}" style="width: ${marginPercent}%"></div>
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                `;
            } else {
                drillDownContainer.style.display = 'none';
                container.innerHTML = '';
            }
        }

        function toggleMonths(quarter) {
            const grid = document.getElementById(`monthsGrid${quarter}`);
            const icon = document.getElementById(`expandIcon${quarter}`);

            if (grid.classList.contains('expanded')) {
                grid.classList.remove('expanded');
                icon.classList.remove('expanded');
            } else {
                grid.classList.add('expanded');
                icon.classList.add('expanded');
            }
        }

        // ============================================
        // CONTRIBUTION MARGIN CHART
        // ============================================
        function createContributionMarginChart() {
            const canvasEl = document.getElementById('contributionMarginChart');
            if (!canvasEl) return;
            const ctx = canvasEl.getContext('2d');

            charts.contributionMargin = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [{
                        label: 'Actual',
                        data: contributionMarginActual.map(v => v / 1000),
                        backgroundColor: function(context) {
                            const value = context.raw;
                            return value >= 0 ? '#1e3a5f' : '#ef4444';
                        },
                        borderRadius: 4
                    }, {
                        label: 'Budget',
                        data: contributionMarginBudget.map(v => v / 1000),
                        backgroundColor: '#94a3b8',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#1e3a5f',
                                font: {
                                    size: 13,
                                    weight: 600
                                },
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            callbacks: {
                                label: function(context) {
                                    const actual = contributionMarginActual[context.dataIndex];
                                    const budget = contributionMarginBudget[context.dataIndex];
                                    const variance = ((actual - budget) / Math.abs(budget) * 100).toFixed(1);
                                    if (context.datasetIndex === 0) {
                                        return `Actual: $${context.parsed.y.toFixed(0)}K | Var: ${variance >= 0 ? '+' : ''}${variance}%`;
                                    }
                                    return `Budget: $${context.parsed.y.toFixed(0)}K`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#e2e8f0',
                                drawBorder: false
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value + 'K';
                                },
                                color: '#6b7280',
                                font: {
                                    size: 12
                                }
                            },
                            border: {
                                display: false
                            }
                        },
                        x: {
                            grid: {
                                display: false,
                                drawBorder: false
                            },
                            ticks: {
                                color: '#6b7280',
                                font: {
                                    size: 12
                                }
                            },
                            border: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // ============================================
        // REVENUE CHART
        // ============================================
        function getRevenueDataForGranularity(filter) {
            let labels = [];
            let actualData = [];
            let budgetData = [];

            // Handle custom range - show monthly data for selected months
            if (customRangeActive) {
                const months = getCustomRangeMonths();
                labels = months.map(m => monthLabelsShort[monthNames.indexOf(m)]);
                if (filter === 'all') {
                    months.forEach(month => {
                        actualData.push((monthlyData[month]?.revenue || 0) / 1000);
                        budgetData.push((monthlyBudget[month]?.revenue || 0) / 1000);
                    });
                } else {
                    // For category filters, approximate from quarterly data
                    months.forEach(month => {
                        const monthIdx = monthNames.indexOf(month);
                        const q = ['Q1', 'Q1', 'Q1', 'Q2', 'Q2', 'Q2', 'Q3', 'Q3', 'Q3', 'Q4', 'Q4', 'Q4'][monthIdx];
                        actualData.push((revenueBreakdown?.actual?.[filter]?.[q] || 0) / 3000);
                        budgetData.push((revenueBreakdown?.budget?.[filter]?.[q] || 0) / 3000);
                    });
                }
                return { labels, actual: actualData, budget: budgetData };
            }

            switch(currentGranularity) {
                case 'monthly':
                    labels = monthLabelsShort;
                    if (filter === 'all') {
                        monthNames.forEach(month => {
                            actualData.push((monthlyData[month]?.revenue || 0) / 1000);
                            budgetData.push((monthlyBudget[month]?.revenue || 0) / 1000);
                        });
                    } else {
                        // For category filters, calculate monthly from quarterly (approximate)
                        const quarters = ['Q1', 'Q1', 'Q1', 'Q2', 'Q2', 'Q2', 'Q3', 'Q3', 'Q3', 'Q4', 'Q4', 'Q4'];
                        quarters.forEach((q, i) => {
                            actualData.push((revenueBreakdown.actual?.[filter]?.[q] || 0) / 3000);
                            budgetData.push((revenueBreakdown.budget?.[filter]?.[q] || 0) / 3000);
                        });
                    }
                    break;

                case 'quarterly':
                    labels = ['Q1', 'Q2', 'Q3', 'Q4'];
                    if (filter === 'all') {
                        ['Q1', 'Q2', 'Q3', 'Q4'].forEach(q => {
                            actualData.push((data.real[q]?.revenue || 0) / 1000);
                            budgetData.push((data.budget[q]?.revenue || 0) / 1000);
                        });
                    } else {
                        ['Q1', 'Q2', 'Q3', 'Q4'].forEach(q => {
                            actualData.push((revenueBreakdown.actual?.[filter]?.[q] || 0) / 1000);
                            budgetData.push((revenueBreakdown.budget?.[filter]?.[q] || 0) / 1000);
                        });
                    }
                    break;

                case 'semester':
                    labels = ['H1', 'H2'];
                    if (filter === 'all') {
                        actualData = [(data.real.H1?.revenue || 0) / 1000, (data.real.H2?.revenue || 0) / 1000];
                        budgetData = [(data.budget.H1?.revenue || 0) / 1000, (data.budget.H2?.revenue || 0) / 1000];
                    } else {
                        const h1Actual = (revenueBreakdown.actual?.[filter]?.Q1 || 0) + (revenueBreakdown.actual?.[filter]?.Q2 || 0);
                        const h2Actual = (revenueBreakdown.actual?.[filter]?.Q3 || 0) + (revenueBreakdown.actual?.[filter]?.Q4 || 0);
                        const h1Budget = (revenueBreakdown.budget?.[filter]?.Q1 || 0) + (revenueBreakdown.budget?.[filter]?.Q2 || 0);
                        const h2Budget = (revenueBreakdown.budget?.[filter]?.Q3 || 0) + (revenueBreakdown.budget?.[filter]?.Q4 || 0);
                        actualData = [h1Actual / 1000, h2Actual / 1000];
                        budgetData = [h1Budget / 1000, h2Budget / 1000];
                    }
                    break;

                case 'yearly':
                default:
                    labels = [`FY ${currentYear}`];
                    if (filter === 'all') {
                        actualData = [(data.real.YEAR?.revenue || 0) / 1000];
                        budgetData = [(data.budget.YEAR?.revenue || 0) / 1000];
                    } else {
                        const yearActual = (revenueBreakdown.actual?.[filter]?.Q1 || 0) + (revenueBreakdown.actual?.[filter]?.Q2 || 0) +
                                          (revenueBreakdown.actual?.[filter]?.Q3 || 0) + (revenueBreakdown.actual?.[filter]?.Q4 || 0);
                        const yearBudget = (revenueBreakdown.budget?.[filter]?.Q1 || 0) + (revenueBreakdown.budget?.[filter]?.Q2 || 0) +
                                          (revenueBreakdown.budget?.[filter]?.Q3 || 0) + (revenueBreakdown.budget?.[filter]?.Q4 || 0);
                        actualData = [yearActual / 1000];
                        budgetData = [yearBudget / 1000];
                    }
                    break;
            }

            return { labels, actual: actualData, budget: budgetData };
        }

        function getRevenueChartTitle() {
            if (customRangeActive) {
                const fromMonth = monthNames[customRangeFrom];
                const toMonth = monthNames[customRangeTo];
                if (customRangeFrom === customRangeTo) {
                    return `${fromMonth} Revenue: Actual vs Budget`;
                }
                return `${fromMonth} - ${toMonth} Revenue: Actual vs Budget`;
            }
            const periodNames = {
                'monthly': 'Monthly',
                'quarterly': 'Quarterly',
                'semester': 'Semester',
                'yearly': 'Annual'
            };
            return `${periodNames[currentGranularity]} Revenue: Actual vs Budget`;
        }

        function createRevenueChart() {
            const canvasEl = document.getElementById('revenueChart');
            if (!canvasEl) return;
            const ctx = canvasEl.getContext('2d');
            const revenueData = getRevenueDataForGranularity('all');

            // Update chart title
            const titleEl = document.getElementById('revenueChartTitle');
            if (titleEl) titleEl.textContent = getRevenueChartTitle();

            charts.revenue = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: revenueData.labels,
                    datasets: [{
                        label: 'Actual Revenue',
                        data: revenueData.actual,
                        backgroundColor: '#1e3a5f',
                        borderRadius: 6
                    }, {
                        label: 'Budget Revenue',
                        data: revenueData.budget,
                        backgroundColor: '#94a3b8',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#1e3a5f',
                                font: {
                                    size: 13,
                                    weight: 600
                                },
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toFixed(0) + 'K';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#e2e8f0',
                                drawBorder: false
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value + 'K';
                                },
                                color: '#6b7280',
                                font: {
                                    size: 12
                                }
                            },
                            border: {
                                display: false
                            }
                        },
                        x: {
                            grid: {
                                display: false,
                                drawBorder: false
                            },
                            ticks: {
                                color: '#6b7280',
                                font: {
                                    size: 12
                                }
                            },
                            border: {
                                display: false
                            }
                        }
                    }
                }
            });

            updateRevenueBreakdown('all');
        }

        function updateRevenueChart() {
            if (!charts.revenue) return;

            const revenueData = getRevenueDataForGranularity(currentRevenueFilter);

            // Update chart title
            document.getElementById('revenueChartTitle').textContent = getRevenueChartTitle();

            charts.revenue.data.labels = revenueData.labels;
            charts.revenue.data.datasets[0].data = revenueData.actual;
            charts.revenue.data.datasets[0].label = `Actual ${currentYear}`;
            charts.revenue.data.datasets[1].data = revenueData.budget;
            charts.revenue.data.datasets[1].label = currentYear === 2026 ? `Budget (${getPrimaryScenario()})` : 'Budget';

            // Remove extra scenario datasets if any
            while (charts.revenue.data.datasets.length > 2) {
                // Keep CAGR trendline if it exists
                const lastDataset = charts.revenue.data.datasets[charts.revenue.data.datasets.length - 1];
                if (lastDataset.label === 'CAGR Trend') break;
                charts.revenue.data.datasets.pop();
            }

            // Add 2026 scenario lines if applicable
            if (currentYear === 2026) {
                add2026ScenarioDatasets(charts.revenue, 'revenue');
            }

            // Add 2025 comparison line if enabled
            if (currentYear === 2026 && compareWith2025 && data2025Backup) {
                add2025ComparisonDataset(charts.revenue, 'revenue');
            }

            // Handle CAGR trend line
            updateRevenueCagrTrendline();

            charts.revenue.update();

            updateRevenueBreakdown(currentRevenueFilter);
        }

        /**
         * Add 2026 scenario datasets to a chart
         */
        function add2026ScenarioDatasets(chart, metric) {
            const scenarioColors = {
                optimistic: { border: '#10B981', bg: 'rgba(16, 185, 129, 0.1)' },
                conservative: { border: '#3B82F6', bg: 'rgba(59, 130, 246, 0.1)' },
                pessimistic: { border: '#F59E0B', bg: 'rgba(245, 158, 11, 0.1)' }
            };

            // Get the primary scenario (already shown in main budget bar)
            const primaryScenario = getPrimaryScenario();

            // Add lines for other active scenarios
            ['optimistic', 'conservative', 'pessimistic'].forEach(scenario => {
                if (scenarioStates[scenario] && scenario !== primaryScenario) {
                    const scenarioData = getScenarioData(scenario, metric);

                    // Check if this dataset already exists
                    const existingIdx = chart.data.datasets.findIndex(ds => ds.label === `${scenario.charAt(0).toUpperCase() + scenario.slice(1)} Budget`);
                    if (existingIdx === -1) {
                        chart.data.datasets.push({
                            label: `${scenario.charAt(0).toUpperCase() + scenario.slice(1)} Budget`,
                            data: scenarioData,
                            type: 'line',
                            borderColor: scenarioColors[scenario].border,
                            backgroundColor: scenarioColors[scenario].bg,
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointBackgroundColor: scenarioColors[scenario].border,
                            pointRadius: 3,
                            fill: false,
                            tension: 0.1,
                            order: 1
                        });
                    }
                }
            });
        }

        /**
         * Get scenario data for a specific metric
         */
        function getScenarioData(scenario, metric) {
            const scenarioMonthlyData = data2026[scenario].monthlyBudget;
            let resultData = [];

            if (customRangeActive) {
                const months = getCustomRangeMonths();
                months.forEach(month => {
                    resultData.push((scenarioMonthlyData[month]?.[metric] || 0) / 1000);
                });
            } else {
                switch(currentGranularity) {
                    case 'monthly':
                        monthNames.forEach(month => {
                            resultData.push((scenarioMonthlyData[month]?.[metric] || 0) / 1000);
                        });
                        break;
                    case 'quarterly':
                        ['Q1', 'Q2', 'Q3', 'Q4'].forEach(q => {
                            resultData.push((data2026[scenario].budget[q]?.[metric] || 0) / 1000);
                        });
                        break;
                    case 'semester':
                        resultData = [
                            (data2026[scenario].budget.H1?.[metric] || 0) / 1000,
                            (data2026[scenario].budget.H2?.[metric] || 0) / 1000
                        ];
                        break;
                    case 'yearly':
                    default:
                        resultData = [(data2026[scenario].budget.YEAR?.[metric] || 0) / 1000];
                        break;
                }
            }

            return resultData;
        }

        /**
         * Add 2025 comparison dataset to a chart
         */
        function add2025ComparisonDataset(chart, metric) {
            const backup = data2025Backup;
            let comparisonData = [];

            if (customRangeActive) {
                const months = getCustomRangeMonths();
                months.forEach(month => {
                    comparisonData.push((backup.monthlyData[month]?.[metric] || 0) / 1000);
                });
            } else {
                switch(currentGranularity) {
                    case 'monthly':
                        monthNames.forEach(month => {
                            comparisonData.push((backup.monthlyData[month]?.[metric] || 0) / 1000);
                        });
                        break;
                    case 'quarterly':
                        ['Q1', 'Q2', 'Q3', 'Q4'].forEach(q => {
                            comparisonData.push((backup.data.real[q]?.[metric] || 0) / 1000);
                        });
                        break;
                    case 'semester':
                        comparisonData = [
                            (backup.data.real.H1?.[metric] || 0) / 1000,
                            (backup.data.real.H2?.[metric] || 0) / 1000
                        ];
                        break;
                    case 'yearly':
                    default:
                        comparisonData = [(backup.data.real.YEAR?.[metric] || 0) / 1000];
                        break;
                }
            }

            // Check if 2025 comparison already exists
            const existingIdx = chart.data.datasets.findIndex(ds => ds.label === '2025 Actual');
            if (existingIdx === -1) {
                chart.data.datasets.push({
                    label: '2025 Actual',
                    data: comparisonData,
                    type: 'line',
                    borderColor: '#9CA3AF',
                    backgroundColor: 'rgba(156, 163, 175, 0.1)',
                    borderWidth: 2,
                    borderDash: [8, 4],
                    pointBackgroundColor: '#9CA3AF',
                    pointRadius: 3,
                    fill: false,
                    tension: 0.1,
                    order: 2
                });
            }
        }

        // ============================================
        // REVENUE FILTER
        // ============================================
        function filterRevenue(filter) {
            currentRevenueFilter = filter;

            // Update button states
            document.querySelectorAll('.revenue-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update chart with new filter and current granularity
            const revenueData = getRevenueDataForGranularity(filter);
            charts.revenue.data.labels = revenueData.labels;
            charts.revenue.data.datasets[0].data = revenueData.actual;
            charts.revenue.data.datasets[1].data = revenueData.budget;
            charts.revenue.update();

            // Update breakdown
            updateRevenueBreakdown(filter);
        }

        function updateRevenueBreakdown(filter) {
            const container = document.getElementById('revenueBreakdown');
            if (!container) return;

            // Check if revenueBreakdown has data
            if (!revenueBreakdown?.actual?.subscriptions) {
                container.innerHTML = '';
                return;
            }

            if (filter === 'all') {
                // Calculate totals for full year
                const subsActual = (revenueBreakdown.actual.subscriptions?.Q1 || 0) + (revenueBreakdown.actual.subscriptions?.Q2 || 0) +
                                   (revenueBreakdown.actual.subscriptions?.Q3 || 0) + (revenueBreakdown.actual.subscriptions?.Q4 || 0);
                const offActual = (revenueBreakdown.actual.offapp?.Q1 || 0) + (revenueBreakdown.actual.offapp?.Q2 || 0) +
                                  (revenueBreakdown.actual.offapp?.Q3 || 0) + (revenueBreakdown.actual.offapp?.Q4 || 0);
                const partActual = (revenueBreakdown.actual.partnership?.Q1 || 0) + (revenueBreakdown.actual.partnership?.Q2 || 0) +
                                   (revenueBreakdown.actual.partnership?.Q3 || 0) + (revenueBreakdown.actual.partnership?.Q4 || 0);
                const totalActual = subsActual + offActual + partActual;

                if (totalActual === 0) {
                    container.innerHTML = '';
                    return;
                }

                const subsPercent = (subsActual / totalActual * 100).toFixed(1);
                const offPercent = (offActual / totalActual * 100).toFixed(1);
                const partPercent = (partActual / totalActual * 100).toFixed(1);

                container.innerHTML = `
                    <div class="revenue-breakdown-item">
                        <div class="revenue-breakdown-label">Subscriptions</div>
                        <div class="revenue-breakdown-value">${subsPercent}%</div>
                    </div>
                    <div class="revenue-breakdown-item">
                        <div class="revenue-breakdown-label">Off App Sales</div>
                        <div class="revenue-breakdown-value">${offPercent}%</div>
                    </div>
                    <div class="revenue-breakdown-item">
                        <div class="revenue-breakdown-label">Partnership</div>
                        <div class="revenue-breakdown-value">${partPercent}%</div>
                    </div>
                `;
            } else {
                // Show specific category info
                const actual = revenueBreakdown.actual?.[filter];
                const budget = revenueBreakdown.budget?.[filter];
                if (!actual || !budget) {
                    container.innerHTML = '';
                    return;
                }
                const totalActual = (actual.Q1 || 0) + (actual.Q2 || 0) + (actual.Q3 || 0) + (actual.Q4 || 0);
                const totalBudget = (budget.Q1 || 0) + (budget.Q2 || 0) + (budget.Q3 || 0) + (budget.Q4 || 0);
                const variance = totalBudget > 0 ? ((totalActual - totalBudget) / totalBudget * 100).toFixed(1) : 0;

                const categoryNames = {
                    'subscriptions': 'Subscription Sales',
                    'offapp': 'Off App Sales',
                    'partnership': 'Partnership'
                };

                container.innerHTML = `
                    <div class="revenue-breakdown-item">
                        <div class="revenue-breakdown-label">Category</div>
                        <div class="revenue-breakdown-value">${categoryNames[filter]}</div>
                    </div>
                    <div class="revenue-breakdown-item">
                        <div class="revenue-breakdown-label">Actual (FY 2025)</div>
                        <div class="revenue-breakdown-value">$${(totalActual / 1000).toFixed(0)}K</div>
                    </div>
                    <div class="revenue-breakdown-item">
                        <div class="revenue-breakdown-label">Budget</div>
                        <div class="revenue-breakdown-value">$${(totalBudget / 1000).toFixed(0)}K</div>
                    </div>
                    <div class="revenue-breakdown-item">
                        <div class="revenue-breakdown-label">vs Budget</div>
                        <div class="revenue-breakdown-value" style="color: ${variance >= 0 ? '#22c55e' : '#ef4444'}">
                            ${variance >= 0 ? '↑' : '↓'} ${Math.abs(variance)}%
                        </div>
                    </div>
                `;
            }
        }

        // ============================================
        // EBITDA CHART
        // ============================================
        function getEbitdaDataForGranularity() {
            let labels = [];
            let actualData = [];
            let budgetData = [];

            // Handle custom range
            if (customRangeActive) {
                const months = getCustomRangeMonths();
                labels = months.map(m => monthLabelsShort[monthNames.indexOf(m)]);
                months.forEach(month => {
                    actualData.push((monthlyData[month]?.ebitda || 0) / 1000);
                    budgetData.push((monthlyBudget[month]?.ebitda || 0) / 1000);
                });
                return { labels, actual: actualData, budget: budgetData };
            }

            switch(currentGranularity) {
                case 'monthly':
                    labels = monthLabelsShort;
                    monthNames.forEach(month => {
                        actualData.push((monthlyData[month]?.ebitda || 0) / 1000);
                        budgetData.push((monthlyBudget[month]?.ebitda || 0) / 1000);
                    });
                    break;

                case 'quarterly':
                    labels = ['Q1', 'Q2', 'Q3', 'Q4'];
                    ['Q1', 'Q2', 'Q3', 'Q4'].forEach(q => {
                        actualData.push((data.real[q]?.ebitda || 0) / 1000);
                        budgetData.push((data.budget[q]?.ebitda || 0) / 1000);
                    });
                    break;

                case 'semester':
                    labels = ['H1', 'H2'];
                    actualData = [(data.real.H1?.ebitda || 0) / 1000, (data.real.H2?.ebitda || 0) / 1000];
                    budgetData = [(data.budget.H1?.ebitda || 0) / 1000, (data.budget.H2?.ebitda || 0) / 1000];
                    break;

                case 'yearly':
                default:
                    labels = [`FY ${currentYear}`];
                    actualData = [(data.real.YEAR?.ebitda || 0) / 1000];
                    budgetData = [(data.budget.YEAR?.ebitda || 0) / 1000];
                    break;
            }

            return { labels, actual: actualData, budget: budgetData };
        }

        function getEbitdaChartTitle() {
            if (customRangeActive) {
                const fromMonth = monthNames[customRangeFrom];
                const toMonth = monthNames[customRangeTo];
                if (customRangeFrom === customRangeTo) {
                    return `${fromMonth} EBITDA: Actual vs Budget`;
                }
                return `${fromMonth} - ${toMonth} EBITDA: Actual vs Budget`;
            }
            const periodNames = {
                'monthly': 'Monthly',
                'quarterly': 'Quarterly',
                'semester': 'Semester',
                'yearly': 'Annual'
            };
            return `${periodNames[currentGranularity]} EBITDA: Actual vs Budget`;
        }

        function createEbitdaChart() {
            const canvasEl = document.getElementById('ebitdaChart');
            if (!canvasEl) return;
            const ctx = canvasEl.getContext('2d');
            const ebitdaData = getEbitdaDataForGranularity();

            // Update chart title
            const titleEl = document.getElementById('ebitdaChartTitle');
            if (titleEl) titleEl.textContent = getEbitdaChartTitle();

            charts.ebitda = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ebitdaData.labels,
                    datasets: [{
                        label: 'Actual EBITDA',
                        data: ebitdaData.actual,
                        backgroundColor: function(context) {
                            const value = context.raw;
                            return value >= 0 ? '#22c55e' : '#ef4444';
                        },
                        borderRadius: 6
                    }, {
                        label: 'Budget EBITDA',
                        data: ebitdaData.budget,
                        backgroundColor: '#94a3b8',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#1e3a5f',
                                font: {
                                    size: 13,
                                    weight: 600
                                },
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toFixed(0) + 'K';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: '#e2e8f0',
                                drawBorder: false
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value + 'K';
                                },
                                color: '#6b7280',
                                font: {
                                    size: 12
                                }
                            },
                            border: {
                                display: false
                            }
                        },
                        x: {
                            grid: {
                                display: false,
                                drawBorder: false
                            },
                            ticks: {
                                color: '#6b7280',
                                font: {
                                    size: 12
                                }
                            },
                            border: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function updateEbitdaChart() {
            if (!charts.ebitda) return;

            const ebitdaData = getEbitdaDataForGranularity();

            // Update chart title
            document.getElementById('ebitdaChartTitle').textContent = getEbitdaChartTitle();

            charts.ebitda.data.labels = ebitdaData.labels;
            charts.ebitda.data.datasets[0].data = ebitdaData.actual;
            charts.ebitda.data.datasets[0].label = `Actual ${currentYear}`;
            charts.ebitda.data.datasets[1].data = ebitdaData.budget;
            charts.ebitda.data.datasets[1].label = currentYear === 2026 ? `Budget (${getPrimaryScenario()})` : 'Budget';

            // Remove extra scenario datasets if any
            while (charts.ebitda.data.datasets.length > 2) {
                const lastDataset = charts.ebitda.data.datasets[charts.ebitda.data.datasets.length - 1];
                if (lastDataset.label === 'CAGR Trend') break;
                charts.ebitda.data.datasets.pop();
            }

            // Add 2026 scenario lines if applicable
            if (currentYear === 2026) {
                add2026ScenarioDatasets(charts.ebitda, 'ebitda');
            }

            // Add 2025 comparison line if enabled
            if (currentYear === 2026 && compareWith2025 && data2025Backup) {
                add2025ComparisonDataset(charts.ebitda, 'ebitda');
            }

            // Handle CAGR trend line
            updateEbitdaCagrTrendline();

            charts.ebitda.update();
        }

        // ============================================
        // CAGR TREND CALCULATIONS AND DISPLAY
        // ============================================

        /**
         * Calculate growth rate based on data series
         * Returns the period-over-period growth rate
         */
        function calculateGrowthRate(dataArray) {
            if (!dataArray || dataArray.length < 2) return null;

            const firstValue = dataArray[0];
            const lastValue = dataArray[dataArray.length - 1];
            const periods = dataArray.length - 1;

            // Handle edge cases
            if (firstValue === 0 || firstValue === null || firstValue === undefined) return null;
            if (lastValue === null || lastValue === undefined) return null;

            // For negative values (like EBITDA losses), we need special handling
            if (firstValue < 0 && lastValue < 0) {
                // Both negative - check if loss is decreasing (improving)
                const ratio = lastValue / firstValue;
                if (ratio <= 0) return null;
                const cagr = (Math.pow(ratio, 1 / periods) - 1) * 100;
                return cagr;
            } else if (firstValue < 0 && lastValue >= 0) {
                // Went from loss to profit - can't calculate traditional CAGR
                return null;
            } else if (firstValue > 0 && lastValue < 0) {
                // Went from profit to loss - can't calculate traditional CAGR
                return null;
            }

            // Normal case: both positive
            const cagr = (Math.pow(lastValue / firstValue, 1 / periods) - 1) * 100;
            return cagr;
        }

        /**
         * Generate trendline data based on CAGR
         */
        function generateTrendlineData(startValue, growthRate, periods) {
            const trendData = [];
            for (let i = 0; i < periods; i++) {
                const value = startValue * Math.pow(1 + growthRate / 100, i);
                trendData.push(value);
            }
            return trendData;
        }

        /**
         * Get the period label for CAGR display
         */
        function getCagrPeriodLabel() {
            if (customRangeActive) {
                const months = getCustomRangeMonths();
                if (months.length <= 1) return 'Growth';
                return 'Period Growth';
            }

            switch(currentGranularity) {
                case 'monthly':
                    return 'MoM Growth';
                case 'quarterly':
                    return 'QoQ Growth';
                case 'semester':
                    return 'Semester Growth';
                case 'yearly':
                default:
                    return 'CAGR';
            }
        }

        /**
         * Update CAGR badge display
         */
        function updateCagrBadge(badgeId, cagrValue, show) {
            const badge = document.getElementById(badgeId);
            if (!badge) return;

            if (!show || cagrValue === null) {
                badge.classList.add('hidden');
                return;
            }

            badge.classList.remove('hidden');

            // Update badge class based on value
            badge.classList.remove('positive', 'negative', 'neutral');
            if (cagrValue > 0) {
                badge.classList.add('positive');
            } else if (cagrValue < 0) {
                badge.classList.add('negative');
            } else {
                badge.classList.add('neutral');
            }

            // Update badge content
            const arrowEl = badge.querySelector('.badge-arrow');
            const valueEl = badge.querySelector('.badge-value');

            if (arrowEl) {
                arrowEl.textContent = cagrValue >= 0 ? '↑' : '↓';
            }

            if (valueEl) {
                const label = getCagrPeriodLabel();
                const sign = cagrValue >= 0 ? '+' : '';
                valueEl.textContent = `${label}: ${sign}${cagrValue.toFixed(1)}%`;
            }
        }

        /**
         * Toggle Revenue CAGR trend visibility
         */
        function toggleRevenueCagr() {
            showRevenueCagrTrend = !showRevenueCagrTrend;

            const btn = document.getElementById('revenueCagrToggle');
            if (btn) {
                btn.classList.toggle('active', showRevenueCagrTrend);
            }

            updateRevenueCagrTrendline();
            charts.revenue.update();
        }

        /**
         * Toggle EBITDA CAGR trend visibility
         */
        function toggleEbitdaCagr() {
            showEbitdaCagrTrend = !showEbitdaCagrTrend;

            const btn = document.getElementById('ebitdaCagrToggle');
            if (btn) {
                btn.classList.toggle('active', showEbitdaCagrTrend);
            }

            updateEbitdaCagrTrendline();
            charts.ebitda.update();
        }

        /**
         * Update Revenue chart trendline
         */
        function updateRevenueCagrTrendline() {
            if (!charts.revenue) return;

            const revenueData = getRevenueDataForGranularity(currentRevenueFilter);
            const actualData = revenueData.actual;

            // Remove existing trendline dataset if exists
            const trendlineIndex = charts.revenue.data.datasets.findIndex(ds => ds.label === 'CAGR Trend');
            if (trendlineIndex !== -1) {
                charts.revenue.data.datasets.splice(trendlineIndex, 1);
            }

            // Calculate CAGR
            const cagr = calculateGrowthRate(actualData);

            // Update badge
            updateCagrBadge('revenueCagrBadge', cagr, showRevenueCagrTrend);

            if (!showRevenueCagrTrend || cagr === null || actualData.length < 2) {
                return;
            }

            // Generate trendline data
            const trendlineData = generateTrendlineData(actualData[0], cagr, actualData.length);

            // Add trendline dataset
            charts.revenue.data.datasets.push({
                label: 'CAGR Trend',
                data: trendlineData,
                type: 'line',
                borderColor: '#5BA4E6',
                backgroundColor: 'rgba(91, 164, 230, 0.1)',
                borderWidth: 2,
                borderDash: [6, 4],
                pointBackgroundColor: '#5BA4E6',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6,
                fill: false,
                tension: 0.1,
                order: 0 // Draw on top
            });
        }

        /**
         * Update EBITDA chart trendline
         */
        function updateEbitdaCagrTrendline() {
            if (!charts.ebitda) return;

            const ebitdaData = getEbitdaDataForGranularity();
            const actualData = ebitdaData.actual;

            // Remove existing trendline dataset if exists
            const trendlineIndex = charts.ebitda.data.datasets.findIndex(ds => ds.label === 'CAGR Trend');
            if (trendlineIndex !== -1) {
                charts.ebitda.data.datasets.splice(trendlineIndex, 1);
            }

            // Calculate CAGR
            const cagr = calculateGrowthRate(actualData);

            // Update badge
            updateCagrBadge('ebitdaCagrBadge', cagr, showEbitdaCagrTrend);

            if (!showEbitdaCagrTrend || cagr === null || actualData.length < 2) {
                return;
            }

            // Generate trendline data
            const trendlineData = generateTrendlineData(actualData[0], cagr, actualData.length);

            // Add trendline dataset
            charts.ebitda.data.datasets.push({
                label: 'CAGR Trend',
                data: trendlineData,
                type: 'line',
                borderColor: '#5BA4E6',
                backgroundColor: 'rgba(91, 164, 230, 0.1)',
                borderWidth: 2,
                borderDash: [6, 4],
                pointBackgroundColor: '#5BA4E6',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6,
                fill: false,
                tension: 0.1,
                order: 0 // Draw on top
            });
        }

        // ============================================
        // SUBSCRIBERS CHART
        // ============================================
        // ============================================
        // MARKETING EFFICIENCY CHART (New Users, Spend, CPNU)
        // ============================================
        let subscribersToggles = {
            newUsers: true,
            newUsersBudget: false,
            marketingSpend: true,
            marketingSpendBudget: false,
            cpnu: true,
            cpnuBudget: false
        };

        function loadSubscribersToggles() {
            const saved = localStorage.getItem('subscribersToggles');
            if (saved) {
                subscribersToggles = JSON.parse(saved);
            }
            updateSubscribersToggleButtons();
        }

        function saveSubscribersToggles() {
            localStorage.setItem('subscribersToggles', JSON.stringify(subscribersToggles));
        }

        function updateSubscribersToggleButtons() {
            document.querySelectorAll('.sub-toggle-btn').forEach(btn => {
                const metric = btn.dataset.metric;
                if (subscribersToggles[metric]) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function getSubscribersChartData() {
            let labels = monthLabelsShort;
            let signupsActual = [];
            let signupsBudget = [];
            let spendActual = [];
            let spendBudget = [];
            let cpnuActual = [];
            let cpnuBudget = [];

            monthNames.forEach(month => {
                const mData = monthlyData?.[month] || {};
                const mBudget = monthlyBudget?.[month] || {};
                signupsActual.push((mData.signups || 0) / 1000);
                signupsBudget.push((mBudget.signups || 0) / 1000);
                spendActual.push((mData.spend || 0) / 1000);
                spendBudget.push((mBudget.spend || 0) / 1000);
                cpnuActual.push(mData.cpnu || 0);
                cpnuBudget.push(mBudget.cpnu || 0);
            });

            return {
                labels: labels,
                signupsActual: signupsActual,
                signupsBudget: signupsBudget,
                spendActual: spendActual,
                spendBudget: spendBudget,
                cpnuActual: cpnuActual,
                cpnuBudget: cpnuBudget
            };
        }

        function buildSubscribersDatasets(data) {
            const datasets = [];

            // New Users Actual - Blue (Actual = Blue)
            if (subscribersToggles.newUsers) {
                datasets.push({
                    label: 'New Users (K)',
                    data: data.signupsActual,
                    type: 'bar',
                    backgroundColor: '#3B82F6',
                    borderRadius: 4,
                    yAxisID: 'y',
                    order: 3
                });
            }

            // New Users Budget - Gray (Budget = Gray)
            if (subscribersToggles.newUsersBudget) {
                datasets.push({
                    label: 'New Users Budget (K)',
                    data: data.signupsBudget,
                    type: 'bar',
                    backgroundColor: '#9CA3AF',
                    borderRadius: 4,
                    yAxisID: 'y',
                    order: 4
                });
            }

            // Marketing Spend Actual - Amber (Cost = Amber)
            if (subscribersToggles.marketingSpend) {
                datasets.push({
                    label: 'Marketing Spend ($K)',
                    data: data.spendActual,
                    type: 'bar',
                    backgroundColor: '#F59E0B',
                    borderRadius: 4,
                    yAxisID: 'y',
                    order: 5
                });
            }

            // Marketing Spend Budget - Light Gray (Budget = Gray)
            if (subscribersToggles.marketingSpendBudget) {
                datasets.push({
                    label: 'Spend Budget ($K)',
                    data: data.spendBudget,
                    type: 'bar',
                    backgroundColor: '#D1D5DB',
                    borderRadius: 4,
                    yAxisID: 'y',
                    order: 6
                });
            }

            // CPNU Actual - Purple (Ratio/Efficiency = Purple)
            if (subscribersToggles.cpnu) {
                datasets.push({
                    label: 'CPNU ($)',
                    data: data.cpnuActual,
                    type: 'line',
                    borderColor: '#8B5CF6',
                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    pointBackgroundColor: '#8B5CF6',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    yAxisID: 'y1',
                    order: 1
                });
            }

            // CPNU Budget - Light Purple dashed (Budget = lighter)
            if (subscribersToggles.cpnuBudget) {
                datasets.push({
                    label: 'CPNU Budget ($)',
                    data: data.cpnuBudget,
                    type: 'line',
                    borderColor: '#A78BFA',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    borderDash: [6, 4],
                    fill: false,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: '#A78BFA',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 1,
                    yAxisID: 'y1',
                    order: 2
                });
            }

            return datasets;
        }

        function needsCpnuAxis() {
            return subscribersToggles.cpnu || subscribersToggles.cpnuBudget;
        }

        function createMarketingEfficiencyChart() {
            const canvasEl = document.getElementById('subscribersChart');
            if (!canvasEl) return;
            const ctx = canvasEl.getContext('2d');
            const data = getSubscribersChartData();
            const datasets = buildSubscribersDatasets(data);

            charts.marketing = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#1e3a5f',
                                font: { size: 12, weight: 600 },
                                padding: 16,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label;
                                    const value = context.parsed.y;
                                    if (label.includes('CPNU')) {
                                        return label + ': $' + value.toFixed(2);
                                    } else if (label.includes('Spend')) {
                                        return label + ': $' + value.toFixed(0) + 'K';
                                    } else {
                                        return label + ': ' + value.toFixed(0) + 'K';
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Users (K) / Spend ($K)',
                                color: '#6b7280',
                                font: { size: 11, weight: 600 }
                            },
                            grid: { color: '#e2e8f0', drawBorder: false },
                            ticks: {
                                color: '#6b7280',
                                font: { size: 11 },
                                callback: function(value) { return value + 'K'; }
                            },
                            border: { display: false }
                        },
                        y1: {
                            type: 'linear',
                            display: needsCpnuAxis(),
                            position: 'right',
                            beginAtZero: true,
                            title: {
                                display: needsCpnuAxis(),
                                text: 'CPNU ($)',
                                color: '#22c55e',
                                font: { size: 11, weight: 600 }
                            },
                            grid: { drawOnChartArea: false },
                            ticks: {
                                color: '#22c55e',
                                font: { size: 11 },
                                callback: function(value) { return '$' + value.toFixed(2); }
                            },
                            border: { display: false }
                        },
                        x: {
                            grid: { display: false, drawBorder: false },
                            ticks: { color: '#6b7280', font: { size: 11 } },
                            border: { display: false }
                        }
                    }
                }
            });

            // Add click handlers to toggle buttons
            document.querySelectorAll('.sub-toggle-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const metric = this.dataset.metric;
                    const activeCount = Object.values(subscribersToggles).filter(v => v).length;
                    if (subscribersToggles[metric] && activeCount <= 1) return;

                    subscribersToggles[metric] = !subscribersToggles[metric];
                    updateSubscribersToggleButtons();
                    updateMarketingChart();
                    saveSubscribersToggles();
                });
            });

            loadSubscribersToggles();
        }

        function updateMarketingChart() {
            const data = getSubscribersChartData();
            const datasets = buildSubscribersDatasets(data);

            charts.marketing.data.labels = data.labels;
            charts.marketing.data.datasets = datasets;
            charts.marketing.options.scales.y1.display = needsCpnuAxis();
            charts.marketing.options.scales.y1.title.display = needsCpnuAxis();
            charts.marketing.update();
        }

        function resetSubscribersToggles() {
            subscribersToggles = {
                newUsers: true,
                newUsersBudget: false,
                marketingSpend: true,
                marketingSpendBudget: false,
                cpnu: true,
                cpnuBudget: false
            };
            updateSubscribersToggleButtons();
            updateMarketingChart();
            saveSubscribersToggles();
        }

        // ============================================
        // SUBSCRIBER ACQUISITION & CONVERSION CHART
        // ============================================
        let subscriberAcqToggles = {
            actualSubs: true,
            budgetSubs: false,
            conversionRate: true,
            conversionRateBudget: false
        };

        function loadSubscriberAcqToggles() {
            const saved = localStorage.getItem('subscriberAcqToggles');
            if (saved) {
                subscriberAcqToggles = JSON.parse(saved);
            }
            updateSubscriberAcqToggleButtons();
        }

        function saveSubscriberAcqToggles() {
            localStorage.setItem('subscriberAcqToggles', JSON.stringify(subscriberAcqToggles));
        }

        function updateSubscriberAcqToggleButtons() {
            document.querySelectorAll('.sacq-toggle-btn').forEach(btn => {
                const metric = btn.dataset.metric;
                if (subscriberAcqToggles[metric]) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function getSubscriberAcquisitionData() {
            let labels = monthLabelsShort;
            let actualSubs = [];
            let budgetSubs = [];
            let conversionActual = [];
            let conversionBudget = [];

            monthNames.forEach(month => {
                const mData = monthlyData?.[month] || {};
                const mBudget = monthlyBudget?.[month] || {};
                actualSubs.push(mData.subs || 0);
                budgetSubs.push(mBudget.subs || 0);
                conversionActual.push(mData.conversion || 0);
                conversionBudget.push(mBudget.conversion || 0);
            });

            return {
                labels: labels,
                actualSubs: actualSubs,
                budgetSubs: budgetSubs,
                conversionActual: conversionActual,
                conversionBudget: conversionBudget
            };
        }

        function buildSubscriberAcqDatasets(data) {
            const datasets = [];

            // Actual Subscribers - Blue (Actual = Blue)
            if (subscriberAcqToggles.actualSubs) {
                datasets.push({
                    label: 'Actual Subscribers',
                    data: data.actualSubs,
                    type: 'bar',
                    backgroundColor: '#1E40AF',
                    borderRadius: 4,
                    yAxisID: 'y',
                    order: 2
                });
            }

            // Budget Subscribers - Gray (Budget = Gray)
            if (subscriberAcqToggles.budgetSubs) {
                datasets.push({
                    label: 'Budget Subscribers',
                    data: data.budgetSubs,
                    type: 'bar',
                    backgroundColor: '#9CA3AF',
                    borderRadius: 4,
                    yAxisID: 'y',
                    order: 3
                });
            }

            // Conversion Rate Actual - Green (Positive metric = Green)
            if (subscriberAcqToggles.conversionRate) {
                datasets.push({
                    label: 'Conversion Rate',
                    data: data.conversionActual,
                    type: 'line',
                    borderColor: '#10B981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    pointBackgroundColor: '#10B981',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    yAxisID: 'y1',
                    order: 1
                });
            }

            // Conversion Rate Budget - Light Green dashed
            if (subscriberAcqToggles.conversionRateBudget) {
                datasets.push({
                    label: 'Conv. Rate Budget',
                    data: data.conversionBudget,
                    type: 'line',
                    borderColor: '#34D399',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    borderDash: [6, 4],
                    fill: false,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: '#34D399',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 1,
                    yAxisID: 'y1',
                    order: 0
                });
            }

            return datasets;
        }

        function needsConversionAxis() {
            return subscriberAcqToggles.conversionRate || subscriberAcqToggles.conversionRateBudget;
        }

        function createSubscriberAcquisitionChart() {
            const canvasEl = document.getElementById('subscriberAcquisitionChart');
            if (!canvasEl) return;
            const ctx = canvasEl.getContext('2d');
            const data = getSubscriberAcquisitionData();
            const datasets = buildSubscriberAcqDatasets(data);

            charts.subscriberAcquisition = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#1e3a5f',
                                font: { size: 12, weight: 600 },
                                padding: 16,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label;
                                    const value = context.parsed.y;
                                    if (label.includes('Conversion') || label.includes('Conv.')) {
                                        return label + ': ' + value.toFixed(2) + '%';
                                    } else {
                                        return label + ': ' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Subscribers',
                                color: '#6b7280',
                                font: { size: 11, weight: 600 }
                            },
                            grid: { color: '#e2e8f0', drawBorder: false },
                            ticks: {
                                color: '#6b7280',
                                font: { size: 11 },
                                callback: function(value) { return value.toLocaleString(); }
                            },
                            border: { display: false },
                            max: 12000
                        },
                        y1: {
                            type: 'linear',
                            display: needsConversionAxis(),
                            position: 'right',
                            beginAtZero: true,
                            title: {
                                display: needsConversionAxis(),
                                text: 'Conversion Rate (%)',
                                color: '#22c55e',
                                font: { size: 11, weight: 600 }
                            },
                            grid: { drawOnChartArea: false },
                            ticks: {
                                color: '#22c55e',
                                font: { size: 11 },
                                callback: function(value) { return value.toFixed(0) + '%'; }
                            },
                            border: { display: false },
                            max: 10
                        },
                        x: {
                            grid: { display: false, drawBorder: false },
                            ticks: { color: '#6b7280', font: { size: 11 } },
                            border: { display: false }
                        }
                    }
                }
            });

            // Add click handlers to toggle buttons
            document.querySelectorAll('.sacq-toggle-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const metric = this.dataset.metric;
                    const activeCount = Object.values(subscriberAcqToggles).filter(v => v).length;
                    if (subscriberAcqToggles[metric] && activeCount <= 1) return;

                    subscriberAcqToggles[metric] = !subscriberAcqToggles[metric];
                    updateSubscriberAcqToggleButtons();
                    updateSubscriberAcquisitionChart();
                    saveSubscriberAcqToggles();
                });
            });

            loadSubscriberAcqToggles();
        }

        function updateSubscriberAcquisitionChart() {
            const data = getSubscriberAcquisitionData();
            const datasets = buildSubscriberAcqDatasets(data);

            charts.subscriberAcquisition.data.labels = data.labels;
            charts.subscriberAcquisition.data.datasets = datasets;
            charts.subscriberAcquisition.options.scales.y1.display = needsConversionAxis();
            charts.subscriberAcquisition.options.scales.y1.title.display = needsConversionAxis();
            charts.subscriberAcquisition.update();
        }

        function resetSubscriberAcqToggles() {
            subscriberAcqToggles = {
                actualSubs: true,
                budgetSubs: false,
                conversionRate: true,
                conversionRateBudget: false
            };
            updateSubscriberAcqToggleButtons();
            updateSubscriberAcquisitionChart();
            saveSubscriberAcqToggles();
        }

        // ============================================
        // UNIT ECONOMICS CHART (ARPU, CAC, Contribution Margin)
        // ============================================
        let unitEconomicsToggles = {
            actualArpu: true,
            budgetArpu: false,
            actualCac: true,
            budgetCac: false,
            arpuCacRatio: false,
            contributionMargin: false
        };

        function loadUnitEconomicsToggles() {
            const saved = localStorage.getItem('unitEconomicsToggles');
            if (saved) {
                unitEconomicsToggles = JSON.parse(saved);
            }
            updateUnitEconomicsToggleButtons();
        }

        function saveUnitEconomicsToggles() {
            localStorage.setItem('unitEconomicsToggles', JSON.stringify(unitEconomicsToggles));
        }

        function updateUnitEconomicsToggleButtons() {
            document.querySelectorAll('.ue-toggle-btn').forEach(btn => {
                const metric = btn.dataset.metric;
                if (unitEconomicsToggles[metric]) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // Get Unit Economics data - ARPU from Row 21, CAC from Row 11, Contribution Margin = ARPU - CAC
        function getUnitEconomicsData() {
            let labels = monthLabelsShort;
            let actualArpu = [];
            let budgetArpu = [];
            let actualCac = [];
            let budgetCac = [];

            monthNames.forEach(month => {
                const mData = monthlyData?.[month] || {};
                const mBudget = monthlyBudget?.[month] || {};
                actualArpu.push(mData.arpu || 0);
                budgetArpu.push(mBudget.arpu || 0);
                actualCac.push(mData.cac || 0);
                budgetCac.push(mBudget.cac || 0);
            });

            // Calculate ARPU/CAC Ratio
            const ratioData = actualArpu.map((arpu, i) => {
                const cac = actualCac[i];
                return cac > 0 ? (arpu / cac) : 0;
            });

            // Calculate Contribution Margin as ARPU - CAC (in dollars)
            const cmActual = actualArpu.map((arpu, i) => arpu - actualCac[i]);
            const cmBudget = budgetArpu.map((arpu, i) => arpu - budgetCac[i]);

            return {
                labels: labels,
                actualArpu: actualArpu,
                budgetArpu: budgetArpu,
                actualCac: actualCac,
                budgetCac: budgetCac,
                arpuCacRatio: ratioData,
                contributionMargin: cmActual,
                contributionMarginBudget: cmBudget
            };
        }

        function buildUnitEconomicsDatasets(data) {
            const datasets = [];

            // ARPU Actual - Green (positive metric)
            if (unitEconomicsToggles.actualArpu) {
                datasets.push({
                    label: 'Actual ARPU',
                    data: data.actualArpu,
                    borderColor: '#10B981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    pointBackgroundColor: '#10B981',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    yAxisID: 'y'
                });
            }

            // ARPU Budget - Gray (budget = gray)
            if (unitEconomicsToggles.budgetArpu) {
                datasets.push({
                    label: 'Budget ARPU',
                    data: data.budgetArpu,
                    borderColor: '#9CA3AF',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    borderDash: [6, 4],
                    fill: false,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: '#9CA3AF',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 1,
                    yAxisID: 'y'
                });
            }

            // CAC Actual - Amber (cost metric)
            if (unitEconomicsToggles.actualCac) {
                datasets.push({
                    label: 'Actual CAC',
                    data: data.actualCac,
                    borderColor: '#F59E0B',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    pointBackgroundColor: '#F59E0B',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    yAxisID: 'y'
                });
            }

            // CAC Budget - Gray (budget = gray)
            if (unitEconomicsToggles.budgetCac) {
                datasets.push({
                    label: 'Budget CAC',
                    data: data.budgetCac,
                    borderColor: '#6B7280',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    borderDash: [6, 4],
                    fill: false,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: '#6B7280',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 1,
                    yAxisID: 'y'
                });
            }

            // ARPU/CAC Ratio - Purple (ratio/efficiency)
            if (unitEconomicsToggles.arpuCacRatio) {
                datasets.push({
                    label: 'ARPU/CAC Ratio',
                    data: data.arpuCacRatio,
                    borderColor: '#8B5CF6',
                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    pointBackgroundColor: '#8B5CF6',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    yAxisID: 'y1'
                });
            }

            // Contribution Margin - Purple (efficiency metric)
            if (unitEconomicsToggles.contributionMargin) {
                datasets.push({
                    label: 'Cont. Margin ($)',
                    data: data.contributionMargin,
                    type: 'bar',
                    backgroundColor: function(context) {
                        const value = context.raw;
                        return value >= 0 ? '#A78BFA' : '#C4B5FD';
                    },
                    borderRadius: 4,
                    yAxisID: 'y',
                    order: 10
                });
            }

            return datasets;
        }

        function needsRightAxis() {
            return unitEconomicsToggles.arpuCacRatio;
        }

        function createUnitEconomicsChart() {
            const canvasEl = document.getElementById('unitEconomicsChart');
            if (!canvasEl) return;
            const ctx = canvasEl.getContext('2d');
            const data = getUnitEconomicsData();
            const datasets = buildUnitEconomicsDatasets(data);

            charts.unitEconomics = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#1e3a5f',
                                font: { size: 12, weight: 600 },
                                padding: 16,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label;
                                    const value = context.parsed.y;
                                    if (label.includes('Ratio')) {
                                        return label + ': ' + value.toFixed(2) + 'x';
                                    } else {
                                        return label + ': $' + value.toFixed(2);
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Dollars ($)',
                                color: '#6b7280',
                                font: { size: 11, weight: 600 }
                            },
                            grid: { color: '#e2e8f0', drawBorder: false },
                            ticks: {
                                color: '#6b7280',
                                font: { size: 11 },
                                callback: function(value) { return '$' + value.toFixed(0); }
                            },
                            border: { display: false }
                        },
                        y1: {
                            type: 'linear',
                            display: needsRightAxis(),
                            position: 'right',
                            beginAtZero: true,
                            title: {
                                display: needsRightAxis(),
                                text: 'Ratio',
                                color: '#22c55e',
                                font: { size: 11, weight: 600 }
                            },
                            grid: { drawOnChartArea: false },
                            ticks: {
                                color: '#22c55e',
                                font: { size: 11 },
                                callback: function(value) { return value.toFixed(1) + 'x'; }
                            },
                            border: { display: false }
                        },
                        x: {
                            grid: { display: false, drawBorder: false },
                            ticks: { color: '#6b7280', font: { size: 11 } },
                            border: { display: false }
                        }
                    }
                }
            });

            // Add click handlers to toggle buttons
            document.querySelectorAll('.ue-toggle-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const metric = this.dataset.metric;
                    const activeCount = Object.values(unitEconomicsToggles).filter(v => v).length;
                    if (unitEconomicsToggles[metric] && activeCount <= 1) return;

                    unitEconomicsToggles[metric] = !unitEconomicsToggles[metric];
                    updateUnitEconomicsToggleButtons();
                    updateUnitEconomicsChart();
                    saveUnitEconomicsToggles();
                });
            });

            loadUnitEconomicsToggles();
        }

        function updateUnitEconomicsChart() {
            const data = getUnitEconomicsData();
            const datasets = buildUnitEconomicsDatasets(data);

            charts.unitEconomics.data.labels = data.labels;
            charts.unitEconomics.data.datasets = datasets;
            charts.unitEconomics.options.scales.y1.display = needsRightAxis();
            charts.unitEconomics.options.scales.y1.title.display = needsRightAxis();
            charts.unitEconomics.update();
        }

        function resetUnitEconomicsToggles() {
            unitEconomicsToggles = {
                actualArpu: true,
                budgetArpu: false,
                actualCac: true,
                budgetCac: false,
                arpuCacRatio: false,
                contributionMargin: false
            };
            updateUnitEconomicsToggleButtons();
            updateUnitEconomicsChart();
            saveUnitEconomicsToggles();
        }

        // ============================================
        // OPEX TABLE
        // ============================================
        function createOpexTable() {
            const tbody = document.getElementById('opexTableBody');
            if (!tbody) return;
            if (!opexData || opexData.length === 0) return;

            let totalBudget = 0;
            let totalActual = 0;

            let rows = opexData.map(item => {
                totalBudget += item.budget;
                totalActual += item.actual;

                const varianceDollar = item.actual - item.budget;
                const variancePercent = ((varianceDollar / item.budget) * 100).toFixed(1);
                const isUnder = varianceDollar <= 0;

                return `
                    <tr>
                        <td><strong>${item.category}</strong></td>
                        <td>$${(item.budget / 1000).toFixed(0)}K</td>
                        <td>$${(item.actual / 1000).toFixed(0)}K</td>
                        <td class="${isUnder ? 'variance-positive' : 'variance-negative'}">
                            ${varianceDollar >= 0 ? '+' : ''}$${(varianceDollar / 1000).toFixed(0)}K
                        </td>
                        <td class="${isUnder ? 'variance-positive' : 'variance-negative'}">
                            ${varianceDollar >= 0 ? '+' : ''}${variancePercent}%
                        </td>
                        <td>
                            <span class="status-icon ${isUnder ? 'under-budget' : 'over-budget'}">
                                ${isUnder ? '✓' : '✗'}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');

            const totalVarianceDollar = totalActual - totalBudget;
            const totalVariancePercent = ((totalVarianceDollar / totalBudget) * 100).toFixed(1);
            const totalIsUnder = totalVarianceDollar <= 0;

            rows += `
                <tr class="total-row">
                    <td><strong>TOTAL</strong></td>
                    <td><strong>$${(totalBudget / 1000).toFixed(0)}K</strong></td>
                    <td><strong>$${(totalActual / 1000).toFixed(0)}K</strong></td>
                    <td class="${totalIsUnder ? 'variance-positive' : 'variance-negative'}">
                        <strong>${totalVarianceDollar >= 0 ? '+' : ''}$${(totalVarianceDollar / 1000).toFixed(0)}K</strong>
                    </td>
                    <td class="${totalIsUnder ? 'variance-positive' : 'variance-negative'}">
                        <strong>${totalVarianceDollar >= 0 ? '+' : ''}${totalVariancePercent}%</strong>
                    </td>
                    <td>
                        <span class="status-icon ${totalIsUnder ? 'under-budget' : 'over-budget'}">
                            ${totalIsUnder ? '✓' : '✗'}
                        </span>
                    </td>
                </tr>
            `;

            tbody.innerHTML = rows;
        }

        // ============================================
        // OPEX DONUT CHART
        // ============================================
        function getOpexPeriodText() {
            // Handle custom range first
            if (customRangeActive) {
                const fromMonth = monthNames[customRangeFrom];
                const toMonth = monthNames[customRangeTo];
                const fromShort = monthLabelsShort[customRangeFrom];
                const toShort = monthLabelsShort[customRangeTo];
                if (customRangeFrom === customRangeTo) {
                    return `${fromMonth} 2025`;
                }
                return `${fromShort}-${toShort} 2025`;
            }

            switch(currentGranularity) {
                case 'monthly':
                    return currentPeriod + ' 2025';
                case 'quarterly':
                    const qMonths = {
                        'Q1': 'Jan-Mar',
                        'Q2': 'Apr-Jun',
                        'Q3': 'Jul-Sep',
                        'Q4': 'Oct-Dec'
                    };
                    return `${currentPeriod} 2025 (${qMonths[currentPeriod]})`;
                case 'semester':
                    return currentPeriod === 'H1' ? 'H1 2025 (Jan-Jun)' : 'H2 2025 (Jul-Dec)';
                case 'yearly':
                default:
                    return 'Full Year 2025 (Jan-Dec)';
            }
        }

        function getOpexChartTitle() {
            return `Expense Distribution - ${getOpexPeriodText()}`;
        }

        function getOpexSectionTitle() {
            return `Operating Expenses - ${getOpexPeriodText()}`;
        }

        function getOpexDataForPeriod() {
            // Calculate the scaling factor based on the current period
            let scaleFactor = 1;
            let monthsIncluded = [];

            // Handle custom range first
            if (customRangeActive) {
                const numMonths = customRangeTo - customRangeFrom + 1;
                scaleFactor = numMonths / 12;
                monthsIncluded = getCustomRangeMonths();
            } else {
                switch(currentGranularity) {
                    case 'monthly':
                        scaleFactor = 1 / 12;
                        monthsIncluded = [currentPeriod];
                        break;
                    case 'quarterly':
                        scaleFactor = 3 / 12;
                        monthsIncluded = quarterMonths[currentPeriod] || [];
                        break;
                    case 'semester':
                        scaleFactor = 6 / 12;
                        if (currentPeriod === 'H1') {
                            monthsIncluded = ['January', 'February', 'March', 'April', 'May', 'June'];
                        } else {
                            monthsIncluded = ['July', 'August', 'September', 'October', 'November', 'December'];
                        }
                        break;
                    case 'yearly':
                    default:
                        scaleFactor = 1;
                        monthsIncluded = monthNames;
                        break;
                }
            }

            // Scale the annual OpEx data to the selected period
            return opexData.map(item => ({
                category: item.category,
                actual: Math.round(item.actual * scaleFactor),
                budget: Math.round(item.budget * scaleFactor)
            }));
        }

        function createOpexDonutChart() {
            const canvasEl = document.getElementById('opexDonutChart');
            if (!canvasEl) return;
            const ctx = canvasEl.getContext('2d');
            const periodData = getOpexDataForPeriod();
            if (!periodData || periodData.length === 0) return;

            const colors = ['#1e3a5f', '#22c55e', '#ef4444', '#f59e0b', '#6b7280'];

            // Update chart title
            document.getElementById('opexDonutChartTitle').textContent = getOpexChartTitle();

            charts.opexDonut = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: periodData.map(item => item.category),
                    datasets: [{
                        data: periodData.map(item => item.actual),
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#1e3a5f',
                                font: {
                                    size: 11
                                },
                                padding: 12,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return context.label + ': $' + (value / 1000).toFixed(0) + 'K (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateOpexDonutChart() {
            if (!charts.opexDonut) return;

            const periodData = getOpexDataForPeriod();

            // Update chart title and section title
            document.getElementById('opexDonutChartTitle').textContent = getOpexChartTitle();
            document.getElementById('opexSectionTitle').textContent = getOpexSectionTitle();

            charts.opexDonut.data.datasets[0].data = periodData.map(item => item.actual);
            charts.opexDonut.update();
        }

        function updateOpexTable() {
            const periodData = getOpexDataForPeriod();
            const tbody = document.getElementById('opexTableBody');
            if (!tbody) return;

            let totalBudget = 0;
            let totalActual = 0;

            const rows = periodData.map(item => {
                const varianceDollar = item.actual - item.budget;
                const variancePercent = ((varianceDollar / item.budget) * 100).toFixed(1);
                const isUnder = varianceDollar <= 0;

                totalBudget += item.budget;
                totalActual += item.actual;

                return `
                    <tr>
                        <td>${item.category}</td>
                        <td>$${(item.budget / 1000).toFixed(0)}K</td>
                        <td>$${(item.actual / 1000).toFixed(0)}K</td>
                        <td class="${isUnder ? 'variance-positive' : 'variance-negative'}">
                            ${varianceDollar >= 0 ? '+' : ''}$${(varianceDollar / 1000).toFixed(0)}K
                        </td>
                        <td class="${isUnder ? 'variance-positive' : 'variance-negative'}">
                            ${varianceDollar >= 0 ? '+' : ''}${variancePercent}%
                        </td>
                        <td>
                            <span class="status-icon ${isUnder ? 'under-budget' : 'over-budget'}">
                                ${isUnder ? '✓' : '✗'}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');

            const totalVarianceDollar = totalActual - totalBudget;
            const totalVariancePercent = ((totalVarianceDollar / totalBudget) * 100).toFixed(1);
            const totalIsUnder = totalVarianceDollar <= 0;

            const totalRow = `
                <tr class="total-row">
                    <td><strong>TOTAL</strong></td>
                    <td><strong>$${(totalBudget / 1000).toFixed(0)}K</strong></td>
                    <td><strong>$${(totalActual / 1000).toFixed(0)}K</strong></td>
                    <td class="${totalIsUnder ? 'variance-positive' : 'variance-negative'}">
                        <strong>${totalVarianceDollar >= 0 ? '+' : ''}$${(totalVarianceDollar / 1000).toFixed(0)}K</strong>
                    </td>
                    <td class="${totalIsUnder ? 'variance-positive' : 'variance-negative'}">
                        <strong>${totalVarianceDollar >= 0 ? '+' : ''}${totalVariancePercent}%</strong>
                    </td>
                    <td>
                        <span class="status-icon ${totalIsUnder ? 'under-budget' : 'over-budget'}">
                            ${totalIsUnder ? '✓' : '✗'}
                        </span>
                    </td>
                </tr>
            `;

            tbody.innerHTML = rows + totalRow;
        }

        // ============================================
        // CHART TOGGLE SYSTEM
        // ============================================
        const chartToggleConfig = {
            contributionMargin: {
                datasets: [
                    { label: 'Actual', color: '#1e3a5f' },
                    { label: 'Budget', color: '#94a3b8' }
                ]
            },
            revenue: {
                datasets: [
                    { label: 'Actual Revenue', color: '#1e3a5f' },
                    { label: 'Budget Revenue', color: '#94a3b8' }
                ]
            },
            ebitda: {
                datasets: [
                    { label: 'Actual EBITDA', color: '#22c55e' },
                    { label: 'Budget EBITDA', color: '#94a3b8' }
                ]
            }
        };

        // Store original dataset visibility
        const originalDatasetVisibility = {};

        function getToggleStorageKey(chartName) {
            return `kinedu_chart_toggles_${chartName}`;
        }

        function loadTogglePreferences(chartName) {
            try {
                const stored = localStorage.getItem(getToggleStorageKey(chartName));
                if (stored) {
                    return JSON.parse(stored);
                }
            } catch (e) {
                console.warn('Could not load toggle preferences:', e);
            }
            return null;
        }

        function saveTogglePreferences(chartName, visibility) {
            try {
                localStorage.setItem(getToggleStorageKey(chartName), JSON.stringify(visibility));
            } catch (e) {
                console.warn('Could not save toggle preferences:', e);
            }
        }

        function createChartToggles(chartName) {
            const container = document.getElementById(`toggles-${chartName}`);
            if (!container) return;

            const config = chartToggleConfig[chartName];
            if (!config) return;

            const chart = charts[chartName];
            if (!chart) return;

            // Store original visibility
            originalDatasetVisibility[chartName] = chart.data.datasets.map(() => true);

            // Load saved preferences
            const savedPrefs = loadTogglePreferences(chartName);

            let html = '';
            config.datasets.forEach((dataset, index) => {
                const isVisible = savedPrefs ? savedPrefs[index] : true;
                html += `
                    <label class="chart-toggle-label ${isVisible ? 'active' : ''}" data-chart="${chartName}" data-index="${index}">
                        <input type="checkbox" ${isVisible ? 'checked' : ''} onchange="toggleDataset('${chartName}', ${index}, this.checked)">
                        <span class="chart-toggle-color" style="background-color: ${dataset.color}"></span>
                        ${dataset.label}
                    </label>
                `;

                // Apply saved visibility
                if (!isVisible) {
                    chart.setDatasetVisibility(index, false);
                }
            });

            html += `<button class="chart-toggle-reset" onclick="resetChartToggles('${chartName}')">Reset</button>`;
            container.innerHTML = html;

            // Update chart after applying saved preferences
            chart.update();
        }

        function toggleDataset(chartName, datasetIndex, isVisible) {
            const chart = charts[chartName];
            if (!chart) return;

            chart.setDatasetVisibility(datasetIndex, isVisible);
            chart.update();

            // Update toggle label styling
            const label = document.querySelector(`.chart-toggle-label[data-chart="${chartName}"][data-index="${datasetIndex}"]`);
            if (label) {
                label.classList.toggle('active', isVisible);
            }

            // Save preferences
            const visibility = chart.data.datasets.map((_, i) => chart.isDatasetVisible(i));
            saveTogglePreferences(chartName, visibility);
        }

        function resetChartToggles(chartName) {
            const chart = charts[chartName];
            if (!chart) return;

            // Reset all datasets to visible
            chart.data.datasets.forEach((_, index) => {
                chart.setDatasetVisibility(index, true);
            });
            chart.update();

            // Update toggle labels
            const labels = document.querySelectorAll(`.chart-toggle-label[data-chart="${chartName}"]`);
            labels.forEach(label => {
                label.classList.add('active');
                const checkbox = label.querySelector('input[type="checkbox"]');
                if (checkbox) checkbox.checked = true;
            });

            // Clear saved preferences
            localStorage.removeItem(getToggleStorageKey(chartName));
        }

        function initializeAllChartToggles() {
            Object.keys(chartToggleConfig).forEach(chartName => {
                createChartToggles(chartName);
            });
        }

        // Initialize toggles after charts are created
        const originalOnload = window.onload;
        window.onload = function() {
            originalOnload();
            initializeAllChartToggles();
        };
    </script>
</body>
</html>
